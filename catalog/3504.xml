<?xml version="1.0" encoding="UTF-8"?>
<xml><thread id="3504"><title>Custom GUI/HUD data from scripts</title><posts><post id="p32593" date="Posted: Wed Aug 11, 2004 4:11 am "><author>goliathvt</author><body><![CDATA[<div class="postbody">Okay, here's the situation:  I wanted to be able to create a HUD using custom data.  Right now, all that is listed in the hud.gui are gui parms that relate to the player: gui::player_health, gui::player_ammo, etc.  
<br /><br />So, what happens if you want to display some dynamic data, say some information that you get from a level script, on your HUD? 
<br /><br /><span style="font-style: italic">Note that before you attempt any changes to your hud.gui... I've created a custom HUD in a mod directory... that is, I'm using +set fs_game MOD so that I don't make any changes to my vanilla game's HUD.  If you want to muck around with changing your HUD, I highly recommend using +set fs_game too, so you don't mistakenly foobar your Doom3 HUD.  You have been warned.</span>
<br /><br />Okay, with that out of the way, let me describe my setup:
<br /><br />I had created a level script that counted the number of times a moveable entity hit the ground.  I tracked this number using the technique written about here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20121104025750/http://www.doom3world.org/phpbb2/viewtopic.php?p=31028">http://www.doom3world.org/phpbb2/viewtopic.php?p=31028</a><!-- m -->
<br /><br />In that post, I basically just describe how to detect when a moveable object hits a trigger, and when the trigger activates, it calls a level script function.  
<br /><br />So in this particular case, the script just counts the number of times a moveable ball object hits the floor.  I then store that information into my ball entity as a key/value that I can easily retrieve at a later time.
<br /><br />Using that information, I then wanted to plug the number of times my ball object contacts the floor into my HUD and have it update dynamically.  To do this, I had to make a few changes to my map:
<br /><br />1.  I renamed the info_player_start entity so I could easily reference it in a script...
<br /><br />2.  I added a key/value pair to my player entity: 
<br />Key: hitcount
<br />Value: 0
<br /><br />3.  <span style="font-weight: bold">I explicitely defined the GUI in the info_player_start entity...</span>
<br /><br />EDIT: As in:
<br /><br />Key: gui
<br />Value: guis/hud.gui
<br /><br />on the info_player_start entity.
<br />/EDIT
<br /><br />This step is what allows you to reference gui parms with your player... without it, any key/value pairs you try to update via scripts won't change on the HUD.  I imagine there's a more elegant way to get around this issue, but I haven't found it yet.  On the other hand, if you were doing this for any other GUI, this step would be required... after all, without it, Doom3 doesn't know what GUI to apply to your object....
<br /><br />With those changes, let's move on to the scripts:
<br /><br />Here's a cut-down version of my level script (leaving out parts that don't pertain to this topic (and note that this script is far from polished!)).  Also note that the myfloorhits() function is only about 5 lines of actual code... I've just added comments so you can tell what each statement does:
<br /><br /><span style="font-weight: bold">tt1.script:</span>
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// collision detection and script-to-HUD level script test<br /><br />void setup_objects() {<br /><br />   // empty<br />}<br /><br />void myfloorhit() {<br /><br />   // init hit counter var<br />   float hc = 0; // script hit counter<br /><br />   // The number of hits gets stored into the ball entity <br />   // each time the function is called...<br />   // So we start by copying the value of our ballhits entity key <br />   // into the hit counter variable so that we can add to<br />   // the previous value<br />   hc = $myspball.getIntKey("ballhits");<br />   <br />   // since this function only gets called when the ball hits<br />   // the target area, we can increase the value of hits now<br />   hc++;<br /><br />   // SET GUI PARM<br />   // This is the meat of our script-to-GUI interaction... <br />   // all we're doing is setting the a GUI parameter to <br />   // the current hit count value.  <br />   //<br />   // Since we want to update the player's hud, we've renamed the <br />   // info_player_start entity to:<br />   //<br />   // "spplayer" <br />   //<br />   // and added a key called:<br />   //<br />   // "hitcount" <br />   //<br />   // with an initial value of 0.<br />   //<br />   // That allows the use of the setGuiParm() function with <br />   // our player's HUD...<br />   //<br />   // Basically, just store the value of the "hc" script <br />   // variable into the GUI parm "hitcount"<br />   $spplayer.setGuiParm( "hitcount", hc );<br /><br />   // now store the hit count value back into the ball entity<br />   // using our "ballhits" key so that it will be available the <br />   // next time the function gets called...<br />   $myspball.setKey("ballhits", hc);<br /><br />// END   <br />}<br /><br />void initfloorhits() {<br /><br />   // initialize the GUI parm<br />   $spplayer.setGuiParm( "hitcount", 0 );<br />}<br /><br />void main() {<br /><br />   initfloorhits();<br /><br />}<br /></div><br /><br />And here's the GUI:<br /><br /><span style="font-weight: bold">hud.gui</span>  (make sure you don't overwrite your vanilla game's HUD)<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// A custom player hud<br /><br />windowDef Desktop {<br /><br />   rect   0 ,0 ,640 ,480 <br />   backcolor   0 ,0 ,0 ,0 <br />   visible   1<br />   nocursor   1<br /><br />   onEvent {<br />      // on any event, update the HUD hit count text string <br />      // with the gui parm "hitcount"<br />      // <br />      // "hitcount" is passed via a level script using<br />      // the setParm() function.<br />      //<br />      // Note: To access a GUI parm, you use:<br />      // "gui::xxxxx", where xxxxx is the <br />      // entity key passed by the setParm<br />      // script function...<br />      set "hitcountText::text" "gui::hitcount"<br />   }<br /><br />   // "Floor Hits:" text<br />   windowDef HitsText {<br />      rect   3,377,131,36<br />      visible   1<br />      nocursor   1<br />      forecolor   1,1,0,1<br />      text   "Floor Hits:"<br />      textscale   0.5<br />      nowrap   1<br />      noevents   1<br />   }<br /><br />   // Dynamic script data:<br />   windowDef hitCountText {<br />      rect   137,376,65,38<br />      visible   1<br />      nocursor   1<br />      forecolor 1,1,0,1<br />      text "blah blah" // this will be overwritten by the level script<br />      textscale   0.5<br />      nowrap   1<br />      noevents   1<br />      <br />   }<br /><br />   // Version info text<br />   windowDef versionInfo {<br />      rect   3,445,159,31<br />      visible   1<br />      noevents   1<br />      nocursor   1<br />      forecolor   1,1,1,1<br />      text   "Balloon Bop/ Smash Ball\nv0.1"<br />      textscale   0.2<br />      backcolor   0,0.25098041,0.50196081,0.71764708<br />      bordersize   1<br />      bordercolor   1,1,0,1<br />   }<br />}<br /></div>
<br /><br />So that's one way to get level script variable data into a custom HUD.  This will, of course, also work for any GUI by simply changing the entity named for the setParm() function and updating the gui key's value for your GUI entity with whatever gui script file and custom data you choose.
<br /><br />HUD - 0 Hits
<br /><img src="https://web.archive.org/web/20121104025750im_/http://dev.rosebrough.com/d3/hudtest/hud0.jpg" alt="Image" /><br /><br />HUD - 3 Hits
<br /><img src="https://web.archive.org/web/20121104025750im_/http://dev.rosebrough.com/d3/hudtest/hud3.jpg" alt="Image" /><br /><br />Hope this helps some folks.
<br /><br />Goliath</div>]]></body></post><post id="p32616" date="Posted: Wed Aug 11, 2004 4:53 am "><author>bullet</author><body><![CDATA[<div class="postbody">Excellent! This is getting bookmarked. Definitely something that will come in handy later  <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /></div>]]></body></post><post id="p32681" date="Posted: Wed Aug 11, 2004 6:30 am "><author>BNA!</author><body><![CDATA[<div class="postbody">Great!</div>]]></body></post><post id="p32836" date="Posted: Wed Aug 11, 2004 12:11 pm "><author>CraiZE</author><body><![CDATA[<div class="postbody">Absolutely awesome!</div>]]></body></post><post id="p32842" date="Posted: Wed Aug 11, 2004 12:34 pm "><author>Eggy</author><body><![CDATA[<div class="postbody">wp goli long live minigames eh? :p</div>]]></body></post><post id="p32896" date="Posted: Wed Aug 11, 2004 1:42 pm "><author>goliathvt</author><body><![CDATA[<div class="postbody">Mini games?  Actually this is an essential part of my mod.
<br /><br /><img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />G</div>]]></body></post><post id="p33733" date="Posted: Thu Aug 12, 2004 12:03 pm "><author>zeh</author><body><![CDATA[<div class="postbody">Awesome, I can't wait to start playing with this and your post will be a great help. Thanks.</div>]]></body></post><post id="p74493" date="Posted: Thu Jan 27, 2005 1:26 pm "><author>Dingo_aus</author><body><![CDATA[<div class="postbody">This tutorial has really helped me out, thank you</div>]]></body></post><post id="p88322" date="Posted: Thu Apr 14, 2005 8:11 pm "><author>james102</author><body><![CDATA[<div class="postbody">*bing* resurrection of old thread alert...
<br /><br />I've been trying to get this working, but instead of a custom hud, I'm trying to do it with a custom PDA.
<br /><br />I've checked and double checked, and while the hud variant seems to work, using the player_start, I can't get it going with a pda. Here's the setup:
<br /><br />There is an info_pda waiting to be picked up infront of the player, called "pda". It has been given the key/value of "gui" "gui/pda.gui". Picks up fine, it shows the custom pda, but the single bit of text that should be generated by the map script is not appearing, it's blank.
<br /><br />here's the relevent bit of pda.gui
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">onEvent{<br />      set "btnTheme1::text" "gui::foo"<br />   }<br /><br />   windowDef pageThemes<br />   {<br />      rect   8,85,620,370<br />      visible   0<br />      bordersize   2<br />      bordercolor   0,0.25098041,0.50196081,1<br />      windowDef btnTheme1<br />      {<br />         rect   7,8,139,20<br />         visible   1<br />         backcolor   0,0.50196081,1,0.80000007<br />         text   "overwrite me"<br />         textscale   0.2<br />         forecolor   1,1,1,1<br />         bordersize   2<br />         bordercolor   0,0.25098041,0.50196081,1<br />         nowrap   1<br />      }<br />etc...etc...<br /></div><br /><br />and the snippet from the map script<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void initPda(){<br />   $pda.setGuiParm("foo", "bar");<br />}<br /><br />void main()<br />{<br />   initPda();<br />}<br /></div>
<br /><br />If anyone has any ideas, please share, because I am completely stumped.</div>]]></body></post><post id="p88342" date="Posted: Thu Apr 14, 2005 9:20 pm "><author>Grimm</author><body><![CDATA[<div class="postbody">Good stuuf, this shuould get stickied</div>]]></body></post><post id="p88347" date="Posted: Thu Apr 14, 2005 9:32 pm "><author>james102</author><body><![CDATA[<div class="postbody">ok I'm confused as hell now.
<br />I go away to grab some coffee and clear my head (had been working for about 12 hours solid), and think "hmm, maybe the onEvent isn't happening, let's see what happens when you put set "btnTheme1::text" "gui::foo" in the onAction section of the btnTheme1 windowDef...
<br /><br />and it works...before clicking on it... I remove the line from onAction, and it still works. My brain is so very broken right now. But either way, kudos to goliath for coming up with this in the first place. <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />edit: just figured it out. I closed the editor, thus closed D3, and when I started again, I reloaded everything. I guess guis get loaded on game-launch, rather than on map-load.</div>]]></body></post><post id="p97843" date="Posted: Fri Jun 03, 2005 4:28 am "><author>Cody64</author><body><![CDATA[<div class="postbody">I cannot make this work with weapon scripts.....  I'm trying to make the hud.gui display data from weapon scripts.  I'm doing this to show what Fire Mode the current weapon is set to (if you've played my mod, you'll know what I'm talking about).  Here is what I have:
<br /><br />Snippet of code from pistol.script:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent"> setGuiParm( "mode", "Semi" );</div><br /><br />And here is my code from hud.gui:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">onEvent<br />        {<br />                set "Fire_Mode::text" "gui::mode"<br />        }<br /><br />        windowDef Fire_Mode<br />   {<br />      text   "gui::mode"<br />      rect   366,403,121,71<br />      forecolor   1,1,0,0.99215692<br />      visible   1<br />      textscale   0.30000001<br />      textalign   1<br />      backcolor   0.50196081,0,0,1<br />   }</div>
<br /><br />Knowing my luck..the solution is simple, and right in front of my nose.....  But, at the moment, it does not work <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_sad.gif" alt=":(" title="Sad" /><br /><br />Any help would be greatly appreciated.....
<br /><br />Thanks in advance.
<br /><br />P.S.  The back color will not be in the final release....just was there for testing....</div>]]></body></post><post id="p97869" date="Posted: Fri Jun 03, 2005 10:20 am "><author>S@TaNiC</author><body><![CDATA[<div class="postbody">Hi, Well if your calling setGuiParm( "mode", "semi" ); like that then its trying to apply a variable called mode onto a gui held on the pistol.
<br /><br />I think you need to do step 3 from goliathvt's tut and explicitly define the hud on the info_player_start entity.
<br /><br />Key: gui
<br />Value: guis/hud.gui
<br /><br /> Then in your pistol script reference it like .
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">$info_player_start.setGuiParm( "mode", "semi" );</div>
<br /><br />Hope that helps.</div>]]></body></post><post id="p97913" date="Posted: Fri Jun 03, 2005 5:49 pm "><author>Cody64</author><body><![CDATA[<div class="postbody">Unless I'm misunderstanding, I think that technique only works Map scripts.....  Maybe I'm wrong though....I'm still sort of a noob to guis <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_sad.gif" alt=":(" title="Sad" /></div>]]></body></post><post id="p97976" date="Posted: Sat Jun 04, 2005 5:18 am "><author>S@TaNiC</author><body><![CDATA[<div class="postbody">Bare with me cody64 this does end in a solution but theres most probably a few eggs to suck first.
<br /><br />There is no reason why this should not work no matter what type of script it is in.
<br />There are only 2 types of script (something that when i get a little time i would like to change in the wiki)
<br /><br />	1 <span style="font-weight: bold">OBJECT</span> script - AI or WEAPON scripts for instance are both object scripts they run once for each entity they are referenced by. This is set in the entities def file using the key "scriptobject".
<br />			e.g each monster you spawn is runnig its own version of its script even if they are the same type of monster. The script is running for a specific entity so there is no need to reference this entity for commands hence the reason you can say pos = getOrigin(); in a monster script and it will return the position of this monster. The other thing special about object scripts is that they can inherit variables and functions from another script, like all monsters inherit stuff from monster_base.script.
<br /><br />	2 <span style="font-weight: bold">MAP</span> script - Just a plain old script has no special features other than it runs for the named map only. In a map script you have to reference every entity before a command.
<br />			e.g pos = $mymonster.getOrigin();
<br /><br /><br /><span style="font-weight: bold">setGuiParm( "parm name", value);</span>- This sets a variable on the referenced entity's gui (which is found from the entitys "gui" key) to the value specified.
<br /><br /><span style="font-weight: bold">OBJECT</span> - for example the BFG has in its script setGuiParm( "powerlevel", 0 ); this sets a variable on the BFG's gui, its gui is defined in the BFG's def file "gui" "guis/weapons/bfg.gui".
<br /><br /><span style="font-weight: bold">MAP</span> - if you were to place a func_static in your map named <span style="font-style: italic">mystatic</span> with a k/v of "gui" "gui/mygui.gui" you would then reference it in the map script as $mystatic.setGuiParm("parm name", value);
<br /><br /><br />So, you wish to set a value on an entitys gui (in this case the player for the hud) from an object script that is not the entitys scriptobject (in this case weapon_pistol). So you would need to write $player1.setGuiParm("parm name", value). Although writing $player1 would only make it work if you were player1 (several things could screw this up especially multiplayer).
<br />Because the setGuiParm command looks at the "gui" key on the referenced entity to know which gui to apply this variable to we also need to specify the gui on the player entity.
<br />_________________________________
<br />OK thats the egg sucking over with, now on to the solution. I have tested this and it seems to work ok for both SP and MP (as i have not played your mod <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_redface.gif" alt=":oops:" title="Embarassed" />, so wasnt sure what you needed).
<br /><br />Open up player.def and add a k/v of "gui" "guis/hud.gui" to the entitydef player_doommarine. This is our SP players reference to its gui ( the hud).
<br />Open up mp.def and add a k/v of "gui" "guis/mphud.gui" to the entitydef player_doommarine_mp. This is our MP players reference to its gui.
<br /><br />Then for your weapon script add to the objects variable list
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">entity player;</div><br />then in the init function<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">player = getOwner();</div>This gets around the problem of you may not be player1.<br /><br />Then where ever you need it, set your gui variable like so<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">player.setGuiParm("parm name", value);</div>
<br />Other than creating your windowDef in the hud and mphud thats it. You shouldnt need the onevent either from what i tested.
<br /><br />Well hope that all makes sense made a little bit of a pigs ear out of the post. <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p98067" date="Posted: Sat Jun 04, 2005 7:23 pm "><author>Cody64</author><body><![CDATA[<div class="postbody">IT WORKS NOW :O  Thank you S@TaNiC <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  This makes the using fire modes in the mod much more convenient now <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" />  For example, when I have the Shotgun equipped, I can press 'E' to swith between single shot (regular), double blast, and full auto.  Now, I can have the selected fire mode shown on the hud <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">(as i have not played your mod , so wasnt sure what you needed).</div>
<br /><br />Well, we have released our first Demo, which you can try if you'd like.  Here is a link to one of the sites you can download it from:
<br /><br /><a href="https://web.archive.org/web/20121104025750/http://doom3.filefront.com/file/DOOM_Chronicles_Chapter_One_beta_demo;38182x#619013" class="postlink">http://doom3.filefront.com/file/DOOM_Chronicles_Chapter_One_beta_demo;38182x#619013</a>
<br /><br />Once again, thanks for the help <img src="https://web.archive.org/web/20121104025750im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post></posts></thread></xml>
