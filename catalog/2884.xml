<?xml version="1.0" encoding="UTF-8"?>
<xml><thread id="2884"><title>Final MD5 File Formats</title><posts><post id="142681" date="Posted: Wed May 10, 2006 12:17 am    Post subject: "><author>[Win]Elchtest</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. &#13;
<br/><br/>
anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)&#13;
<br/><br/>
thanx!<br/>_________________<br/><a href="/web/20061013055222/http://www.quake.de/" target="_blank">http://www.quake.de</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="142992" date="Posted: Fri May 12, 2006 5:44 pm    Post subject: "><author>[Win]Elchtest</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">two open source viewers can be found here:&#13;
<br/><br/><a href="/web/20061013055222/http://tfc.duke.free.fr/" target="_blank">http://tfc.duke.free.fr/</a><br/>_________________<br/><a href="/web/20061013055222/http://www.quake.de/" target="_blank">http://www.quake.de</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="143675" date="Posted: Sat May 20, 2006 6:45 pm    Post subject: "><author>pannan</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>[Win]Elchtest wrote:</b></span></td>	</tr><tr><td class="quote">two open source viewers can be found here:&#13;
<br/><br/><a href="/web/20061013055222/http://tfc.duke.free.fr/" target="_blank">http://tfc.duke.free.fr/</a></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
Good Job!&#13;
<br/>
Thanks to your threads.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="144998" date="Posted: Mon Jun 05, 2006 1:18 pm    Post subject: "><author>Tr3B</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hi, this is my first post on this Board. <img src="/web/20061013055222im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/><br/><br/>
I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.&#13;
<br/><br/><img src="/web/20061013055222im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" border="0"/><br/>_________________<br/>XreaL - <a href="/web/20061013055222/http://xreal.sourceforge.net/" target="_blank">http://xreal.sourceforge.net</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="145000" date="Posted: Mon Jun 05, 2006 2:09 pm    Post subject: "><author>ViPr</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">your specular looks kinda off.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="145637" date="Posted: Sun Jun 11, 2006 11:57 am    Post subject: "><author>Ging</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).&#13;
<br/><br/>
this <a href="/web/20061013055222/http://www.chrisjanes.com/files/pinky-animation.jpg" target="_blank" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)&#13;
<br/><br/>
I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="28420" date="Posted: Wed Aug 04, 2004 2:37 pm    Post subject: Final MD5 File Formats"><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">let's talk about ...&#13;
<br/>
the new formats of the md5mesh and md5anim files&#13;
<br/><br/>
i have take a first look on it and will post here what i have found out, it is not complete&#13;
<br/><br/>
so, start with some excerpts of two example files, i choose the imp:&#13;
<br/><br/>
imp.md5mesh&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
MD5Version 10&#13;
<br/>
commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"&#13;
<br/><br/>
numJoints 71&#13;
<br/>
numMeshes 1&#13;
<br/><br/>
joints {&#13;
<br/>
   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // &#13;
<br/>
   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin&#13;
<br/>
   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
mesh {&#13;
<br/>
   // meshes: polySurface1&#13;
<br/>
   shader "models/monsters/imp/imp"&#13;
<br/><br/>
   numverts 891&#13;
<br/>
   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2&#13;
<br/>
   ...&#13;
<br/><br/>
   numtris 1346&#13;
<br/>
   tri 0 2 1 0&#13;
<br/>
   ...&#13;
<br/><br/>
   numweights 1401&#13;
<br/>
   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
idle1.md5anim&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
MD5Version 10&#13;
<br/>
commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"&#13;
<br/><br/>
numFrames 80&#13;
<br/>
numJoints 71&#13;
<br/>
frameRate 24&#13;
<br/>
numAnimatedComponents 52&#13;
<br/><br/>
hierarchy {&#13;
<br/>
   "origin"   -1 0 0   //&#13;
<br/>
   "Body"   0 6 0   // origin ( Ty Tz )&#13;
<br/>
   "Hips"   1 3 2   // Body ( Tx Ty )&#13;
<br/>
   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
bounds {&#13;
<br/>
   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.&#13;
<br/>
4121990204 41.8222160339 81.8068695068 )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
baseframe {&#13;
<br/>
   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )&#13;
<br/>
   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )&#13;
<br/>
   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
frame 0 {&#13;
<br/>
    51.5447387695 -3.0239832401&#13;
<br/>
    1.0195504427 5.3025918007&#13;
<br/>
    0.7355086803 -0.3889687657 0.4772257507&#13;
<br/>
    0.0189839788 0.0578746125 -0.5245873928&#13;
<br/>
    -0.8296036124 0.3866359591 0.0100788241&#13;
<br/>
    0.488070637 -0.3712677062 0.7295016646&#13;
<br/>
    -0.0142540894 -0.0333928876 -0.5200206041&#13;
<br/>
    0.8724460602 -0.4404397309 0.1936372519&#13;
<br/>
    1.0421460867 2.7552113533&#13;
<br/>
    -0.1609682292 0.0150111886 0.067597121&#13;
<br/>
    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761&#13;
<br/>
    -5.4427704811 0.0235444643&#13;
<br/>
    6.0652527809&#13;
<br/>
    0.0415914208 0.1587915123 -0.0024342418&#13;
<br/>
    0.1301603615 0.0321234874 -0.2374467552&#13;
<br/>
    0.0672957376 -0.1049735919 0.1197357625&#13;
<br/>
    0.0461013205&#13;
<br/>
    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974&#13;
<br/>
    0.0191769451 -0.1025890633 0.0379714668&#13;
<br/>
}&#13;
<br/>
...&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/><br/><br/><br/><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span>&#13;
<br/><br/><span style="font-weight: bold">Joint:</span>&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
first the name of the joint&#13;
<br/><br/>
second the index of the parentjoint, -1 == no parent&#13;
<br/><br/>
the next three numers are the position of the joint x y z&#13;
<br/><br/>
the last three numbers are part of the orientation-quaternion&#13;
<br/>
the md5 stores only the x y z components&#13;
<br/>
there are unit quaternions, so there length are 1.0&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">1.0 = x^2 + y^2 + z^2 + w^2</td>	</tr></table><span class="postbody">&#13;
<br/>
so to calc the w component do&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
float term = 1.0f - (x*x) - (y*y) - (z*z);&#13;
<br/>
float qw;&#13;
<br/>
if (term &lt; 0.0f)&#13;
<br/>
   qw = 0.0f;&#13;
<br/>
else&#13;
<br/>
   qw = - (float) sqrt(term);&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
the position and orientation are also absolute values, no offest to the parent joint&#13;
<br/><br/><br/><span style="font-weight: bold">Mesh:</span>&#13;
<br/><br/>
beside some ('s and )'s, it's equal to the old format&#13;
<br/><br/>
quick refresh:&#13;
<br/>
verts store the uv texcoords and the startindex and count of the weights&#13;
<br/>
weights store the jointindex and the weight and x y z pos&#13;
<br/><br/><br/><br/><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span>&#13;
<br/><br/>
numFrames 80&#13;
<br/>
numJoints 71&#13;
<br/>
frameRate 24&#13;
<br/>
numAnimatedComponents 52&#13;
<br/><br/><span style="font-weight: bold">hierarchy:</span>&#13;
<br/><br/>
numJoints entries&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
first the name of the joint&#13;
<br/><br/>
than the parentjoint index&#13;
<br/><br/>
next the flag that tells whitch components are animated in the frames:&#13;
<br/><br/>
six possible components - translation x y z and orientation x y z&#13;
<br/><br/>
one bit for each component:&#13;
<br/><br/>
bit 0 - 1  =&gt; translation x&#13;
<br/>
bit 1 - 2  =&gt; translation y&#13;
<br/>
bit 2 - 4  =&gt; translation z&#13;
<br/>
bit 3 - 8  =&gt; orientation x&#13;
<br/>
bit 4 - 16 =&gt; orientation y&#13;
<br/>
bit 5 - 32 =&gt; orientation z&#13;
<br/><br/>
ie:&#13;
<br/>
56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;
<br/>
6 =&gt; 2+4 -&gt; translation y and z&#13;
<br/><br/>
the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;
<br/>
the count of animated components are indicated by the preceding flag&#13;
<br/><br/><span style="font-weight: bold">bounds:</span>&#13;
<br/><br/>
numFrames entries&#13;
<br/>
min x y z and max x y z&#13;
<br/>
the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;
<br/><br/><span style="font-weight: bold">baseframe:</span>&#13;
<br/><br/>
position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;
<br/><br/>
i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;
<br/><br/><span style="font-weight: bold">frame:</span>&#13;
<br/><br/>
numAnimatedComponents entries&#13;
<br/><br/>
my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;
<br/><br/><br/>
when you know some more infos or have some corrections please post it <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"><br/><br/>Last edited by bozo on Mon Aug 23, 2004 1:17 pm; edited 2 times in total</span></td>
			</tr>]]></body></post><post id="28474" date="Posted: Wed Aug 04, 2004 4:22 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">i am not sure about the righthand or lefthand issue, so maybe w must be negate</td>	</tr></table><span class="postbody">&#13;
<br/>
The w component of the quaternions have to be negated, yep:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</td>	</tr></table><span class="postbody"><br/>_________________<br/><a href="/web/20061013061331/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013061331im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013061331/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="28625" date="Posted: Wed Aug 04, 2004 11:27 pm    Post subject: "><author>sic1</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="28655" date="Posted: Thu Aug 05, 2004 12:29 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/><br/><br/>
Hmm I wish I could have Doom3 to try some MD5 coding!&#13;
<br/><br/>
Greets.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29823" date="Posted: Sat Aug 07, 2004 3:07 am    Post subject: "><author>sic1</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29880" date="Posted: Sat Aug 07, 2004 4:34 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Â¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;
<br/><br/>
If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">fn buildSkeleton =&#13;
<br/>
(&#13;
<br/>
   -- For each MD5 bone&#13;
<br/>
   for auxBone in bones do&#13;
<br/>
   (&#13;
<br/>
      local bonePos = auxBone.bindPos&#13;
<br/>
      local parentBonePos = [0, 0, 0]&#13;
<br/><br/>
      -- If the current MD5 bone has a parent...&#13;
<br/>
      if auxBone.parent &gt; 0 do&#13;
<br/>
      (&#13;
<br/>
         -- Set the current MD5 bone's parent position&#13;
<br/>
         parentBonePos = bones[auxBone.parent].bindPos&#13;
<br/>
      )&#13;
<br/>
      &#13;
<br/>
      -- Create the new MAX bone&#13;
<br/>
      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]&#13;
<br/>
      newBone.width = 1&#13;
<br/>
      newBone.height = 1&#13;
<br/>
      newBone.name = copy auxBone.name&#13;
<br/>
      &#13;
<br/>
      -- If current MD5 bone has a parent...&#13;
<br/>
      if auxBone.parent &gt; 0 do&#13;
<br/>
      (&#13;
<br/>
         -- Assign current MAX bone's parent&#13;
<br/>
         newBone.parent = MAXBones[auxBone.parent]&#13;
<br/>
      )&#13;
<br/><br/>
      -- Add new MAX bone to array of MAX bones&#13;
<br/>
      append MAXBones newBone&#13;
<br/>
   )&#13;
<br/><br/>
   -- Zoom extends to all objects&#13;
<br/>
   max zoomext sel all&#13;
<br/>
)</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
But I'm not sure if the result is the correct. Look this image:&#13;
<br/><br/><img src="/web/20061013061331im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" border="0"/><br/><br/>
That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;
<br/><br/>
Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;
<br/><br/>
BTW, I'm also interested on how the other coders handle this.&#13;
<br/><br/>
Happy coding! <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29935" date="Posted: Sat Aug 07, 2004 5:51 am    Post subject: "><author>sic1</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;
<br/><br/><img src="/web/20061013061331im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" border="0"/><br/><br/>
I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29953" date="Posted: Sat Aug 07, 2004 6:28 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30016" date="Posted: Sat Aug 07, 2004 11:39 am    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@BeRSeRKeR&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;
<br/><br/>
but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;
<br/>
so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;
<br/>
with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;
<br/><br/>
i dont try the new fileformat at present,&#13;
<br/>
but now the hierarchy info is also in the md5anim files,&#13;
<br/>
so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30063" date="Posted: Sat Aug 07, 2004 2:04 pm    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">i dont try the new fileformat at present,&#13;
<br/>
but now the hierarchy info is also in the md5anim files,&#13;
<br/>
so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</td>	</tr></table><span class="postbody">&#13;
<br/>
By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;
<br/><br/>
Thanks!.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30185" date="Posted: Sat Aug 07, 2004 5:27 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;
<br/><br/>
example:&#13;
<br/>
baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;
<br/>
Qx and Qy are animated components:&#13;
<br/>
frame 14:  -0.8022928834 0.5969305038&#13;
<br/>
frame 15: 0.802292943 -0.5969305634<br/>_________________<br/><a href="/web/20061013061331/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013061331im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013061331/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30576" date="Posted: Sun Aug 08, 2004 11:13 am    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@der_ton&#13;
<br/><br/>
i didn't try the new md5anim format currently,&#13;
<br/>
but in a other own project, i had troubles that sounds like yours,&#13;
<br/>
here is what i did:&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];&#13;
<br/>
if (cosom &lt; 0.0f)&#13;
<br/>
{&#13;
<br/>
   q2[0] = -q2[0];&#13;
<br/>
   q2[1] = -q2[1];&#13;
<br/>
   q2[2] = -q2[2];&#13;
<br/>
   q2[3] = -q2[3];&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody"/><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31067" date="Posted: Mon Aug 09, 2004 4:20 am    Post subject: "><author>Hell Byte</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">So.. to export a mesh properly i would need the following data:&#13;
<br/><br/>
-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;
<br/>
-Mesh Data ( verts &amp; tris &amp; weights )&#13;
<br/><br/>
Some questions:&#13;
<br/><br/>
1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;
<br/><br/>
2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;
<br/><br/>
3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;
<br/><br/>
4. Im not sure what weights are.. can i get a primer real quick?&#13;
<br/><br/>
5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;
<br/><br/>
6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;
<br/><br/>
Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31078" date="Posted: Mon Aug 09, 2004 4:48 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">So.. to export a mesh properly i would need the following data:&#13;
<br/><br/>
-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;
<br/>
-Mesh Data ( verts &amp; tris &amp; weights )</td>	</tr></table><span class="postbody">&#13;
<br/>
If you only want the geometry data, yes.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</td>	</tr></table><span class="postbody">&#13;
<br/>
Example:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</td>	</tr></table><span class="postbody">&#13;
<br/>
1st param -&gt; vertex index&#13;
<br/>
2nd and 3rd params -&gt; u and v (texture coordinates)&#13;
<br/>
4th param -&gt; start of the vertex weights into the array of weights&#13;
<br/>
5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">4. Im not sure what weights are.. can i get a primer real quick?</td>	</tr></table><span class="postbody">&#13;
<br/>
The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</td>	</tr></table><span class="postbody">&#13;
<br/>
Yeah, otherwise Doom3 won't be able to load your models.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</td>	</tr></table><span class="postbody">&#13;
<br/>
Example:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">tri 0 2 1 0</td>	</tr></table><span class="postbody">&#13;
<br/>
1st param -&gt; triangle index&#13;
<br/>
2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;
<br/><br/>
Greetings.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31091" date="Posted: Mon Aug 09, 2004 5:09 am    Post subject: "><author>Hell Byte</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;
<br/><br/>
Just a few more questions though, if you guys dont mind:&#13;
<br/><br/>
I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;
<br/><br/>
And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;
<br/><br/>
And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;
<br/><br/>
Thanks again for all the help, this forum is great!</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31139" date="Posted: Mon Aug 09, 2004 6:29 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</td>	</tr></table><span class="postbody">&#13;
<br/>
Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</td>	</tr></table><span class="postbody">&#13;
<br/>
IIRC, same above.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</td>	</tr></table><span class="postbody">&#13;
<br/>
All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;
<br/><br/>
As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31141" date="Posted: Mon Aug 09, 2004 6:32 am    Post subject: "><author>Hell Byte</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Awesome, that makes things much easier for me <img src="/web/20061013061331im_/http://doom3world.org/phpbb2/images/smiles/icon_biggrin.gif" alt="Very Happy" border="0"/><br/><br/>
Thanks!</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="39222" date="Posted: Fri Aug 20, 2004 11:41 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.<br/>_________________<br/><a href="/web/20061013061331/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013061331im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013061331/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"><br/><br/>Last edited by der_ton on Mon Aug 23, 2004 11:05 am; edited 1 time in total</span></td>
			</tr>]]></body></post><post id="40294" date="Posted: Mon Aug 23, 2004 12:52 am    Post subject: "><author>Darineth Starwolf</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;
<br/><br/><a href="/web/20061013061331/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" target="_blank" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;
<br/><br/>
You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="40303" date="Posted: Mon Aug 23, 2004 1:34 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Take a look at <a href="/web/20061013061331/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" target="_blank" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;
<br/><br/>
Greets.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="28420" date="Posted: Wed Aug 04, 2004 2:37 pm    Post subject: Final MD5 File Formats"><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">let's talk about ...&#13;
<br/>
the new formats of the md5mesh and md5anim files&#13;
<br/><br/>
i have take a first look on it and will post here what i have found out, it is not complete&#13;
<br/><br/>
so, start with some excerpts of two example files, i choose the imp:&#13;
<br/><br/>
imp.md5mesh&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
MD5Version 10&#13;
<br/>
commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"&#13;
<br/><br/>
numJoints 71&#13;
<br/>
numMeshes 1&#13;
<br/><br/>
joints {&#13;
<br/>
   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // &#13;
<br/>
   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin&#13;
<br/>
   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
mesh {&#13;
<br/>
   // meshes: polySurface1&#13;
<br/>
   shader "models/monsters/imp/imp"&#13;
<br/><br/>
   numverts 891&#13;
<br/>
   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2&#13;
<br/>
   ...&#13;
<br/><br/>
   numtris 1346&#13;
<br/>
   tri 0 2 1 0&#13;
<br/>
   ...&#13;
<br/><br/>
   numweights 1401&#13;
<br/>
   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
idle1.md5anim&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
MD5Version 10&#13;
<br/>
commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"&#13;
<br/><br/>
numFrames 80&#13;
<br/>
numJoints 71&#13;
<br/>
frameRate 24&#13;
<br/>
numAnimatedComponents 52&#13;
<br/><br/>
hierarchy {&#13;
<br/>
   "origin"   -1 0 0   //&#13;
<br/>
   "Body"   0 6 0   // origin ( Ty Tz )&#13;
<br/>
   "Hips"   1 3 2   // Body ( Tx Ty )&#13;
<br/>
   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
bounds {&#13;
<br/>
   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.&#13;
<br/>
4121990204 41.8222160339 81.8068695068 )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
baseframe {&#13;
<br/>
   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )&#13;
<br/>
   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )&#13;
<br/>
   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )&#13;
<br/>
   ...&#13;
<br/>
}&#13;
<br/><br/>
frame 0 {&#13;
<br/>
    51.5447387695 -3.0239832401&#13;
<br/>
    1.0195504427 5.3025918007&#13;
<br/>
    0.7355086803 -0.3889687657 0.4772257507&#13;
<br/>
    0.0189839788 0.0578746125 -0.5245873928&#13;
<br/>
    -0.8296036124 0.3866359591 0.0100788241&#13;
<br/>
    0.488070637 -0.3712677062 0.7295016646&#13;
<br/>
    -0.0142540894 -0.0333928876 -0.5200206041&#13;
<br/>
    0.8724460602 -0.4404397309 0.1936372519&#13;
<br/>
    1.0421460867 2.7552113533&#13;
<br/>
    -0.1609682292 0.0150111886 0.067597121&#13;
<br/>
    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761&#13;
<br/>
    -5.4427704811 0.0235444643&#13;
<br/>
    6.0652527809&#13;
<br/>
    0.0415914208 0.1587915123 -0.0024342418&#13;
<br/>
    0.1301603615 0.0321234874 -0.2374467552&#13;
<br/>
    0.0672957376 -0.1049735919 0.1197357625&#13;
<br/>
    0.0461013205&#13;
<br/>
    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974&#13;
<br/>
    0.0191769451 -0.1025890633 0.0379714668&#13;
<br/>
}&#13;
<br/>
...&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/><br/><br/><br/><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span>&#13;
<br/><br/><span style="font-weight: bold">Joint:</span>&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
first the name of the joint&#13;
<br/><br/>
second the index of the parentjoint, -1 == no parent&#13;
<br/><br/>
the next three numers are the position of the joint x y z&#13;
<br/><br/>
the last three numbers are part of the orientation-quaternion&#13;
<br/>
the md5 stores only the x y z components&#13;
<br/>
there are unit quaternions, so there length are 1.0&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">1.0 = x^2 + y^2 + z^2 + w^2</td>	</tr></table><span class="postbody">&#13;
<br/>
so to calc the w component do&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
float term = 1.0f - (x*x) - (y*y) - (z*z);&#13;
<br/>
float qw;&#13;
<br/>
if (term &lt; 0.0f)&#13;
<br/>
   qw = 0.0f;&#13;
<br/>
else&#13;
<br/>
   qw = - (float) sqrt(term);&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
the position and orientation are also absolute values, no offest to the parent joint&#13;
<br/><br/><br/><span style="font-weight: bold">Mesh:</span>&#13;
<br/><br/>
beside some ('s and )'s, it's equal to the old format&#13;
<br/><br/>
quick refresh:&#13;
<br/>
verts store the uv texcoords and the startindex and count of the weights&#13;
<br/>
weights store the jointindex and the weight and x y z pos&#13;
<br/><br/><br/><br/><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span>&#13;
<br/><br/>
numFrames 80&#13;
<br/>
numJoints 71&#13;
<br/>
frameRate 24&#13;
<br/>
numAnimatedComponents 52&#13;
<br/><br/><span style="font-weight: bold">hierarchy:</span>&#13;
<br/><br/>
numJoints entries&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
first the name of the joint&#13;
<br/><br/>
than the parentjoint index&#13;
<br/><br/>
next the flag that tells whitch components are animated in the frames:&#13;
<br/><br/>
six possible components - translation x y z and orientation x y z&#13;
<br/><br/>
one bit for each component:&#13;
<br/><br/>
bit 0 - 1  =&gt; translation x&#13;
<br/>
bit 1 - 2  =&gt; translation y&#13;
<br/>
bit 2 - 4  =&gt; translation z&#13;
<br/>
bit 3 - 8  =&gt; orientation x&#13;
<br/>
bit 4 - 16 =&gt; orientation y&#13;
<br/>
bit 5 - 32 =&gt; orientation z&#13;
<br/><br/>
ie:&#13;
<br/>
56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;
<br/>
6 =&gt; 2+4 -&gt; translation y and z&#13;
<br/><br/>
the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;
<br/>
the count of animated components are indicated by the preceding flag&#13;
<br/><br/><span style="font-weight: bold">bounds:</span>&#13;
<br/><br/>
numFrames entries&#13;
<br/>
min x y z and max x y z&#13;
<br/>
the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;
<br/><br/><span style="font-weight: bold">baseframe:</span>&#13;
<br/><br/>
position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;
<br/><br/>
i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;
<br/><br/><span style="font-weight: bold">frame:</span>&#13;
<br/><br/>
numAnimatedComponents entries&#13;
<br/><br/>
my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;
<br/><br/><br/>
when you know some more infos or have some corrections please post it <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"><br/><br/>Last edited by bozo on Mon Aug 23, 2004 1:17 pm; edited 2 times in total</span></td>
			</tr>]]></body></post><post id="28474" date="Posted: Wed Aug 04, 2004 4:22 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">i am not sure about the righthand or lefthand issue, so maybe w must be negate</td>	</tr></table><span class="postbody">&#13;
<br/>
The w component of the quaternions have to be negated, yep:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</td>	</tr></table><span class="postbody"><br/>_________________<br/><a href="/web/20061013054542/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054542im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054542/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="28625" date="Posted: Wed Aug 04, 2004 11:27 pm    Post subject: "><author>sic1</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="28655" date="Posted: Thu Aug 05, 2004 12:29 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/><br/><br/>
Hmm I wish I could have Doom3 to try some MD5 coding!&#13;
<br/><br/>
Greets.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29823" date="Posted: Sat Aug 07, 2004 3:07 am    Post subject: "><author>sic1</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29880" date="Posted: Sat Aug 07, 2004 4:34 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Â¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;
<br/><br/>
If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">fn buildSkeleton =&#13;
<br/>
(&#13;
<br/>
   -- For each MD5 bone&#13;
<br/>
   for auxBone in bones do&#13;
<br/>
   (&#13;
<br/>
      local bonePos = auxBone.bindPos&#13;
<br/>
      local parentBonePos = [0, 0, 0]&#13;
<br/><br/>
      -- If the current MD5 bone has a parent...&#13;
<br/>
      if auxBone.parent &gt; 0 do&#13;
<br/>
      (&#13;
<br/>
         -- Set the current MD5 bone's parent position&#13;
<br/>
         parentBonePos = bones[auxBone.parent].bindPos&#13;
<br/>
      )&#13;
<br/>
      &#13;
<br/>
      -- Create the new MAX bone&#13;
<br/>
      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]&#13;
<br/>
      newBone.width = 1&#13;
<br/>
      newBone.height = 1&#13;
<br/>
      newBone.name = copy auxBone.name&#13;
<br/>
      &#13;
<br/>
      -- If current MD5 bone has a parent...&#13;
<br/>
      if auxBone.parent &gt; 0 do&#13;
<br/>
      (&#13;
<br/>
         -- Assign current MAX bone's parent&#13;
<br/>
         newBone.parent = MAXBones[auxBone.parent]&#13;
<br/>
      )&#13;
<br/><br/>
      -- Add new MAX bone to array of MAX bones&#13;
<br/>
      append MAXBones newBone&#13;
<br/>
   )&#13;
<br/><br/>
   -- Zoom extends to all objects&#13;
<br/>
   max zoomext sel all&#13;
<br/>
)</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
But I'm not sure if the result is the correct. Look this image:&#13;
<br/><br/><img src="/web/20061013054542im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" border="0"/><br/><br/>
That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;
<br/><br/>
Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;
<br/><br/>
BTW, I'm also interested on how the other coders handle this.&#13;
<br/><br/>
Happy coding! <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29935" date="Posted: Sat Aug 07, 2004 5:51 am    Post subject: "><author>sic1</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;
<br/><br/><img src="/web/20061013054542im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" border="0"/><br/><br/>
I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="29953" date="Posted: Sat Aug 07, 2004 6:28 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30016" date="Posted: Sat Aug 07, 2004 11:39 am    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@BeRSeRKeR&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;
<br/><br/>
but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;
<br/>
so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;
<br/>
with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;
<br/><br/>
i dont try the new fileformat at present,&#13;
<br/>
but now the hierarchy info is also in the md5anim files,&#13;
<br/>
so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30063" date="Posted: Sat Aug 07, 2004 2:04 pm    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">i dont try the new fileformat at present,&#13;
<br/>
but now the hierarchy info is also in the md5anim files,&#13;
<br/>
so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</td>	</tr></table><span class="postbody">&#13;
<br/>
By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;
<br/><br/>
Thanks!.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30185" date="Posted: Sat Aug 07, 2004 5:27 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;
<br/><br/>
example:&#13;
<br/>
baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;
<br/>
Qx and Qy are animated components:&#13;
<br/>
frame 14:  -0.8022928834 0.5969305038&#13;
<br/>
frame 15: 0.802292943 -0.5969305634<br/>_________________<br/><a href="/web/20061013054542/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054542im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054542/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="30576" date="Posted: Sun Aug 08, 2004 11:13 am    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@der_ton&#13;
<br/><br/>
i didn't try the new md5anim format currently,&#13;
<br/>
but in a other own project, i had troubles that sounds like yours,&#13;
<br/>
here is what i did:&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];&#13;
<br/>
if (cosom &lt; 0.0f)&#13;
<br/>
{&#13;
<br/>
   q2[0] = -q2[0];&#13;
<br/>
   q2[1] = -q2[1];&#13;
<br/>
   q2[2] = -q2[2];&#13;
<br/>
   q2[3] = -q2[3];&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody"/><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31067" date="Posted: Mon Aug 09, 2004 4:20 am    Post subject: "><author>Hell Byte</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">So.. to export a mesh properly i would need the following data:&#13;
<br/><br/>
-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;
<br/>
-Mesh Data ( verts &amp; tris &amp; weights )&#13;
<br/><br/>
Some questions:&#13;
<br/><br/>
1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;
<br/><br/>
2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;
<br/><br/>
3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;
<br/><br/>
4. Im not sure what weights are.. can i get a primer real quick?&#13;
<br/><br/>
5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;
<br/><br/>
6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;
<br/><br/>
Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31078" date="Posted: Mon Aug 09, 2004 4:48 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">So.. to export a mesh properly i would need the following data:&#13;
<br/><br/>
-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;
<br/>
-Mesh Data ( verts &amp; tris &amp; weights )</td>	</tr></table><span class="postbody">&#13;
<br/>
If you only want the geometry data, yes.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</td>	</tr></table><span class="postbody">&#13;
<br/>
Example:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</td>	</tr></table><span class="postbody">&#13;
<br/>
1st param -&gt; vertex index&#13;
<br/>
2nd and 3rd params -&gt; u and v (texture coordinates)&#13;
<br/>
4th param -&gt; start of the vertex weights into the array of weights&#13;
<br/>
5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">4. Im not sure what weights are.. can i get a primer real quick?</td>	</tr></table><span class="postbody">&#13;
<br/>
The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</td>	</tr></table><span class="postbody">&#13;
<br/>
Yeah, otherwise Doom3 won't be able to load your models.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</td>	</tr></table><span class="postbody">&#13;
<br/>
Example:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">tri 0 2 1 0</td>	</tr></table><span class="postbody">&#13;
<br/>
1st param -&gt; triangle index&#13;
<br/>
2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;
<br/><br/>
Greetings.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31091" date="Posted: Mon Aug 09, 2004 5:09 am    Post subject: "><author>Hell Byte</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;
<br/><br/>
Just a few more questions though, if you guys dont mind:&#13;
<br/><br/>
I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;
<br/><br/>
And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;
<br/><br/>
And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;
<br/><br/>
Thanks again for all the help, this forum is great!</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31139" date="Posted: Mon Aug 09, 2004 6:29 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</td>	</tr></table><span class="postbody">&#13;
<br/>
Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</td>	</tr></table><span class="postbody">&#13;
<br/>
IIRC, same above.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>syphlitix wrote:</b></span></td>	</tr><tr><td class="quote">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</td>	</tr></table><span class="postbody">&#13;
<br/>
All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;
<br/><br/>
As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="31141" date="Posted: Mon Aug 09, 2004 6:32 am    Post subject: "><author>Hell Byte</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Awesome, that makes things much easier for me <img src="/web/20061013054542im_/http://doom3world.org/phpbb2/images/smiles/icon_biggrin.gif" alt="Very Happy" border="0"/><br/><br/>
Thanks!</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="39222" date="Posted: Fri Aug 20, 2004 11:41 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.<br/>_________________<br/><a href="/web/20061013054542/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054542im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054542/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"><br/><br/>Last edited by der_ton on Mon Aug 23, 2004 11:05 am; edited 1 time in total</span></td>
			</tr>]]></body></post><post id="40294" date="Posted: Mon Aug 23, 2004 12:52 am    Post subject: "><author>Darineth Starwolf</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;
<br/><br/><a href="/web/20061013054542/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" target="_blank" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;
<br/><br/>
You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="40303" date="Posted: Mon Aug 23, 2004 1:34 am    Post subject: "><author>BeRSeRKeR</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Take a look at <a href="/web/20061013054542/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" target="_blank" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;
<br/><br/>
Greets.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="142681" date="Posted: Wed May 10, 2006 12:17 am    Post subject: "><author>[Win]Elchtest</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. &#13;
<br/><br/>
anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)&#13;
<br/><br/>
thanx!<br/>_________________<br/><a href="/web/20061013055445/http://www.quake.de/" target="_blank">http://www.quake.de</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="142992" date="Posted: Fri May 12, 2006 5:44 pm    Post subject: "><author>[Win]Elchtest</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">two open source viewers can be found here:&#13;
<br/><br/><a href="/web/20061013055445/http://tfc.duke.free.fr/" target="_blank">http://tfc.duke.free.fr/</a><br/>_________________<br/><a href="/web/20061013055445/http://www.quake.de/" target="_blank">http://www.quake.de</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="143675" date="Posted: Sat May 20, 2006 6:45 pm    Post subject: "><author>pannan</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>[Win]Elchtest wrote:</b></span></td>	</tr><tr><td class="quote">two open source viewers can be found here:&#13;
<br/><br/><a href="/web/20061013055445/http://tfc.duke.free.fr/" target="_blank">http://tfc.duke.free.fr/</a></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
Good Job!&#13;
<br/>
Thanks to your threads.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="144998" date="Posted: Mon Jun 05, 2006 1:18 pm    Post subject: "><author>Tr3B</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hi, this is my first post on this Board. <img src="/web/20061013055445im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/><br/><br/>
I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.&#13;
<br/><br/><img src="/web/20061013055445im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" border="0"/><br/>_________________<br/>XreaL - <a href="/web/20061013055445/http://xreal.sourceforge.net/" target="_blank">http://xreal.sourceforge.net</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="145000" date="Posted: Mon Jun 05, 2006 2:09 pm    Post subject: "><author>ViPr</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">your specular looks kinda off.</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="145637" date="Posted: Sun Jun 11, 2006 11:57 am    Post subject: "><author>Ging</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).&#13;
<br/><br/>
this <a href="/web/20061013055445/http://www.chrisjanes.com/files/pinky-animation.jpg" target="_blank" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)&#13;
<br/><br/>
I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="52968" date="Posted: Fri Sep 24, 2004 2:39 pm    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@der_flo&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">&#13;
<br/>
what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? &#13;
<br/>
And when drawing the vertices, they have to be multilied by this worldmat from this bone?&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">&#13;
<br/>
BTW: Is it faster to let a vertex sheder do the matrix multiplication or &#13;
<br/>
or will it be faster to this in 3DNow or SSE Code?&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
additional to der_ton's post,&#13;
<br/>
you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)&#13;
<br/><br/>
i think the best is, to do the work with the cpu,&#13;
<br/>
and also first get it running (and than think on optimations like sse) <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53006" date="Posted: Fri Sep 24, 2004 7:33 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hi,&#13;
<br/><br/>
thanks for that, but the more i do, the worser it looks  <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_cry.gif" alt="Crying or Very sad" border="0"/><br/>
This is now the code that calculates the bones rotation and transformation&#13;
<br/>
matrix for every frame:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">    232 int iCalcBones(struct s_models *model) {&#13;
<br/>
    233   if (model == NULL) {&#13;
<br/>
    234     return -1;&#13;
<br/>
    235   }&#13;
<br/>
    236   unsigned int i, j;&#13;
<br/>
    237   matrix4x4_t tmp_mat, trans_mat;&#13;
<br/>
    238   float interpol;&#13;
<br/>
    239   struct s_animations *anim = model-&gt;anim;&#13;
<br/>
    240   struct s_anim_frames *currframe, *nextframe;&#13;
<br/>
    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];&#13;
<br/>
    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];&#13;
<br/>
    243   if (currframe == NULL) {&#13;
<br/>
    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");&#13;
<br/>
    245     return 0;&#13;
<br/>
    246   }&#13;
<br/>
    247   if (nextframe == NULL) {&#13;
<br/>
    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");&#13;
<br/>
    249     return 0;&#13;
<br/>
    250   }&#13;
<br/>
    251   interpol = anim-&gt;interpol;&#13;
<br/>
    252   i = 0;&#13;
<br/>
    253   vMatrix4x4Identity(&amp;trans_mat);&#13;
<br/>
    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);&#13;
<br/>
    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);&#13;
<br/>
    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);&#13;
<br/>
    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);&#13;
<br/>
    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
    260 &#13;
<br/>
    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {&#13;
<br/>
    262     vMatrix4x4Identity(&amp;trans_mat);&#13;
<br/>
    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);&#13;
<br/>
    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);&#13;
<br/>
    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);&#13;
<br/>
    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);&#13;
<br/>
    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);&#13;
<br/>
    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);&#13;
<br/>
    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);&#13;
<br/>
    271   }&#13;
<br/>
    272   return 0;&#13;
<br/>
    273 }</td>	</tr></table><span class="postbody">&#13;
<br/>
If you have Linux, i can give you the full source code, at the end&#13;
<br/>
it will be released under the terms of the GPL, when itÂ´s working (i hope&#13;
<br/>
thatÂ´s this decade <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/> )&#13;
<br/><br/>
My Matrices are saved in a float[16] thatÂ´s row ordered (as in OpenGL):&#13;
<br/>
m[0] m[4] m[8] m[12]&#13;
<br/>
m[1] m[5] m[9] m[13]&#13;
<br/>
m[2] m[6] m[10] m[14]&#13;
<br/>
m[3] m[7] m[11] m[15]&#13;
<br/><br/>
At first a i had some segmentation faults, but i got them fixed very quick,&#13;
<br/><br/>
The rendered goldfish looks like every thing else at the moment  <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/><br/><br/>
Regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53013" date="Posted: Fri Sep 24, 2004 8:18 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?&#13;
<br/><br/>
Regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53015" date="Posted: Fri Sep 24, 2004 8:26 pm    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@der_flo&#13;
<br/><br/>
i doesn't know how your matrix func's work, but&#13;
<br/><br/><br/>
* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong&#13;
<br/>
ie.&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
in1 = trans_mat&#13;
<br/>
in2 = out = tmp_mat&#13;
<br/>
out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];&#13;
<br/>
out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];&#13;
<br/>
...&#13;
<br/>
out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];&#13;
<br/>
out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];&#13;
<br/>
...&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/>
i hope it is understandable what i mean&#13;
<br/><br/><br/>
* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them&#13;
<br/>
ie.&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
Matrix4x3_Multiply(rotmat, transmat, out);&#13;
<br/>
Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/><br/>
unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53016" date="Posted: Fri Sep 24, 2004 8:43 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@bozo&#13;
<br/><br/>
i have allready fixed that problem, i make a lokal copy of tha dest matrix,&#13;
<br/>
and after the calculation is ready i copy the temp matrix to the destination.&#13;
<br/><br/>
i have tested this, but i think with matrix multiplication it doesnÂ´t&#13;
<br/>
matter which comes first, by quaternions it matters.&#13;
<br/><br/>
I copyed the source to my webserver, you can download it at:&#13;
<br/><a href="/web/20061013060432/http://www.dotbox.org/code/anim.zip" target="_blank" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB&#13;
<br/><br/>
It should be easy to port to windows, it is using the sdl, gl and glu lib,&#13;
<br/>
i think there are no linux specific implementations at the moment.&#13;
<br/>
A linux Makefile is also in the package, also the binary and the object files (which makes it so big).&#13;
<br/><br/>
Regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53026" date="Posted: Fri Sep 24, 2004 9:49 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.&#13;
<br/><br/>
KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?<br/>_________________<br/><a href="/web/20061013060432/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013060432im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013060432/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53033" date="Posted: Fri Sep 24, 2004 10:22 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.&#13;
<br/>
But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_biggrin.gif" alt="Very Happy" border="0"/><br/><br/>
Kind regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53158" date="Posted: Sat Sep 25, 2004 3:39 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hello,&#13;
<br/><br/>
correct me if i am wrong, but could it be, that the quaternions in the&#13;
<br/>
baseframe are (after a successfull calculation) the same as the on&#13;
<br/>
given in the md5mesh file?&#13;
<br/><br/>
I ask this becouse i just want to make debuging easier for me,&#13;
<br/>
and if this is the case, than i will write a small app, that does nothing&#13;
<br/>
more than calculating this quaternions and if i get the right values,&#13;
<br/>
i can reimplement that in my game eninge.&#13;
<br/><br/>
Regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53162" date="Posted: Sat Sep 25, 2004 4:20 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.<br/>_________________<br/><a href="/web/20061013060432/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013060432im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013060432/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53163" date="Posted: Sat Sep 25, 2004 4:21 pm    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc&#13;
<br/><br/>
- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files&#13;
<br/><br/>
- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files&#13;
<br/><br/>
- in models_load.c:&#13;
<br/>
anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);&#13;
<br/>
must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);&#13;
<br/><br/>
- use the following func, the other implementation does not work with the d3 quat's&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {&#13;
<br/>
   float xx, xy, xz, xw, yy, yz, yw, zz, zw;&#13;
<br/>
   float x2, y2, z2;&#13;
<br/>
   x2 = quat-&gt;x + quat-&gt;x;&#13;
<br/>
   y2 = quat-&gt;y + quat-&gt;y;&#13;
<br/>
   z2 = quat-&gt;z + quat-&gt;z;&#13;
<br/><br/>
   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;&#13;
<br/>
   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;&#13;
<br/>
   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;&#13;
<br/><br/>
   mat-&gt;m[0] = 1.0f - (yy + zz);&#13;
<br/>
   mat-&gt;m[1] = xy + zw;&#13;
<br/>
   mat-&gt;m[2] = xz - yw;&#13;
<br/><br/>
   mat-&gt;m[4] = xy - zw;&#13;
<br/>
   mat-&gt;m[5] = 1.0f - (xx + zz);&#13;
<br/>
   mat-&gt;m[6] = yz + xw;&#13;
<br/><br/>
   mat-&gt;m[8] = xz + yw;&#13;
<br/>
   mat-&gt;m[9] = yz - xw;&#13;
<br/>
   mat-&gt;m[10] = 1.0f - (xx + yy);&#13;
<br/><br/>
   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;&#13;
<br/>
   mat-&gt;m[15] = 1;&#13;
<br/><br/>
   return;&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
and use this func also in models_load.c&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);&#13;
<br/>
tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;&#13;
<br/>
tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;&#13;
<br/>
tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/><br/>
- in iCalcBones(struct s_models *model) handle parentbones&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
...&#13;
<br/>
for (i=0; i&lt;anim-&gt;numJoints; i++) {&#13;
<br/>
     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);&#13;
<br/>
     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);&#13;
<br/>
     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);&#13;
<br/>
     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);&#13;
<br/>
     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);&#13;
<br/>
     if (model-&gt;bones[i].parent != NULL) {&#13;
<br/>
      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
     }&#13;
<br/>
     else {&#13;
<br/>
        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
     }&#13;
<br/>
  }&#13;
<br/>
...&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c&#13;
<br/><br/><br/>
i tested it with the imp model and with this the bindpose works right&#13;
<br/>
but the anims are not ok currently&#13;
<br/>
i will take another look on this</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53170" date="Posted: Sat Sep 25, 2004 4:42 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">@bozo&#13;
<br/><br/>
First of all thank for your work&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">i have take a first look on your code, after i must change it to be able to compile it in vc&#13;
<br/><br/>
- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files&#13;
<br/><br/>
- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
I will clean up the loader after this is running, the model that i try to render&#13;
<br/>
is a simple goldfish, you can find it in the blender 2 md5 export script from &#13;
<br/>
der_ton and in this model there is no content in this two "", but thank you &#13;
<br/>
for that tip.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">&#13;
<br/>
- in models_load.c:&#13;
<br/>
anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);&#13;
<br/>
must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
I have fixed that, also the some lines below that the fscanf instruction&#13;
<br/>
has been fixed, to write the values to the right places.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">&#13;
<br/>
- use the following func, the other implementation does not work with the d3 quat's&#13;
<br/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {&#13;
<br/>
   float xx, xy, xz, xw, yy, yz, yw, zz, zw;&#13;
<br/>
   float x2, y2, z2;&#13;
<br/>
   x2 = quat-&gt;x + quat-&gt;x;&#13;
<br/>
   y2 = quat-&gt;y + quat-&gt;y;&#13;
<br/>
   z2 = quat-&gt;z + quat-&gt;z;&#13;
<br/><br/>
   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;&#13;
<br/>
   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;&#13;
<br/>
   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;&#13;
<br/><br/>
   mat-&gt;m[0] = 1.0f - (yy + zz);&#13;
<br/>
   mat-&gt;m[1] = xy + zw;&#13;
<br/>
   mat-&gt;m[2] = xz - yw;&#13;
<br/><br/>
   mat-&gt;m[4] = xy - zw;&#13;
<br/>
   mat-&gt;m[5] = 1.0f - (xx + zz);&#13;
<br/>
   mat-&gt;m[6] = yz + xw;&#13;
<br/><br/>
   mat-&gt;m[8] = xz + yw;&#13;
<br/>
   mat-&gt;m[9] = yz - xw;&#13;
<br/>
   mat-&gt;m[10] = 1.0f - (xx + yy);&#13;
<br/><br/>
   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;&#13;
<br/>
   mat-&gt;m[15] = 1;&#13;
<br/><br/>
   return;&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
and use this func also in models_load.c&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);&#13;
<br/>
tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;&#13;
<br/>
tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;&#13;
<br/>
tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/></span></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
done&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">&#13;
<br/>
- in iCalcBones(struct s_models *model) handle parentbones&#13;
<br/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
...&#13;
<br/>
for (i=0; i&lt;anim-&gt;numJoints; i++) {&#13;
<br/>
     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);&#13;
<br/>
     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);&#13;
<br/><br/>
     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);&#13;
<br/>
     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);&#13;
<br/>
     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);&#13;
<br/>
     if (model-&gt;bones[i].parent != NULL) {&#13;
<br/>
      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
     }&#13;
<br/>
     else {&#13;
<br/>
        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);&#13;
<br/>
     }&#13;
<br/>
  }&#13;
<br/>
...&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c&#13;
<br/></span></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
Done <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/><br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>bozo wrote:</b></span></td>	</tr><tr><td class="quote">&#13;
<br/>
i tested it with the imp model and with this the bindpose works right&#13;
<br/>
but the anims are not ok currently&#13;
<br/>
i will take another look on this</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
You mean the baseframe or the bones from the md5mesh?&#13;
<br/><br/>
Kind regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53171" date="Posted: Sat Sep 25, 2004 4:44 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hello,&#13;
<br/><br/>
forget my last question about the bindpos, der_ton answered that allready.&#13;
<br/><br/>
Kind regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53173" date="Posted: Sat Sep 25, 2004 5:10 pm    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's&#13;
<br/><br/>
- in models_load.c:&#13;
<br/>
fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);&#13;
<br/>
the \n was missing&#13;
<br/><br/>
than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed&#13;
<br/><br/>
one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much&#13;
<br/><br/>
- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented&#13;
<br/><br/>
- now the anim works <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/> (tested with the imp model) (the fish anim is really strange, no good for testing)</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53177" date="Posted: Sat Sep 25, 2004 5:37 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Thanks man, but unfortunately itÂ´s not working&#13;
<br/>
here, can you send me the source code and that imp&#13;
<br/>
model please?&#13;
<br/><br/>
Wow, i can not belief that you get it to working, you rock man <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/><br/><br/>
Regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53184" date="Posted: Sat Sep 25, 2004 6:14 pm    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hello,&#13;
<br/><br/>
with the help from bozo i got it running, but could try to load&#13;
<br/>
this fish model from der_tonÂ´s blender export script with a viewer&#13;
<br/>
(all viewers i have seen are for windows, and i dont have windows here)&#13;
<br/>
becouse it seems like there is a bug in that md5anim file.&#13;
<br/><br/>
The md5mesh file is ok, the model looks like expected, but even&#13;
<br/>
with the new viewer code (with which the imp model works) that&#13;
<br/>
fish looks kind of strange.&#13;
<br/><br/>
Kind regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53196" date="Posted: Sat Sep 25, 2004 7:02 pm    Post subject: "><author>bozo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,&#13;
<br/>
and the anim are strange, so it's the model not the code,&#13;
<br/>
it's not an good sample to test with to build a viewer</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53306" date="Posted: Sun Sep 26, 2004 10:24 am    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.&#13;
<br/>
I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.&#13;
<br/><br/>
So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>exporter script's readme.txt wrote:</b></span></td>	</tr><tr><td class="quote">You need to have the patched version of Blender (standard 2.3.4 will NOT work &#13;
<br/>
correctly because of a bug in the Python API). Get that version here:&#13;
<br/><a href="/web/20061013060432/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip" target="_blank">http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip</a>&#13;
<br/></td>	</tr></table><span class="postbody"><br/>_________________<br/><a href="/web/20061013060432/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013060432im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013060432/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="53315" date="Posted: Sun Sep 26, 2004 11:24 am    Post subject: "><author>der_flo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Thanks, i will try to compile blender from cvs and try it again.&#13;
<br/><br/>
Kind Regards&#13;
<br/><br/>
Flo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="63603" date="Posted: Wed Nov 17, 2004 10:13 pm    Post subject: "><author>julienr</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="/web/20061013060432im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/><br/>
tutorial : <a href="/web/20061013060432/http://www.fhtagn.net/index.php?section=md5_tuto1.html" target="_blank">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a>&#13;
<br/>
demo : <a href="/web/20061013060432/http://www.fhtagn.net/archives/md5_tut1.tar.bz2" target="_blank">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)&#13;
<br/><br/>
There's currently no model in the demo, since i haven't found any freely redistribuable one...</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="65745" date="Posted: Thu Dec 02, 2004 10:23 am    Post subject: "><author>boomcannon</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:&#13;
<br/><br/>
3c4&#13;
<br/>
&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)&#13;
<br/>
---&#13;
<br/>
&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)&#13;
<br/><br/>
Look at the y-term of the vector in each (my prog is the top).&#13;
<br/><br/>
And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).&#13;
<br/><br/>
Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="66268" date="Posted: Sat Dec 04, 2004 11:43 pm    Post subject: "><author>boomcannon</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.&#13;
<br/><br/>
A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.&#13;
<br/><br/>
Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)&#13;
<br/><br/>
Keep Coding...laterz</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="67311" date="Posted: Sun Dec 12, 2004 1:40 am    Post subject: "><author>Sfpiano</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
for all joints&#13;
<br/>
newPos = baseframe.pos;&#13;
<br/>
newQuat = baseframe.quat;&#13;
<br/><br/>
go through the bitflag, update if necessary&#13;
<br/>
build w component of quat&#13;
<br/><br/>
Normalize quat&#13;
<br/><br/>
if( no parent ) {&#13;
<br/>
   joint[i].vPos = newPos;&#13;
<br/>
   joint[i].QuatRot = newQuat;&#13;
<br/>
   Build joint matrix from quat&#13;
<br/>
}&#13;
<br/>
else { // Parent&#13;
<br/>
   Build joint matrix from quat&#13;
<br/>
   joint.mat *= parent.mat&#13;
<br/>
        joint.pos = newPos transformed by builtMatrix&#13;
<br/>
        joint.pos += parent.pos;&#13;
<br/>
}</td>	</tr></table><span class="postbody"/><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100020" date="Posted: Mon Jun 20, 2005 6:51 pm    Post subject: "><author>Dhenry</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.&#13;
<br/><br/>
How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100116" date="Posted: Tue Jun 21, 2005 3:00 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.<br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054954/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100174" date="Posted: Tue Jun 21, 2005 6:56 pm    Post subject: "><author>Dhenry</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Thanks !!!&#13;
<br/><br/>
I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="/web/20061013054954im_/http://doom3world.org/phpbb2/images/smiles/icon_smile.gif" alt="Smile" border="0"/><br/><br/>
Here's my own function I use for pre-computing the normals (if it can help others):&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">// --------------------------------------------------------------------------&#13;
<br/>
// Md5Mesh::computeWeightNormals&#13;
<br/>
//&#13;
<br/>
// der_ton said:&#13;
<br/>
//&#13;
<br/>
// * First you have to get the bind-pose model-space normals by calculating&#13;
<br/>
//   them from the model geometry in bind-pose.&#13;
<br/>
//&#13;
<br/>
// * Then you calculate the weight's normal (which is in bone-space) by&#13;
<br/>
//   invert-transforming the normal by the bone-space matrix.&#13;
<br/>
//&#13;
<br/>
// * So afterwards when animating, you'll transform the weight normal with&#13;
<br/>
//   the animated bone-space matrix and add them all up and you'll get&#13;
<br/>
//   back your animated vertex normal.&#13;
<br/>
// --------------------------------------------------------------------------&#13;
<br/><br/>
void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )&#13;
<br/>
{&#13;
<br/>
  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );&#13;
<br/>
  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );&#13;
<br/><br/>
  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {&#13;
<br/>
   // Zero out final vertex position and final vertex normal&#13;
<br/>
   bindposeVerts[i] = kZeroVectorf;&#13;
<br/>
   bindposeNorms[i] = kZeroVectorf;&#13;
<br/><br/>
   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {&#13;
<br/>
     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];&#13;
<br/>
     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );&#13;
<br/><br/>
     // Calculate transformed vertex for this weight&#13;
<br/>
     Vector3f wv = pWeight-&gt;pos;&#13;
<br/>
     pJoint-&gt;orient.rotate( wv );&#13;
<br/><br/>
     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;&#13;
<br/>
   }&#13;
<br/>
  }&#13;
<br/><br/>
  // Compute triangle normals&#13;
<br/>
  for( unsigned int i = 0; i &lt; _numTris; ++i ) {&#13;
<br/>
   const Md5Triangle_t *pTri = _tris[i];&#13;
<br/><br/>
   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],&#13;
<br/>
      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );&#13;
<br/><br/>
   for( int j = 0; j &lt; 3; ++j ) {&#13;
<br/>
     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;&#13;
<br/>
   }&#13;
<br/>
  }&#13;
<br/><br/>
  // "Average" the surface normals, by normalizing them&#13;
<br/>
  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {&#13;
<br/>
   bindposeNorms[i].normalize();&#13;
<br/>
  }&#13;
<br/><br/>
  //&#13;
<br/>
  // At this stage we have all vertex normals computed&#13;
<br/>
  // for the model geometry in bind-pos&#13;
<br/>
  //&#13;
<br/><br/>
  // Zero out all weight normals&#13;
<br/>
  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {&#13;
<br/>
   _weights[i]-&gt;norm = kZeroVectorf;&#13;
<br/>
  }&#13;
<br/><br/>
  // Compute weight normals by invert-transforming the normal&#13;
<br/>
  // by the bone-space matrix&#13;
<br/>
  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {&#13;
<br/>
   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {&#13;
<br/>
     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];&#13;
<br/>
     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );&#13;
<br/><br/>
     Vector3f wn = bindposeNorms[i];&#13;
<br/><br/>
     // Compute inverse quaternion rotation&#13;
<br/>
     Quaternionf invRot = Inverse( pJoint-&gt;orient );&#13;
<br/>
     invRot.rotate( wn );&#13;
<br/><br/>
     pWeight-&gt;norm += wn;&#13;
<br/>
   }&#13;
<br/>
  }&#13;
<br/><br/>
  // Normalize all weight normals&#13;
<br/>
  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {&#13;
<br/>
   _weights[i]-&gt;norm.normalize();&#13;
<br/>
  }&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
I will post a link to download my MD5 viewer source code when it will be more or less finished.&#13;
<br/><br/><img src="/web/20061013054954im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" border="0"/><br/><br/><img src="/web/20061013054954im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" border="0"/></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100213" date="Posted: Tue Jun 21, 2005 9:32 pm    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"/><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Dhenry wrote:</b></span></td>	</tr><tr><td class="quote">I will post a link to download my MD5 viewer source code when it will be more or less finished. </td>	</tr></table><span class="postbody">&#13;
<br/>
Very cool, thanks!<br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054954/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100229" date="Posted: Tue Jun 21, 2005 10:43 pm    Post subject: "><author>rich_is_bored</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?&#13;
<br/><br/>
I suppose I could write up an article for MD5Camera.<br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/>  Staff</a>&#13;
<br/>
Learn something today? Why not write an article about it on <a href="/web/20061013054954/http://www.modwiki.net/wiki/Main_Page" target="_blank" class="postlink">modwiki.net</a>?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100254" date="Posted: Wed Jun 22, 2005 3:26 am    Post subject: "><author>rich_is_bored</author><body><![CDATA[<tr><td colspan="2"><span class="postbody"><a href="/web/20061013054954/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29" target="_blank">http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29</a>&#13;
<br/><br/>
Done.<br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/>  Staff</a>&#13;
<br/>
Learn something today? Why not write an article about it on <a href="/web/20061013054954/http://www.modwiki.net/wiki/Main_Page" target="_blank" class="postlink">modwiki.net</a>?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100431" date="Posted: Thu Jun 23, 2005 6:51 am    Post subject: "><author>rich_is_bored</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.&#13;
<br/><br/><a href="/web/20061013054954/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29" target="_blank">http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29</a>&#13;
<br/><a href="/web/20061013054954/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29" target="_blank">http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29</a>&#13;
<br/><a href="/web/20061013054954/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29" target="_blank">http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29</a>&#13;
<br/><br/>
I need you guys' help please.&#13;
<br/><br/>
There's a cookie in it for you. Mmmmmm. <img src="/web/20061013054954im_/http://doom3world.org/phpbb2/images/smiles/icon_lol.gif" alt="Laughing" border="0"/><br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/>  Staff</a>&#13;
<br/>
Learn something today? Why not write an article about it on <a href="/web/20061013054954/http://www.modwiki.net/wiki/Main_Page" target="_blank" class="postlink">modwiki.net</a>?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="100465" date="Posted: Thu Jun 23, 2005 10:53 am    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="/web/20061013054954im_/http://doom3world.org/phpbb2/images/smiles/icon_wink.gif" alt="Wink" border="0"/><br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054954/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="107381" date="Posted: Mon Aug 08, 2005 5:59 pm    Post subject: "><author>reklipz</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hey guys.&#13;
<br/><br/>
I'm currently in the middle of writing an anim loader for my viewer&#13;
<br/><br/>
Heres my questions:&#13;
<br/><br/>
I am trying to render the baseframe of the animation, just so that i know i get my calcs right&#13;
<br/><br/>
I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">if thisJoint has a parent&#13;
<br/>
   build the matrix from this joints parents quat values;&#13;
<br/>
   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;&#13;
<br/>
   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</td>	</tr></table><span class="postbody">&#13;
<br/><br/>
something seems to be Very wrong&#13;
<br/><br/>
if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="107642" date="Posted: Wed Aug 10, 2005 5:58 pm    Post subject: "><author>Dhenry</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.&#13;
<br/><br/>
For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:&#13;
<br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">if thisJoint has a parent {&#13;
<br/>
   build the matrix from this joints parents quat values;&#13;
<br/>
   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;&#13;
<br/>
   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span>&#13;
<br/>
}</td>	</tr></table><span class="postbody">&#13;
<br/>
Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means âconcatenationâ, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</span><span class="gensmall"><br/><br/>Last edited by Dhenry on Thu Sep 29, 2005 12:33 pm; edited 1 time in total</span></td>
			</tr>]]></body></post><post id="107643" date="Posted: Wed Aug 10, 2005 6:12 pm    Post subject: "><author>Dhenry</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Ok my own MD5 viewer seems to be quite advanced:&#13;
<br/><img src="/web/20061013054954im_/http://tfc.duke.free.fr/screens/md5loader.png" border="0"/><br/><br/>
I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...&#13;
<br/><br/>
Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)&#13;
<br/>
It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).&#13;
<br/><br/>
You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)&#13;
<br/><br/>
for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</span><span class="gensmall"><br/><br/>Last edited by Dhenry on Thu Mar 02, 2006 9:48 pm; edited 1 time in total</span></td>
			</tr>]]></body></post><post id="122901" date="Posted: Fri Nov 25, 2005 5:15 am    Post subject: questions"><author>mcamilo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hello guys,&#13;
<br/><br/>
1. Sorry by my poor english&#13;
<br/><br/>
2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis&#13;
<br/><br/>
3. I have won on make a viewer thanks of information posted on this thread. &#13;
<br/><br/>
But I have many questions, maybe you could help me:&#13;
<br/><br/>
a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?&#13;
<br/><br/>
b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? &#13;
<br/><br/>
c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation donÂ´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?&#13;
<br/><br/>
d. How is treated problems like collision? For instance, if a animation result in a collision before itÂ´s finished. What is done? The animation is stopped, or itÂ´s is shifted so as the model in each pose never enter a wall?&#13;
<br/><br/>
e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?&#13;
<br/><br/>
One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. &#13;
<br/><br/>
If any of you could answer my questions or point some site or article I could read I would be very happy.<br/>_________________<br/>MÃ¡rcio Camilo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="122963" date="Posted: Fri Nov 25, 2005 5:38 pm    Post subject: Re: questions"><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Welcome to the forum!&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>mcamilo wrote:</b></span></td>	</tr><tr><td class="quote">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</td>	</tr></table><span class="postbody">&#13;
<br/>
Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.&#13;
<br/><br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </td>	</tr></table><span class="postbody">&#13;
<br/>
That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation donÂ´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</td>	</tr></table><span class="postbody">&#13;
<br/>
Yes I think that's what they do, interpolation.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">d. How is treated problems like collision? For instance, if a animation result in a collision before itÂ´s finished. What is done? The animation is stopped, or itÂ´s is shifted so as the model in each pose never enter a wall?</td>	</tr></table><span class="postbody">&#13;
<br/>
I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Quote:</b></span></td>	</tr><tr><td class="quote">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</td>	</tr></table><span class="postbody">&#13;
<br/>
The bounding box is specified for each frame in a md5anim.<br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054954/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="123010" date="Posted: Sat Nov 26, 2005 3:39 am    Post subject: Questions 2"><author>mcamilo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Thank you Der_Ton, &#13;
<br/><br/>
I feel I am begining of get it. &#13;
<br/><br/>
But here I go again:&#13;
<br/><br/>
a. Can you say something more about scripting? &#13;
<br/><br/>
b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially thereÂ´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I donÂ´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If itÂ´s was not created by designer, could it be created on the fly?&#13;
<br/><br/>
c. I agree that it should be the best aproach. &#13;
<br/><br/>
d. Yes, yes very good.  &#13;
<br/><br/>
I thatÂ´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?&#13;
<br/><br/>
One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.<br/>_________________<br/>MÃ¡rcio Camilo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="123053" date="Posted: Sat Nov 26, 2005 10:32 am    Post subject: "><author>der_ton</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. &#13;
<br/><br/>
b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.&#13;
<br/>
For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.<br/>_________________<br/><a href="/web/20061013054954/http://www.doom3world.org/" target="_blank" class="postlink"><img src="/web/20061013054954im_/http://www.doom3world.org/site/img/d3w.gif" border="0"/> Staff</a>&#13;
<br/><a href="/web/20061013054954/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" target="_blank" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="123252" date="Posted: Mon Nov 28, 2005 5:11 am    Post subject: Questions forever"><author>mcamilo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hello, &#13;
<br/><br/>
Thanks one more time Der_Ton. &#13;
<br/><br/>
About the scripts I will look up the information where you pointed. &#13;
<br/><br/>
Sorry I think I am still lost about the transitions between two animations. If I understood what YouÂ´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?&#13;
<br/><br/>
But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. &#13;
<br/><br/>
Because I canÂ´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    &#13;
<br/><br/>
What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?&#13;
<br/><br/>
How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. &#13;
<br/><br/>
(Sorry I know my english are killing you)&#13;
<br/><br/>
Thank for the attention.<br/>_________________<br/>MÃ¡rcio Camilo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="123913" date="Posted: Fri Dec 02, 2005 1:24 pm    Post subject: Shadow volume"><author>Groove</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. &#13;
<br/><br/>
He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?&#13;
<br/><br/>
The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.&#13;
<br/><img src="/web/20061013054954im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" border="0"/><br/><br/>
Anyway, I have build me own md5 files using notepad:&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
MD5Version 10&#13;
<br/>
commandline ""&#13;
<br/><br/>
numJoints 1&#13;
<br/>
numMeshes 1&#13;
<br/><br/>
joints {&#13;
<br/>
   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //&#13;
<br/>
}&#13;
<br/><br/>
mesh {&#13;
<br/>
   shader "undefined"&#13;
<br/><br/>
   numverts 8&#13;
<br/>
   vert 0 ( 0.0000000000 0.0000000000 ) 0 1&#13;
<br/>
   vert 1 ( 0.0000000000 0.0000000000 ) 1 1&#13;
<br/>
   vert 2 ( 0.0000000000 1.0000000000 ) 2 1&#13;
<br/>
   vert 3 ( 0.0000000000 1.0000000000 ) 3 1&#13;
<br/>
   vert 4 ( 1.0000000000 0.0000000000 ) 4 1&#13;
<br/>
   vert 5 ( 1.0000000000 0.0000000000 ) 5 1&#13;
<br/>
   vert 6 ( 1.0000000000 1.0000000000 ) 6 1&#13;
<br/>
   vert 7 ( 1.0000000000 1.0000000000 ) 7 1&#13;
<br/><br/>
   numtris 12&#13;
<br/>
   tri 0 0 4 6&#13;
<br/>
   tri 1 0 6 2&#13;
<br/>
   tri 2 4 5 7&#13;
<br/>
   tri 3 4 7 6&#13;
<br/>
   tri 4 2 6 7&#13;
<br/>
   tri 5 2 7 3&#13;
<br/>
   tri 6 1 0 2&#13;
<br/>
   tri 7 1 2 3&#13;
<br/>
   tri 8 5 1 3&#13;
<br/>
   tri 9 5 3 7&#13;
<br/>
   tri 10 1 5 4&#13;
<br/>
   tri 11 1 4 0&#13;
<br/><br/>
   numweights 8&#13;
<br/>
   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )&#13;
<br/>
   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )&#13;
<br/>
   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )&#13;
<br/>
   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )&#13;
<br/>
   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )&#13;
<br/>
   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )&#13;
<br/>
   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )&#13;
<br/>
   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
And it work, I have generate the shadow volume from the MD5 file: &#13;
<br/><img src="/web/20061013054954im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" border="0"/><br/><br/>
But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?&#13;
<br/><br/>
When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.&#13;
<br/><br/><img src="/web/20061013054954im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" border="0"/><br/><br/>
To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"&#13;
<br/><br/>
My algorithm is:&#13;
<br/><br/></span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr><td><span class="genmed"><b>Code:</b></span></td>	</tr><tr><td class="code">&#13;
<br/>
void md5Mesh::_buildEdges()&#13;
<br/>
{&#13;
<br/>
    if(m_EdgeArray != null)&#13;
<br/>
        delete[] m_EdgeArray;&#13;
<br/>
    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];&#13;
<br/><br/>
    m_EdgesNumber = 0;&#13;
<br/><br/>
    md5Edge* pEdge = m_EdgeArray;&#13;
<br/><br/>
    // Find edges&#13;
<br/>
    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)&#13;
<br/>
    {&#13;
<br/>
        int i1 = m_IndiceArray[i + 0];&#13;
<br/>
        int i2 = m_IndiceArray[i + 1];&#13;
<br/>
        int i3 = m_IndiceArray[i + 2];&#13;
<br/><br/>
        if(i1 &lt; i2)&#13;
<br/>
        {&#13;
<br/>
            md5Edge Edge;&#13;
<br/>
            pEdge-&gt;VertexIndex[0] = i1;&#13;
<br/>
            pEdge-&gt;VertexIndex[1] = i2;&#13;
<br/>
            pEdge-&gt;TriangleIndex[0] = i;&#13;
<br/>
            pEdge-&gt;TriangleIndex[1] = -1;&#13;
<br/>
            pEdge++;&#13;
<br/>
            m_EdgesNumber++;&#13;
<br/>
        }&#13;
<br/><br/>
        if(i2 &lt; i3)&#13;
<br/>
        {&#13;
<br/>
            pEdge-&gt;VertexIndex[0] = i2;&#13;
<br/>
            pEdge-&gt;VertexIndex[1] = i3;&#13;
<br/>
            pEdge-&gt;TriangleIndex[0] = i;&#13;
<br/>
            pEdge-&gt;TriangleIndex[1] = -1;&#13;
<br/>
            pEdge++;&#13;
<br/>
            m_EdgesNumber++;&#13;
<br/>
        }&#13;
<br/><br/>
        if(i3 &lt; i1)&#13;
<br/>
        {&#13;
<br/>
            pEdge-&gt;VertexIndex[0] = i3;&#13;
<br/>
            pEdge-&gt;VertexIndex[1] = i1;&#13;
<br/>
            pEdge-&gt;TriangleIndex[0] = i;&#13;
<br/>
            pEdge-&gt;TriangleIndex[1] = -1;&#13;
<br/>
            pEdge++;&#13;
<br/>
            m_EdgesNumber++;&#13;
<br/>
        }&#13;
<br/>
    }&#13;
<br/><br/>
    // Match triangles to edges&#13;
<br/>
    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)&#13;
<br/>
    {&#13;
<br/>
        int i1 = m_IndiceArray[i + 0];&#13;
<br/>
        int i2 = m_IndiceArray[i + 1];&#13;
<br/>
        int i3 = m_IndiceArray[i + 2];&#13;
<br/><br/>
        if(i1 &gt; i2)&#13;
<br/>
        {&#13;
<br/><br/>
            pEdge = m_EdgeArray;&#13;
<br/>
            for(uint j = 0; j &lt; m_EdgesNumber; ++j)&#13;
<br/>
            {&#13;
<br/>
                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;TriangleIndex[1] == -1))&#13;
<br/>
                {&#13;
<br/>
                    int Tri0 = pEdge-&gt;TriangleIndex[0];&#13;
<br/>
                    pEdge-&gt;TriangleIndex[1] = i;&#13;
<br/>
                    break;&#13;
<br/>
                }&#13;
<br/>
                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;TriangleIndex[1] != -1))&#13;
<br/>
                {&#13;
<br/>
                    fprintf(stderr, "Triple edge ...\n");&#13;
<br/>
                }&#13;
<br/><br/>
                pEdge++;&#13;
<br/>
            }&#13;
<br/>
        }&#13;
<br/><br/>
        if(i2 &gt; i3)&#13;
<br/>
        {&#13;
<br/><br/>
            pEdge = m_EdgeArray;&#13;
<br/>
            for(uint j = 0; j &lt; m_EdgesNumber; ++j)&#13;
<br/>
            {&#13;
<br/>
                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;TriangleIndex[1] == -1))&#13;
<br/>
                {&#13;
<br/>
                    int Tri0 = pEdge-&gt;TriangleIndex[0];&#13;
<br/>
                    pEdge-&gt;TriangleIndex[1] = i;&#13;
<br/>
                    break;&#13;
<br/>
                }&#13;
<br/>
                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;TriangleIndex[1] != -1))&#13;
<br/>
                {&#13;
<br/>
                    fprintf(stderr, "Triple edge ...\n");&#13;
<br/>
                }&#13;
<br/><br/>
                pEdge++;&#13;
<br/>
            }&#13;
<br/>
        }&#13;
<br/><br/>
        if(i3 &gt; i1)&#13;
<br/>
        {&#13;
<br/><br/>
            pEdge = m_EdgeArray;&#13;
<br/>
            for(uint j = 0; j &lt; m_EdgesNumber; ++j)&#13;
<br/>
            {&#13;
<br/>
                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;TriangleIndex[1] == -1))&#13;
<br/>
                {&#13;
<br/>
                    int Tri0 = pEdge-&gt;TriangleIndex[0];&#13;
<br/>
                    pEdge-&gt;TriangleIndex[1] = i;&#13;
<br/>
                    break;&#13;
<br/>
                }&#13;
<br/>
                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;&#13;
<br/>
                   (pEdge-&gt;TriangleIndex[1] != -1))&#13;
<br/>
                {&#13;
<br/>
                    fprintf(stderr, "Triple edge ...\n");&#13;
<br/>
                }&#13;
<br/><br/>
                pEdge++;&#13;
<br/>
            }&#13;
<br/>
        }&#13;
<br/>
    }&#13;
<br/><br/>
   int openEdge = 0;&#13;
<br/>
   for(uint i = 0; i &lt; m_EdgesNumber; i++)&#13;
<br/>
   {&#13;
<br/>
      if(m_EdgeArray[i].TriangleIndex[1] == -1)&#13;
<br/>
         openEdge++;&#13;
<br/>
   }&#13;
<br/><br/>
    fprintf(stderr, "openEdge : %d\n", openEdge);&#13;
<br/>
}&#13;
<br/></td>	</tr></table><span class="postbody">&#13;
<br/><br/>
And this Doom3 MD5 allmost of all edges are count in openEdge...&#13;
<br/><br/>
So my question: How to create edges to MD5 files?</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="134415" date="Posted: Fri Feb 24, 2006 7:36 am    Post subject: doom3 animation models"><author>mcamilo</author><body><![CDATA[<tr><td colspan="2"><span class="postbody">Hi,&#13;
<br/><br/>
first I have to say sorry about my poor english.&#13;
<br/><br/>
second I have to say sorry about my newbies questions.  &#13;
<br/><br/>
I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. &#13;
<br/><br/>
I have succeed in load mesh and anim files and play the animations through this framework&#13;
<br/><br/>
My doubts are about how doom3 handle the transition between two animations?&#13;
<br/><br/>
How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?&#13;
<br/><br/>
How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?&#13;
<br/><br/>
I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3Â´s code?&#13;
<br/><br/>
It has something with the "rag dolls" working? In time what are rag dolls? ItÂ´s a kind of configuration file to handle the .mesh and .anim files? Or what?&#13;
<br/><br/>
What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?<br/>_________________<br/>MÃ¡rcio Camilo</span><span class="gensmall"/></td>
			</tr>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 3:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...
<br />the new formats of the md5mesh and md5anim files
<br /><br />i have take a first look on it and will post here what i have found out, it is not complete
<br /><br />so, start with some excerpts of two example files, i choose the imp:
<br /><br />imp.md5mesh
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>
<br /><br />first the name of the joint
<br /><br />than the parentjoint index
<br /><br />next the flag that tells whitch components are animated in the frames:
<br /><br />six possible components - translation x y z and orientation x y z
<br /><br />one bit for each component:
<br /><br />bit 0 - 1  =&gt; translation x
<br />bit 1 - 2  =&gt; translation y
<br />bit 2 - 4  =&gt; translation z
<br />bit 3 - 8  =&gt; orientation x
<br />bit 4 - 16 =&gt; orientation y
<br />bit 5 - 32 =&gt; orientation z
<br /><br />ie:
<br />56 =&gt; 8+16+32 -&gt; alle three orientation values
<br />6 =&gt; 2+4 -&gt; translation y and z
<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,
<br />the count of animated components are indicated by the preceding flag
<br /><br /><span style="font-weight: bold">bounds:</span>
<br /><br />numFrames entries
<br />min x y z and max x y z
<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)
<br /><br /><span style="font-weight: bold">baseframe:</span>
<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)
<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints
<br /><br /><span style="font-weight: bold">frame:</span>
<br /><br />numAnimatedComponents entries
<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily
<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 5:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>
<br />The w component of the quaternions have to be negated, yep:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Thu Aug 05, 2004 12:27 am "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 1:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!
<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 4:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 5:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.
<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>
<br /><br />But I'm not sure if the result is the correct. Look this image:
<br /><br /><img src="https://web.archive.org/web/20101225023028im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.
<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.
<br /><br />BTW, I'm also interested on how the other coders handle this.
<br /><br />Happy coding! <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 6:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)
<br /><br /><img src="https://web.archive.org/web/20101225023028im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 7:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 12:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>
<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos
<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,
<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),
<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)
<br /><br />i dont try the new fileformat at present,
<br />but now the hierarchy info is also in the md5anim files,
<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 3:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>
<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.
<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 6:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?
<br /><br />example:
<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )
<br />Qx and Qy are animated components:
<br />frame 14:  -0.8022928834 0.5969305038
<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 12:13 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton
<br /><br />i didn't try the new md5anim format currently,
<br />but in a other own project, i had troubles that sounds like yours,
<br />here is what i did:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 5:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:
<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )
<br />-Mesh Data ( verts &amp; tris &amp; weights )
<br /><br />Some questions:
<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?
<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? 
<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?
<br /><br />4. Im not sure what weights are.. can i get a primer real quick?
<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?
<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? 
<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 5:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>
<br />1st param -&gt; triangle index
<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)
<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 6:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.
<br /><br />Just a few more questions though, if you guys dont mind:
<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? 
<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?
<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?
<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 7:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>
<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).
<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 7:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20101225023028im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Sat Aug 21, 2004 12:41 am "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 1:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:
<br /><br /><a href="https://web.archive.org/web/20101225023028/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>
<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 2:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20101225023028/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  
<br /><br />Greets.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 1:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 6:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225014402/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 7:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225014402/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 2:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20101225014402im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 3:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 12:57 pm "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20101225014402/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 6:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 8:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 5:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 3:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 2:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 7:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 7:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 1:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 6:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225014402/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 7:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225014402/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 2:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20101225014402im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 3:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 12:57 pm "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20101225014402/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 6:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 8:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 5:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20101225014402im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 3:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 2:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 7:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 7:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 3:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...
<br />the new formats of the md5mesh and md5anim files
<br /><br />i have take a first look on it and will post here what i have found out, it is not complete
<br /><br />so, start with some excerpts of two example files, i choose the imp:
<br /><br />imp.md5mesh
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>
<br /><br />first the name of the joint
<br /><br />than the parentjoint index
<br /><br />next the flag that tells whitch components are animated in the frames:
<br /><br />six possible components - translation x y z and orientation x y z
<br /><br />one bit for each component:
<br /><br />bit 0 - 1  =&gt; translation x
<br />bit 1 - 2  =&gt; translation y
<br />bit 2 - 4  =&gt; translation z
<br />bit 3 - 8  =&gt; orientation x
<br />bit 4 - 16 =&gt; orientation y
<br />bit 5 - 32 =&gt; orientation z
<br /><br />ie:
<br />56 =&gt; 8+16+32 -&gt; alle three orientation values
<br />6 =&gt; 2+4 -&gt; translation y and z
<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,
<br />the count of animated components are indicated by the preceding flag
<br /><br /><span style="font-weight: bold">bounds:</span>
<br /><br />numFrames entries
<br />min x y z and max x y z
<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)
<br /><br /><span style="font-weight: bold">baseframe:</span>
<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)
<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints
<br /><br /><span style="font-weight: bold">frame:</span>
<br /><br />numAnimatedComponents entries
<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily
<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 5:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>
<br />The w component of the quaternions have to be negated, yep:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Thu Aug 05, 2004 12:27 am "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 1:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!
<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 4:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 5:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.
<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>
<br /><br />But I'm not sure if the result is the correct. Look this image:
<br /><br /><img src="https://web.archive.org/web/20101225022041im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.
<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.
<br /><br />BTW, I'm also interested on how the other coders handle this.
<br /><br />Happy coding! <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 6:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)
<br /><br /><img src="https://web.archive.org/web/20101225022041im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 7:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 12:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>
<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos
<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,
<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),
<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)
<br /><br />i dont try the new fileformat at present,
<br />but now the hierarchy info is also in the md5anim files,
<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 3:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>
<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.
<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 6:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?
<br /><br />example:
<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )
<br />Qx and Qy are animated components:
<br />frame 14:  -0.8022928834 0.5969305038
<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 12:13 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton
<br /><br />i didn't try the new md5anim format currently,
<br />but in a other own project, i had troubles that sounds like yours,
<br />here is what i did:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 5:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:
<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )
<br />-Mesh Data ( verts &amp; tris &amp; weights )
<br /><br />Some questions:
<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?
<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? 
<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?
<br /><br />4. Im not sure what weights are.. can i get a primer real quick?
<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?
<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? 
<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 5:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>
<br />1st param -&gt; triangle index
<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)
<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 6:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.
<br /><br />Just a few more questions though, if you guys dont mind:
<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? 
<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?
<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?
<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 7:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>
<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).
<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 7:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Sat Aug 21, 2004 12:41 am "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 1:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:
<br /><br /><a href="https://web.archive.org/web/20101225022041/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>
<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 2:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  
<br /><br />Greets.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 1:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 6:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023612/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 7:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023612/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 2:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20101225023612im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 3:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 12:57 pm "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20101225023612/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 6:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 8:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 5:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 3:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 2:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 7:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 7:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 3:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 8:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 9:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 9:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 9:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20101225022519/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 10:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 11:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 4:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 5:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 5:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 5:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 5:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 6:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 6:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 7:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 8:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225022519/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 12:24 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 11:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20101225022519/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20101225022519/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 11:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p66268" date="Posted: Sun Dec 05, 2004 12:43 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 2:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 7:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 4:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 7:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20101225023538im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20101225023538im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20101225023538im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 10:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 11:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 4:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 7:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20101225023538im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 11:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20101225023538im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 6:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 6:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 7:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20101225023538im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 6:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 6:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 4:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 11:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 6:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 2:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20101225023538im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20101225023538im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20101225023538im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 8:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...
<br />the new formats of the md5mesh and md5anim files
<br /><br />i have take a first look on it and will post here what i have found out, it is not complete
<br /><br />so, start with some excerpts of two example files, i choose the imp:
<br /><br />imp.md5mesh
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>
<br /><br />first the name of the joint
<br /><br />than the parentjoint index
<br /><br />next the flag that tells whitch components are animated in the frames:
<br /><br />six possible components - translation x y z and orientation x y z
<br /><br />one bit for each component:
<br /><br />bit 0 - 1  =&gt; translation x
<br />bit 1 - 2  =&gt; translation y
<br />bit 2 - 4  =&gt; translation z
<br />bit 3 - 8  =&gt; orientation x
<br />bit 4 - 16 =&gt; orientation y
<br />bit 5 - 32 =&gt; orientation z
<br /><br />ie:
<br />56 =&gt; 8+16+32 -&gt; alle three orientation values
<br />6 =&gt; 2+4 -&gt; translation y and z
<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,
<br />the count of animated components are indicated by the preceding flag
<br /><br /><span style="font-weight: bold">bounds:</span>
<br /><br />numFrames entries
<br />min x y z and max x y z
<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)
<br /><br /><span style="font-weight: bold">baseframe:</span>
<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)
<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints
<br /><br /><span style="font-weight: bold">frame:</span>
<br /><br />numAnimatedComponents entries
<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily
<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>
<br />The w component of the quaternions have to be negated, yep:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!
<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.
<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>
<br /><br />But I'm not sure if the result is the correct. Look this image:
<br /><br /><img src="https://web.archive.org/web/20081119155114im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.
<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.
<br /><br />BTW, I'm also interested on how the other coders handle this.
<br /><br />Happy coding! <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)
<br /><br /><img src="https://web.archive.org/web/20081119155114im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>
<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos
<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,
<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),
<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)
<br /><br />i dont try the new fileformat at present,
<br />but now the hierarchy info is also in the md5anim files,
<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>
<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.
<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?
<br /><br />example:
<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )
<br />Qx and Qy are animated components:
<br />frame 14:  -0.8022928834 0.5969305038
<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton
<br /><br />i didn't try the new md5anim format currently,
<br />but in a other own project, i had troubles that sounds like yours,
<br />here is what i did:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:
<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )
<br />-Mesh Data ( verts &amp; tris &amp; weights )
<br /><br />Some questions:
<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?
<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? 
<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?
<br /><br />4. Im not sure what weights are.. can i get a primer real quick?
<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?
<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? 
<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>
<br />1st param -&gt; triangle index
<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)
<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.
<br /><br />Just a few more questions though, if you guys dont mind:
<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? 
<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?
<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?
<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>
<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).
<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20081119155114im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:
<br /><br /><a href="https://web.archive.org/web/20081119155114/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>
<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20081119155114/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  
<br /><br />Greets.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120515/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120515/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120515im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120515/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120515/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p40328" date="Posted: Mon Aug 23, 2004 2:16 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">I had read over that particular problem and proposed solution, but since it was md5anim-related, I couldn't see a way to apply it to the problems I'm having.  I checked to make sure I'm generating the w-component properly, to make sure it's a unit quaternion, and even checked to make sure I'm not getting negative values inside the square root when calculating ot, so I'm fairly sure it's not that.  But, then again, I can't honestly say I understand quaternions so I could be doing something horribly wrong.</div>]]></body></post><post id="p40411" date="Posted: Mon Aug 23, 2004 8:31 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">The problem has been corrected.  It was a difference in quaternion-&gt;bind matrix formula that I had found.</div>]]></body></post><post id="p40458" date="Posted: Mon Aug 23, 2004 12:45 pm "><author>Coder</author><body><![CDATA[<div class="postbody">Hi everyone!!!
<br /><br />I have source code ( created by myself <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" />) of md5mesh/md5anim viewer. If someone wanna have it - mail me : <!-- e --><a href="mailto:coderserg@mail.ru">coderserg@mail.ru</a><!-- e -->
<br /><br />But thats not all! I have a question.
<br /><br />The new md5anim format using quaternions for rotations.
<br />In my project I convert all pos and quat values to matrices and using it to represent bone transformations.
<br />But I collide with a problem then I try to use quaternions and position separately. Exactly from quaternions values, 'couse with matrices all works perfectly.
<br />this code works correct:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vector_t pos = ... read from file...<br />quaternion_t q = ... read from file ...<br />q.w = -(float) sqrt(... and so on :)<br /><br />md5bone_t *pbone = ... current bone...<br />pbone-&gt;m = translate(pos) * q.tomatrix();<br />if(pbone-&gt;pparent)<br />  pbone-&gt;m *= pbone-&gt;pparent-&gt;m;<br /></div><br />Next...<br />What I'm doing:<br />All rotations values, in md5anim, describe rotations about parent bone. So to get rotation in world coordinate system we need to multiply parent quaternion on child quaternion.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />md5bone_t   pbone   = &amp;pbones[ibone];<br />md5bone_t   pparent = pbone-&gt;pparent;<br />quaternion_t &amp;qbone = pbone-&gt;q;<br />if( pparent )<br /> qbone = pparent-&gt;q * qbone;<br />...<br /></div>
<br />Complete datatype definition is not important. I hope that You understand logic of this snip! So is this write??? 'Couse this give wrong result!!
<br />In my own model viewer ( my models format ) this techniqu works correctly.
<br />So whats wrong with quaternions in md5 ( or in my code <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" />).
<br /><br />Thank you.
<br /><br />PS. Sorry for my english <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p40460" date="Posted: Mon Aug 23, 2004 12:49 pm "><author>skynet</author><body><![CDATA[<div class="postbody">You seem to forget that the joint hierarchy is not only a hierarchy of rotations, but also translations. What you need to to is to convert all of the quaternion/position pairs into matrices and accumulate them instead of just the quats.</div>]]></body></post><post id="p40470" date="Posted: Mon Aug 23, 2004 1:14 pm "><author>Coder</author><body><![CDATA[<div class="postbody">So how I can get pure bone rotation(in WCS of course)?
<br />I mean if I want to represent bone, for example, like a box I need to know position and rotation! How I can do this? This is really important! 'Couse in 3dsmax, for example, I can create a bone, but to animate it by keyframes I need positions and rotations defined separately!!!
<br /><br />Thanks.</div>]]></body></post><post id="p40473" date="Posted: Mon Aug 23, 2004 1:20 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@Coder
<br /><br />also instead of 
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">q.w = -(float) sqrt(... and so on :)</div><br /><br />use better this:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div></div>]]></body></post><post id="p40476" date="Posted: Mon Aug 23, 2004 1:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@Coder
<br /><br />like skynet wrote, in md5anim the pos and the rot of the bone are relative to the 
<br />parentbone
<br /><br />you can represent translation (pos) and rotation with matrices
<br />when you use 4x3 dimension or 4x4 matrices than you can build one matrix that does translation and rotation
<br /><br />so you build a localmatrix of the pos and rot of the bone
<br />and multiply this localmatrix with the worldmatrix of the parentbone and the result is the worldmatrix of the bone
<br />than you transfer the vertices with this worldmatrix
<br /><br />3dsmax: that is only the userinterface, intern max use a matrix for the bones</div>]]></body></post><post id="p40557" date="Posted: Mon Aug 23, 2004 3:54 pm "><author>Coder</author><body><![CDATA[<div class="postbody">Ok! I'll try this again ( in 100th time <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" />)
<br /><br />What about 3dsmax can You explain in details?
<br /><br />Thanks.</div>]]></body></post><post id="p40622" date="Posted: Mon Aug 23, 2004 6:13 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@Coder
<br /><br />i don't understand what you really want to know about max
<br /><br />in max you use the ui to work with the models, bones, ....
<br />and max store intern the data of this objects and the state of the workprocess
<br />the data in your example, pos and rot, to be simplified they are stored as a transformationmatrix, in real, there are more than one matrix, because of the different states a obj can be in, ie. the created obj, each modifier applied, spacewarps, ..., to the renderstate
<br />but this is not important to know to export a obj from max or when you work on a md5 viewer
<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I mean if I want to represent bone, for example, like a box I need to know position and rotation! How I can do this?</div>
<br /><br />additional to my post before this one, the md5anim gives you the pos and rot of each bone of each frame of the anim, look in the description of the md5 on the top of this thread, but, like i wrote before, they are only local pos and rot infos, so you must nuild the final transformationmatrix, see before, .....</div>]]></body></post><post id="p40940" date="Posted: Tue Aug 24, 2004 7:44 am "><author>Coder</author><body><![CDATA[<div class="postbody">2bozo
<br /><br />Thanks again! But all is not so well as I want <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Thats what I have when I use translation part of bone WM:
<br />pic01
<br />[img]
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064958/http://www.gamedev.ru/images/?id=2014">http://www.gamedev.ru/images/?id=2014</a><!-- m -->
<br />[/img]
<br />And I completly understand this transformations.
<br /><br />But that's what happens than I use primitives to represent a bone:
<br />pic02
<br />[img]
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064958/http://www.gamedev.ru/images/?id=2015">http://www.gamedev.ru/images/?id=2015</a><!-- m -->
<br />[/img]
<br /><br />here is the code that drows this ...
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for(int ibone=0; ibone&lt;nbones; ibone++ )<br />{<br />   md5bone_t *pbone = &amp;pbones[ibone];<br />   vector_t  startpos = pbone-&gt;m.translationpart();      <br />   if(pbone-&gt;pchild)<br />   {<br />      for(int ichild=0; ichild&lt;pbone-&gt;nchild; ichild++ )<br />      {<br />         vector_t endpos = pbone-&gt;pchild[ichild]-&gt;m.translationpart();<br /><br />         float h = 1.0;<br />         float w = 1.0;<br /><br />         float p1 = (endpos - startpos).length();<br />         vertex_t vtx[] =<br />         {<br />            {0,0,0},   {w,-h,h},  {w,h,h},<br />            {0,0,0},   {w,h,h},   {w,h,-h},<br />            {0,0,0},   {w,-h,-h}, {w,-h,h},<br />            {0,0,0},   {w,h,-h},  {w,-h,-h},<br />            {w,h,h},   {w,-h,h},  {p1,0,0},<br />            {w,h,h},   {p1,0,0},  {w,h,-h},<br />            {w,-h,h},  {w,-h,-h}, {p1,0,0},<br />            {w,-h,-h}, {w,h,-h},  {p1,0,0}<br /><br />         };<br />         <br />         glColor3f(0.0f, 1.0f, 0.0f);<br />         glBegin(GL_TRIANGLES);   <br />         for(int i=0; i&lt; sizeof(vtx)/sizeof(vertex_t); i++)<br />         {<br />            vector_t v(vtx[i].x, vtx[i].y, vtx[i].z);<br />            matrix_t m = pbone-&gt;pchild[ichild]-&gt;m;// or pbone-&gt;m = no  difference (wrong result)<br />            v = pbone-&gt;m * v;<br />            glVertex3fv(v.xyz);<br />         }<br />         glEnd();<br /><br />         glColor3f(1.0f, 1.0f, 1.0f);<br />         glBegin(GL_LINES);<br />         {<br />            glVertex3fv(startpos.xyz);<br />            glVertex3fv(endpos.xyz);<br />         }<br />         glEnd();<br />      }<br /><br />   }<br />}<br /></div>
<br /><br />My final inference: The bone WM not in all cases represent full transformation. In some cases bone just make a move in other just rotate.
<br />But if in some frame bone not rotated this doesn't mean that the rotation value is set to 0. This means that the rotaion value in current frame are the same as in previos frame.
<br />Then I was working on my exporter(MAXScript) I used &lt;bone&gt;.rotaion ans &lt;bone&gt;.position values to store transformations. In application I multiply two matrices(pos-&gt;tomatrix and quat-&gt;tomatrix) to represent bone transformation. But there is no problems then I try to use quat and pos separately! I can multily vertex(vector) by quaternion to rotate it and add position vector to translate it.
<br />I'm tring to uderstand all workflow - from model exporting to model rendering in engine.
<br />In 3dsmax bone object have rotaion and position value independently of animation. In any time(as 3dsmax timleslider) is posible to get current pos and rot values for the bone. So why in md5 this happens? (I know that md5 was created in Maya;))
<br /><br />In some cases my caculations going write:
<br />hellknight:
<br />[img]
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064958/http://www.gamedev.ru/images/?id=2016">http://www.gamedev.ru/images/?id=2016</a><!-- m -->
<br />[/img]
<br /><br />I think that this happend 'couse bone matrix contains both pos and rot.
<br /><br />Plaese excuse me for my pestering question, but my recalcitrance don't leting me go <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br />If someone can explain the core of my mistakes, I'll be thankful very much!
<br /><br />Have a nice day! <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p41581" date="Posted: Wed Aug 25, 2004 10:50 am "><author>bozo</author><body><![CDATA[<div class="postbody">to the bonegeom. thing:
<br /><br />your bonegeom. is along the x axis
<br /><br />your transform of the vertices of the bonegeom. with the parentbone or bone matrix only transform your x axis aligned bonegeom. in there coord.sys.
<br /><br />but when you want to draw this bonegeom. as a representation from the parentbone to the bone, you must use the direction od the vector (endpos - startpos)
<br /><br />what you must do is, build from this directionvector a rotation, ie. you could use the dir as the forward vector and create the perpendicular left and up vectors to build a rotationmatrix or build from this directionvector a quaternion that represent this rotation, and then transform the bonegeom.vertices with this matrix/quat and finally add the parentbone (the startpos of the bonegeom.) to this transformed vertices
<br /><br />you can think about this as when you first rotate your bonegeom. to the right direction (bone-parentbone) and then move them to the right place (parentbone pos)
<br /><br /><br /><br />a transformationmatrix represents a full transformation (translation, rotation, scale, shear, perspective, ...), all what you want to do, it only must only push the right data into the matrix
<br /><br />there is no ONE way to represent and work with translations and rotations
<br />so, ie. max let you access the translation and rotation values of the obj's in different kinds, as a matrix, vector, quaternion, euler angles, ...., but they all represent the same translation and rotation
<br />and yes you can use a quat and pos to transform the vertices like you can use a matrix to do this
<br /><br />the md5's have no direct releationship to a specific 3d program
<br />in the md5anim is all data stored that you need to build the transforminfo of the bones for each frame
<br />which way you do this is left to your choice
<br />ie. you could build from the stored local pos and rot a local matrix, and than build the worldmatrix of the bone from his localmatrix and the parentboneworldmatrix or you can build a pos and quat the represent the worldtransformation of the bone from the local pos and quat of the bone and the world pos and quat of the parentbone</div>]]></body></post><post id="p43769" date="Posted: Sun Aug 29, 2004 6:43 pm "><author>sigget</author><body><![CDATA[<div class="postbody">Excellent work bozo! Mind if i link to this post from my page at: 
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064958/http://sigget.rivin.se/games/doom3/index.html">http://sigget.rivin.se/games/doom3/index.html</a><!-- m --></div>]]></body></post><post id="p43905" date="Posted: Sun Aug 29, 2004 11:40 pm "><author>sigget</author><body><![CDATA[<div class="postbody">I went ahead and added that link, hope that's okay.</div>]]></body></post><post id="p44099" date="Posted: Mon Aug 30, 2004 10:45 am "><author>bozo</author><body><![CDATA[<div class="postbody">@sigget
<br />for sure, it's ok
<br />nice site you have created <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p44328" date="Posted: Mon Aug 30, 2004 8:11 pm "><author>sigget</author><body><![CDATA[<div class="postbody">thanks, im hoping to turn it into a complete reference site, lots of work though</div>]]></body></post><post id="p45191" date="Posted: Wed Sep 01, 2004 8:16 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">So I've been working on implementing V10's animation style, and I'm having trouble with the relationship between the baseframe, individual frames, and the parent.  While bozo's specs at the beginning of this thread are amazing in and of themselves, it's not at all specific about how to apply the individual transformations for the animation stuff.  If anyone has a quick way of describing this relationship (i.e. is the frame relative to the baseframe which is relative to the parent?), I'd greatly appreciate the assistance.</div>]]></body></post><post id="p45218" date="Posted: Wed Sep 01, 2004 10:04 am "><author>der_ton</author><body><![CDATA[<div class="postbody">The values in the framedata are not relative, or not incremental. You simply replace the values in the baseframe by the values you extract from the framedata, and the resulting pose will be the one at that frametime.</div>]]></body></post><post id="p45326" date="Posted: Wed Sep 01, 2004 4:14 pm "><author>nohbdy</author><body><![CDATA[<div class="postbody">Darineth:  I'm guessing by that you mean how each joint's entry into the baseframe section is related to the parent joint... The actual animation is simple once you understand how to build the baseframe's skeleton (simple substitution of components, like der_ton said).
<br /><br />Here's some code from my MD5Model/Anim viewer (Which looks totally awesome and I will release here with source once I add a few more features like reading directly from the PK4 files).  It uses D3DX for Vectors(Point3D is a typedef of D3DXVECTOR3) and Quats
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void MD5Anim::BuildSkeletons() {<br />   Point3D transformedPos;<br />   MD5Joint* thisJoint;<br />   MD5Joint* parentJoint;<br />   int parentID = 0;<br /><br />   //First, initialize our base pose skeleton<br />   baseSkeleton = new MD5Skeleton();<br />   baseSkeleton-&gt;SetNumJoints(numJoints);<br />   for (int i = 0; i &lt; numJoints; i++) {<br />      thisJoint = new MD5Joint;<br />      parentID = joints[i].parentID;<br />      parentJoint = baseSkeleton-&gt;GetJoint(parentID);<br />      thisJoint-&gt;ID = i;<br />      if (parentID &lt; 0) { //Has no parent, must be origin<br />         thisJoint-&gt;orientation = baseFrame[i].orientation;<br />         thisJoint-&gt;position = baseFrame[i].position;<br />      } else {<br />         //Transform our translation by our parent's rotation quaternion and add our parent translation<br />         TransformPoint(&amp;transformedPos, &amp;baseFrame[i].position, &amp;parentJoint-&gt;orientation);<br />         thisJoint-&gt;position = transformedPos + parentJoint-&gt;position;<br /><br />         //Rotate our baseFrame orientation by our parent joint's rotation quaternion<br />         thisJoint-&gt;orientation = baseFrame[i].orientation * parentJoint-&gt;orientation; //Order is important!<br />         D3DXQuaternionNormalize(&amp;thisJoint-&gt;orientation,&amp;thisJoint-&gt;orientation);<br />      }<br />      thisJoint-&gt;parent = parentID;<br />      baseSkeleton-&gt;AddJoint(thisJoint);<br />   }<br /><br />   //Then, build each frame skeleton<br />   int bitField = 0;<br />   int currComponent = 0;<br />   Quat animatedOrientation;<br />   Point3D animatedPosition;<br />   frameSkeletons = new MD5SkeletonPtr[numFrames];<br />   for (int i = 0; i &lt; numFrames; i++) {<br />      frameSkeletons[i] = new MD5Skeleton();<br />   }<br />   for (int i = 0; i &lt; numFrames; i++) {<br />      frameSkeletons[i]-&gt;SetNumJoints(numJoints);<br />      currComponent = 0;<br /><br />      for (int j = 0; j &lt; numJoints; j++) {<br />         thisJoint = new MD5Joint;<br />         parentID = joints[j].parentID;<br />         parentJoint = frameSkeletons[i]-&gt;GetJoint(parentID);<br />         thisJoint-&gt;ID = j;<br /><br />         animatedOrientation = baseFrame[j].orientation;<br />         animatedPosition = baseFrame[j].position;<br />         bitField = joints[j].bitField;<br />         if (bitField != 0) {<br />            if (bitField &amp; MD5AnimJoint::Tx) animatedPosition.x = frames[i].animationComponents[currComponent++];<br />            if (bitField &amp; MD5AnimJoint::Ty) animatedPosition.y = frames[i].animationComponents[currComponent++];<br />            if (bitField &amp; MD5AnimJoint::Tz) animatedPosition.z = frames[i].animationComponents[currComponent++];<br />            if (bitField &amp; MD5AnimJoint::Qx) animatedOrientation.x = frames[i].animationComponents[currComponent++];<br />            if (bitField &amp; MD5AnimJoint::Qy) animatedOrientation.y = frames[i].animationComponents[currComponent++];<br />            if (bitField &amp; MD5AnimJoint::Qz) animatedOrientation.z = frames[i].animationComponents[currComponent++];<br />         }<br />         if (parentID &lt; 0) {<br />            thisJoint-&gt;orientation = animatedOrientation;<br />            thisJoint-&gt;position = animatedPosition;<br />         } else {<br />            TransformPoint(&amp;transformedPos, &amp;animatedPosition, &amp;parentJoint-&gt;orientation);<br />            thisJoint-&gt;position = transformedPos + parentJoint-&gt;position;<br /><br />            thisJoint-&gt;orientation = animatedOrientation * parentJoint-&gt;orientation;<br />            D3DXQuaternionNormalize(&amp;thisJoint-&gt;orientation,&amp;thisJoint-&gt;orientation);<br />         }<br />         thisJoint-&gt;parent = parentID;<br />         frameSkeletons[i]-&gt;AddJoint(thisJoint);<br />      }<br />   }<br />   return;<br />}<br /></div><br /><br />To transform the joint's orientation, you just multiply it by it's parent's transformed orientation.<br /><br />Transforming the joint's position is exactly like how the vertices are transformed/skinned to the skeleton, assuming you have that part working.  TransformPoint(Point3D* result,Point3D* position,Quat* rotation) just multiplies the 'position' by the 'rotation' and puts the answer into 'result'.  I don't bother converting to matrix format since it's faster using quaternions (and if you want to skin a new interpolated skeleton each frame, speed can be important)<br /><br />Just for the record, TransformPoint works like this (psuedocode):<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void TransformPoint(Point3D* dest, Point3D* point, Quat* rotation) {<br />    // rotation must be a unit length quaternion<br />   //dest = rotation * point * Inverse(rotation)<br />   //   Inverse(rotation) is the same as Conjugate(rotation) since it's unit length<br />   //dest = (rotation.w + rotation.xyz) * point * (rotation.w - rotation.xyz)<br />   //  &lt;bunch of steps that I leave as an exercise to the reader&gt;<br />   s = rotation.w    //Scalar part<br />   v = rotation.xyz //Vector part<br />   P = point<br />   dest = (s^2 - Dot(v,v))*P + 2*s*Cross(v,P) + 2*Dot(v,P)*v<br />}<br /></div>
<br /><br />I hope this answers your question, but if it doesn't it should still be a good contribution to the thread : )
<br /><br />-nohbdy</div>]]></body></post><post id="p46881" date="Posted: Sat Sep 04, 2004 9:13 pm "><author>Monstrous</author><body><![CDATA[<div class="postbody">Great thread. 
<br /><br />Thanks to the information provided here I can now load MD5 models into my game engine.  I wrote a little high-level tutorial about it  here: <a href="https://web.archive.org/web/20071110064958/http://home.planet.nl/~monstrous/tutmd5mesh.html" class="postlink">http://home.planet.nl/~monstrous/tutmd5mesh.html</a> and that includes a demo for download (models not included).
<br /><br />Greetings.</div>]]></body></post><post id="p46902" date="Posted: Sat Sep 04, 2004 10:29 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for writing up that info. BTW, that's a nice site with lots of programming info there. <img src="https://web.archive.org/web/20071110064958im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />[/code]</div>]]></body></post><post id="p47116" date="Posted: Sun Sep 05, 2004 9:23 am "><author>kentaro-k.21</author><body><![CDATA[<div class="postbody">hi.
<br /><br />bozo wrote:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z); <br />float qw; <br />if (term &lt; 0.0f) <br />   qw = 0.0f; <br />else <br />   qw = - (float) sqrt(term); <br /></div><br /></div><br /><br />nohbdy wrote:<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"><div class="codetitle"><b>Code:</b></div><div class="codecontent">         if (parentID &lt; 0) { <br />            thisJoint-&gt;orientation = animatedOrientation; <br />            thisJoint-&gt;position = animatedPosition; <br />         } else { <br />            TransformPoint(&amp;transformedPos, &amp;animatedPosition, &amp;parentJoint-&gt;orientation); <br />            thisJoint-&gt;position = transformedPos + parentJoint-&gt;position; <br /><br />            thisJoint-&gt;orientation = animatedOrientation * parentJoint-&gt;orientation; <br />            D3DXQuaternionNormalize(&amp;thisJoint-&gt;orientation,&amp;thisJoint-&gt;orientation); <br />         } <br /></div><br /></div>
<br /><br />thanks. their codes much benefit for my md5anim renderer.
<br /><br />i couldn't create my one without their helpful code samples!</div>]]></body></post><post id="p51249" date="Posted: Fri Sep 17, 2004 10:35 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />i dont understand, for what quaternions are good and can be used.
<br />Does anyone has a good and easy to understand documantation about
<br />that magic voodoo (in german or english)?
<br /><br />Thanks a lot
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p51266" date="Posted: Fri Sep 17, 2004 11:43 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Here's all you need:
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110121139/http://www.j3d.org/matrix_faq/matrfaq_latest.html">http://www.j3d.org/matrix_faq/matrfaq_latest.html</a><!-- m -->
<br /><br />Basically you don't have to understand quaternions, you just have to calculate the missing/redundant quat.z value with sqr(1-x*x-y*y-z*z) and then use a quaternion_to_matrix conversion if you're more comfortable with matrices.</div>]]></body></post><post id="p51384" date="Posted: Sat Sep 18, 2004 10:28 am "><author>der_flo</author><body><![CDATA[<div class="postbody">I think i do slowly know, why they exist in the md5 file format:
<br />for the rotation/orientation?
<br />So i need them to calcucate the exact position of each vertex
<br />in relation to it´s bone?
<br /><br />Is that right, or am i totaly lost  <img src="https://web.archive.org/web/20071110121139im_/http://www.doom3world.org/phpbb2/images/smilies/icon_confused.gif" alt=":?" title="Confused" /><br /><br />Regards 
<br />Flo</div>]]></body></post><post id="p51458" date="Posted: Sat Sep 18, 2004 7:59 pm "><author>julienr</author><body><![CDATA[<div class="postbody">Is there a difference between the joints hierarchy in the md5mesh and md5anim files ?
<br />I watched a few models and there doesn't seem to be any difference...
<br />Is it used for things like dismember the monsters ? Anybody has an example ?
<br />Thanks !</div>]]></body></post><post id="p51677" date="Posted: Sun Sep 19, 2004 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">der_flo: that's right, quaternions represent rotations, like bozo's first post in this thread points out.
<br /><br />julienr: I haven't seen a md5anim where there was a difference in hierarchy to the md5mesh file, either. Theoretically this would be possible though, because the hierarchy info in the md5mesh is actually redundant and is not needed. Having a different per-md5anim hierarchy could technically be possible, no matter if it makes sense from an artists point of view or not...  <img src="https://web.archive.org/web/20071110121139im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p52230" date="Posted: Tue Sep 21, 2004 2:30 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />i just realized, that in version 10 of the md5mesh file is something missing:
<br />the number of the mesh you are reading:
<br />mesh {
<br />but in version 6 it was
<br />mesh 1 { // or any other number
<br />Am i able to have more than just one mesh in one md5 mesh file
<br />or should i forget about that meshes in the md5mesh file
<br />and concentrate on those in the md5anim file?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p52263" date="Posted: Tue Sep 21, 2004 5:24 pm "><author>nohbdy</author><body><![CDATA[<div class="postbody">There's a "numMeshes #" at the top of the file that tells you how many meshes there are... each mesh being labeled "mesh # {" is just redundant/unnecessary since the individual mesh numbers/indices don't really serve any purpose</div>]]></body></post><post id="p52533" date="Posted: Wed Sep 22, 2004 6:57 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">nohbdy: thats true ...
<br /><br />der_ton: does your blender exporter export multiple meshes, or just one, and how do you handle multiple animations, do they each get in an extra file?
<br /><br />regards
<br /><br />flo</div>]]></body></post><post id="p52557" date="Posted: Wed Sep 22, 2004 8:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">The blender exporter handles multiple meshes nicely, you can have different objects that comprise the character, and different used materials within each object. But I don't take credit for that, most of that was done by Jiba, who wrote the Cal3D export script that my exporter is partially based on. There's not too much code left of the original script, but the mesh handling and splitting is almost untouched.
<br /><br />Regarding multiple animations, you have to specify a frame interval for the animation export. You can have multiple animations in your .blend file and do several exports with different intervals, for example. I probably should add a "don't export mesh" option to speed up the process for exporters. I could also add an option to read the animation setup data from file (like what animations have which intervals, and the filenames they should get exported to. Now that would be export process automation heaven...).</div>]]></body></post><post id="p52560" date="Posted: Wed Sep 22, 2004 8:27 pm "><author>seith</author><body><![CDATA[<div class="postbody">I was wondering, is there a solution for the problem der_ton mentionned last month?
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there? <br /><br />example: <br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 ) <br />Qx and Qy are animated components: <br />frame 14: -0.8022928834 0.5969305038 <br />frame 15: 0.802292943 -0.5969305634</div>
<br /><br />Because I seem to be having the same kind of problem. The values are indeed flipping in the anim file itself, and I was wondering how to get past that annoyance....</div>]]></body></post><post id="p52569" date="Posted: Wed Sep 22, 2004 9:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm not so sure anymore if the toggling really caused the animations to get borked. I think it was caused by
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">qw = -sqrt(1.0f - qx*qx - qy*qy - qz*qz)</div>
<br />Because you can end up with a negative number passed to the sqrt(). You have to clamp that term to zero if it's negative, and then calculate the sqrt(). That solved it I think.</div>]]></body></post><post id="p52695" date="Posted: Thu Sep 23, 2004 11:26 am "><author>der_flo</author><body><![CDATA[<div class="postbody">I got it managed to interpolate the positions of each bone,
<br />but i dont get it how to interpolate the rotation matrices or
<br />quaternions, can anybody give a brief instruction, or example
<br />code?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p52713" date="Posted: Thu Sep 23, 2004 2:27 pm "><author>nohbdy</author><body><![CDATA[<div class="postbody">To interpolate quaternions, use a function called slerp (works just like lerp for positions)... for matrices.. uhh.. convert to quaternions and use slerp :)
<br /><br />Slerp stands for spherical linear interpolation, formula for interpolating from A to B with factor t (t would be your time between frames, normalized to range [0,1]) is something like:
<br />[ sin(theta*(1-t))*A + sin(theta*t)*B ] / sin(theta), theta being the angle of separation between the two quaternions (arccos(A dot B) I think?) but don't quote me on any of that math, better to look it up yourself.
<br /><br />-nohbdy</div>]]></body></post><post id="p52715" date="Posted: Thu Sep 23, 2004 2:35 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void UpdateBones(int keyframe1, int keyframe2, float deltatime)<br />...<br />quaternion_t qr;<br /><br />QuaternionSlerp(ba-&gt;keyframes[keyframe1].rot, ba-&gt;keyframes[keyframe2].rot, deltatime, qr);<br />...<br /></div><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void QuaternionSlerp(const quaternion_t q1, const quaternion_t q2, const vec_t t, quaternion_t qr)<br />{<br />   vec_t sq1, sq2;<br /><br />   vec_t cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br /><br />   quaternion_t q2b;<br /><br />   if( cosom &lt; 0.0f)<br />   {<br />      cosom = -cosom;<br />      q2b[0] = -q2[0];<br />      q2b[1] = -q2[1];<br />      q2b[2] = -q2[2];<br />      q2b[3] = -q2[3];<br />   }<br />   else<br />   {<br />      QuaternionCopy(q2, q2b);<br />   }<br /><br />   if( (1.0f + cosom) &gt; 1E-5)<br />   {<br />      if( (1.0f - cosom) &gt; 1E-5)<br />      {<br />         vec_t om = (vec_t) acos(cosom);<br />         vec_t rsinom = (vec_t)(1.0f / sin(om));<br /><br />         sq1 = (vec_t)sin( (1.0f - t) * om) * rsinom;<br />         sq2 = (vec_t)sin(t * om) * rsinom;<br />      }<br />      else<br />      {<br />         sq1 = (vec_t)(1.0f - t);<br />         sq2 = t;<br />      }<br /><br />      qr[3] = sq1 * q1[3] + sq2 * q2b[3];<br />      qr[0] = sq1 * q1[0] + sq2 * q2b[0];<br />      qr[1] = sq1 * q1[1] + sq2 * q2b[1];<br />      qr[2] = sq1 * q1[2] + sq2 * q2b[2];<br />   }<br />   else<br />   {<br />      const vec_t PI = (vec_t)3.14159265358979323846f;<br /><br />      sq1 = (vec_t)sin( (1.0f - t) * 0.5f * PI);<br />      sq2 = (vec_t)sin(t * 0.5f * PI);<br /><br />      qr[3] = sq1 * q1[3] + sq2 * q1[2];<br />      qr[0] = sq1 * q1[0] + sq2 * q1[1];<br />      qr[1] = sq1 * q1[1] + sq2 * q1[0];<br />      qr[2] = sq1 * q1[2] + sq2 * q1[3];<br />   }<br />}<br /></div>
<br /><br />(maybe a simple lerp is good enough for the quality of the anim, i read that most of the time a lerp has no big differences to the slerp in the visual result, but it seems that the most use nevertheless the slerp)</div>]]></body></post><post id="p52788" date="Posted: Thu Sep 23, 2004 8:01 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />you are a god, but if i implement this code to interpolate
<br />between the bones quaternions, the rendered models look
<br />very freaky, so maybe i have fogoten something, here´s what i am doing
<br />befor rendering the model with it animations:
<br />1. i calculate an interpolation value (its a float) between this and the next frame
<br />2. After that i calculate the new bone positions
<br />3. Then i calculate the final vertex positions relative to there bones,
<br />and draw them.
<br /><br />I think the failure happens in step 2, becouse if i disable this step,
<br />then the animation "freezes" and the baseframe is displayed, and that´s
<br />looking perfect.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    152 int iCalcBones(struct s_models *model) {<br />    153   if (model == NULL) {<br />    154     return -1;<br />    155   }<br />    156   unsigned int i, j;<br />    157   float par_mat[16], this_mat[16], interpol;<br />    158   struct s_animations *anim = model-&gt;anim;<br />    159   struct s_anim_frames *currframe, *nextframe;<br />    160   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    161   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    162   //vLogMe("currframe: %d\tnextframe: %d\n",anim-&gt;curr_frame,anim-&gt;next_frame);<br />    163   if (currframe == NULL) {<br />    164     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    165     return 0;<br />    166   }<br />    167   if (nextframe == NULL) {<br />    168     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    169     return 0;<br />    170   }<br />    171   interpol = anim-&gt;interpol;<br />    172   i = 0;<br />    173   model-&gt;bones[i].calc_pos.x = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    174   model-&gt;bones[i].calc_pos.y = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    175   model-&gt;bones[i].calc_pos.z = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    176   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    177   // here i calculate the absolute matrix for this bone<br />    178   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    179     model-&gt;bones[i].calc_pos.x = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    180     model-&gt;bones[i].calc_pos.x += model-&gt;bones[i-1].calc_pos.x;<br />    181     model-&gt;bones[i].calc_pos.y = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    182     model-&gt;bones[i].calc_pos.y += model-&gt;bones[i-1].calc_pos.y;<br />    183     model-&gt;bones[i].calc_pos.z = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    184     model-&gt;bones[i].calc_pos.z += model-&gt;bones[i-1].calc_pos.z;<br />    185     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    186     // here i calculate the absolute matrix for this bone<br />    187   }<br />    188   return 0;<br />    189 }<br /></div><br />the code that calculates the new matrix:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    213     float term = 1.0f - (model-&gt;bones[i].quat.x*model-&gt;bones[i].quat.x) - (model-&gt;bones[i].quat.y*model-&gt;bones[i]        .quat.y) - (model-&gt;bones[i].quat.z*model-&gt;bones[i].quat.z);<br />    214     if (term &lt; 0.0f) {<br />    215       model-&gt;bones[i].quat.w = 0.0f;<br />    216     }else{<br />    217       model-&gt;bones[i].quat.w = - (float) sqrt(term);<br />    218     }<br />    219     float xx = model-&gt;bones[i].quat.x * model-&gt;bones[i].quat.x;<br />    220     float xy = model-&gt;bones[i].quat.y * model-&gt;bones[i].quat.y;<br />    221     float xz = model-&gt;bones[i].quat.x * model-&gt;bones[i].quat.z;<br />    222     float xw = model-&gt;bones[i].quat.x * model-&gt;bones[i].quat.w;<br />    223     float yy = model-&gt;bones[i].quat.y * model-&gt;bones[i].quat.y;<br />    224     float yz = model-&gt;bones[i].quat.y * model-&gt;bones[i].quat.z;<br />    225     float yw = model-&gt;bones[i].quat.y * model-&gt;bones[i].quat.w;<br />    226     float zz = model-&gt;bones[i].quat.z * model-&gt;bones[i].quat.z;<br />    227     float zw = model-&gt;bones[i].quat.z * model-&gt;bones[i].quat.w;<br />    228     model-&gt;bones[i].calc_mat[0]  = 1 - 2 * ( yy + zz );<br />    229     model-&gt;bones[i].calc_mat[1]  =     2 * ( xy - zw );<br />    230     model-&gt;bones[i].calc_mat[2]  =     2 * ( xz + yw );<br />    231     model-&gt;bones[i].calc_mat[4]  =     2 * ( xy + zw );<br />    232     model-&gt;bones[i].calc_mat[5]  = 1 - 2 * ( xx + zz );<br />    233     model-&gt;bones[i].calc_mat[6]  =     2 * ( yz - xw );<br />    234     model-&gt;bones[i].calc_mat[8]  =     2 * ( xz - yw );<br />    235     model-&gt;bones[i].calc_mat[9]  =     2 * ( yz + xw );<br />    236     model-&gt;bones[i].calc_mat[10] = 1 - 2 * ( xx + yy );<br />    237     model-&gt;bones[i].calc_mat[3]  = model-&gt;bones[i].calc_mat[7] = model-&gt;bones[i].calc_mat[11] = model-&gt;bones[i].c        alc_mat[12] = model-&gt;bones[i].calc_mat[13] = model-&gt;bones[i].calc_mat[14] = 0;<br />    238     model-&gt;bones[i].calc_mat[15] = 1;</div>
<br /><br />The code is in a pre alpha stadium <img src="https://web.archive.org/web/20071110121139im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p52929" date="Posted: Fri Sep 24, 2004 10:28 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><br />in your "the code that calculates the new matrix":
<br /><br />why do you calc model-&gt;bones[i].quat.w?
<br />model-&gt;bones[i].quat is a full quat
<br />this w-calc is only used when you build the anim orientations from the md5anim file, than you have full quat's and all calc with them are also full quat's
<br /><br /><br /><br />in iCalcBones:
<br /><br />it seems your pos calc is not right, you add the pos of the prev bone to the current
<br /><br />what i would do is:
<br /><br />-calc the current animtime localpos via interpolation between the two keyframes (like you do)
<br />-calc the current animtime localrot via QuaternionSlerp between the two keyframes (like you do)
<br /><br />than their are two methodes:
<br />you can use this values without matrixconvertion and do the needed calc's with them (but i skip the methode here)
<br />or you build matrices and use them for the rest of the work
<br /><br />so build a matrix of the current animtime localpos and localrot
<br />multiply this localmat with the parent worldmat, than this is the worldmat for the current bone
<br /><br />the parent of the current bone is not the prev bone in the bones array, the bone has an index to the right parent
<br />because in md5models the parentbones are always before (but not necessarily the prev bone) the childrens, you can calc the bones in a loop and access the parentmat without trouble
<br /><br />than you have the mat of the bone for the use in the vertextransform</div>]]></body></post><post id="p52930" date="Posted: Fri Sep 24, 2004 10:33 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />i think i just realized, what i have forgoten:
<br />I have to add the rotation to the rotation of
<br />the previus bone, right?
<br />Do i have to multiply them or will that be the wrong way
<br />of combining roations?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p52940" date="Posted: Fri Sep 24, 2004 12:41 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">First of all, thank you for helping me <img src="https://web.archive.org/web/20071110121139im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">@der_flo<br /><br /><br />in your "the code that calculates the new matrix":<br /><br />why do you calc model-&gt;bones[i].quat.w?<br />model-&gt;bones[i].quat is a full quat<br />this w-calc is only used when you build the anim orientations from the md5anim file, than you have full quat's and all calc with them are also full quat's<br /></div><br /><br />Well, as i said, this code is still alpha...<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent"><br />in iCalcBones:<br /><br />it seems your pos calc is not right, you add the pos of the prev bone to the current<br /></div><br /><br />Well, thats right, but the model i am rendering at this point only has 4 bones and in this model every bone´s parent is the previous bone, but i bugfixed that for other models with more bones and where the parent bone is not just the previuos.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">what i would do is:<br /><br />-calc the current animtime localpos via interpolation between the two keyframes (like you do)<br />-calc the current animtime localrot via QuaternionSlerp between the two keyframes (like you do)<br /><br />than their are two methodes:<br />you can use this values without matrixconvertion and do the needed calc's with them (but i skip the methode here)<br />or you build matrices and use them for the rest of the work<br /><br />so build a matrix of the current animtime localpos and localrot<br />multiply this localmat with the parent worldmat, than this is the worldmat for the current bone<br /></div><br /><br />what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right?<br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">the parent of the current bone is not the prev bone in the bones array, the bone has an index to the right parent<br />because in md5models the parentbones are always before (but not necessarily the prev bone) the childrens, you can calc the bones in a loop and access the parentmat without trouble<br /><br />than you have the mat of the bone for the use in the vertextransform</div>
<br /><br />Thanks for all of that, i think i am on the right way now <img src="https://web.archive.org/web/20071110121139im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />BTW: Is it faster to let a vertex sheder do the matrix multiplication or
<br />or will it be faster to this in 3DNow or SSE Code?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p52943" date="Posted: Fri Sep 24, 2004 12:59 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">If you plan to do any further calculations with the final vertex positions, you'll have to do that on the CPU anyway. For example silhouette detection or tangentspace calculations...</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110062910/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062910/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062910/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062910/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064422im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064422im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064422im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064422im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064422im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064422im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064422im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064422im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064422im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 3:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...
<br />the new formats of the md5mesh and md5anim files
<br /><br />i have take a first look on it and will post here what i have found out, it is not complete
<br /><br />so, start with some excerpts of two example files, i choose the imp:
<br /><br />imp.md5mesh
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>
<br /><br />first the name of the joint
<br /><br />than the parentjoint index
<br /><br />next the flag that tells whitch components are animated in the frames:
<br /><br />six possible components - translation x y z and orientation x y z
<br /><br />one bit for each component:
<br /><br />bit 0 - 1  =&gt; translation x
<br />bit 1 - 2  =&gt; translation y
<br />bit 2 - 4  =&gt; translation z
<br />bit 3 - 8  =&gt; orientation x
<br />bit 4 - 16 =&gt; orientation y
<br />bit 5 - 32 =&gt; orientation z
<br /><br />ie:
<br />56 =&gt; 8+16+32 -&gt; alle three orientation values
<br />6 =&gt; 2+4 -&gt; translation y and z
<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,
<br />the count of animated components are indicated by the preceding flag
<br /><br /><span style="font-weight: bold">bounds:</span>
<br /><br />numFrames entries
<br />min x y z and max x y z
<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)
<br /><br /><span style="font-weight: bold">baseframe:</span>
<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)
<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints
<br /><br /><span style="font-weight: bold">frame:</span>
<br /><br />numAnimatedComponents entries
<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily
<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 5:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>
<br />The w component of the quaternions have to be negated, yep:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Thu Aug 05, 2004 12:27 am "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 1:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!
<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 4:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 5:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.
<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>
<br /><br />But I'm not sure if the result is the correct. Look this image:
<br /><br /><img src="https://web.archive.org/web/20101225022041im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.
<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.
<br /><br />BTW, I'm also interested on how the other coders handle this.
<br /><br />Happy coding! <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 6:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)
<br /><br /><img src="https://web.archive.org/web/20101225022041im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 7:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 12:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>
<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos
<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,
<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),
<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)
<br /><br />i dont try the new fileformat at present,
<br />but now the hierarchy info is also in the md5anim files,
<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 3:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>
<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.
<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 6:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?
<br /><br />example:
<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )
<br />Qx and Qy are animated components:
<br />frame 14:  -0.8022928834 0.5969305038
<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 12:13 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton
<br /><br />i didn't try the new md5anim format currently,
<br />but in a other own project, i had troubles that sounds like yours,
<br />here is what i did:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 5:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:
<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )
<br />-Mesh Data ( verts &amp; tris &amp; weights )
<br /><br />Some questions:
<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?
<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? 
<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?
<br /><br />4. Im not sure what weights are.. can i get a primer real quick?
<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?
<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? 
<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 5:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>
<br />1st param -&gt; triangle index
<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)
<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 6:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.
<br /><br />Just a few more questions though, if you guys dont mind:
<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? 
<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?
<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?
<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 7:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>
<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).
<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 7:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20101225022041im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Sat Aug 21, 2004 12:41 am "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 1:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:
<br /><br /><a href="https://web.archive.org/web/20101225022041/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>
<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 2:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  
<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...
<br />the new formats of the md5mesh and md5anim files
<br /><br />i have take a first look on it and will post here what i have found out, it is not complete
<br /><br />so, start with some excerpts of two example files, i choose the imp:
<br /><br />imp.md5mesh
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>
<br /><br />first the name of the joint
<br /><br />than the parentjoint index
<br /><br />next the flag that tells whitch components are animated in the frames:
<br /><br />six possible components - translation x y z and orientation x y z
<br /><br />one bit for each component:
<br /><br />bit 0 - 1  =&gt; translation x
<br />bit 1 - 2  =&gt; translation y
<br />bit 2 - 4  =&gt; translation z
<br />bit 3 - 8  =&gt; orientation x
<br />bit 4 - 16 =&gt; orientation y
<br />bit 5 - 32 =&gt; orientation z
<br /><br />ie:
<br />56 =&gt; 8+16+32 -&gt; alle three orientation values
<br />6 =&gt; 2+4 -&gt; translation y and z
<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,
<br />the count of animated components are indicated by the preceding flag
<br /><br /><span style="font-weight: bold">bounds:</span>
<br /><br />numFrames entries
<br />min x y z and max x y z
<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)
<br /><br /><span style="font-weight: bold">baseframe:</span>
<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)
<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints
<br /><br /><span style="font-weight: bold">frame:</span>
<br /><br />numAnimatedComponents entries
<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily
<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>
<br />The w component of the quaternions have to be negated, yep:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!
<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.
<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>
<br /><br />But I'm not sure if the result is the correct. Look this image:
<br /><br /><img src="https://web.archive.org/web/20071110065123im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.
<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.
<br /><br />BTW, I'm also interested on how the other coders handle this.
<br /><br />Happy coding! <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)
<br /><br /><img src="https://web.archive.org/web/20071110065123im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>
<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos
<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,
<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),
<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)
<br /><br />i dont try the new fileformat at present,
<br />but now the hierarchy info is also in the md5anim files,
<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>
<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.
<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?
<br /><br />example:
<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )
<br />Qx and Qy are animated components:
<br />frame 14:  -0.8022928834 0.5969305038
<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton
<br /><br />i didn't try the new md5anim format currently,
<br />but in a other own project, i had troubles that sounds like yours,
<br />here is what i did:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:
<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )
<br />-Mesh Data ( verts &amp; tris &amp; weights )
<br /><br />Some questions:
<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?
<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? 
<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?
<br /><br />4. Im not sure what weights are.. can i get a primer real quick?
<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?
<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? 
<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>
<br />1st param -&gt; triangle index
<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)
<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.
<br /><br />Just a few more questions though, if you guys dont mind:
<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? 
<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?
<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?
<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>
<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).
<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071110065123im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:
<br /><br /><a href="https://web.archive.org/web/20071110065123/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>
<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071110065123/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  
<br /><br />Greets.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 1:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 6:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023612/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 7:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023612/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 2:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20101225023612im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 3:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 12:57 pm "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20101225023612/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 6:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 8:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 5:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20101225023612im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 3:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 2:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 7:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 7:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120515/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120515/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120515im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120515/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120515/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120515im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 3:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 8:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 9:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 9:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 9:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20101225022519/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 10:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 11:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 4:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 5:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 5:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 5:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 5:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 6:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 6:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 7:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 8:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225022519/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 12:24 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 11:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20101225022519im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20101225022519/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20101225022519/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 11:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110062910/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062910/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110062910im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062910/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062910/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p66268" date="Posted: Sun Dec 05, 2004 12:43 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 2:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 7:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 4:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 7:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20101225023538im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20101225023538im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20101225023538im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 10:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 11:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 4:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 7:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20101225023538/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20101225023538im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 11:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20101225023538im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 6:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 6:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 7:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20101225023538im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 6:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 6:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 4:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 11:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 6:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 2:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20101225023538im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20101225023538im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20101225023538im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 8:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064422im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064422im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064422im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064422/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064422im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064422im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064422im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064422im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064422im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064422im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064325im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064325im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064325im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064325/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064325/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064325/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064325/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064325im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064325im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064325im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064325im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064325im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064325im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063940im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063940im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063940im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063940/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063940/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063940/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063940/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063940im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063940im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063940im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063940im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063940im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063940im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064012im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064012im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064012im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064012/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064012/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064012/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064012/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064012im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064012im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064012im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064012im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064012im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064012im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20070509181516im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20070509181516im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20070509181516im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb" xml:lang="en-gb">
  <head>
    <script type="text/javascript" src="https://web.archive.org/static/js/analytics.js"></script>
    <link type="text/css" rel="stylesheet" href="https://web.archive.org/static/css/banner-styles.css" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="content-language" content="en-gb" />
    <meta http-equiv="content-style-type" content="text/css" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta name="resource-type" content="document" />
    <meta name="distribution" content="global" />
    <meta name="copyright" content="2002-2006 phpBB Group" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <title>Doom3world • View topic - Final MD5 File Formats</title>
    <link rel="stylesheet" href="https://web.archive.org/web/20070509181516cs_/http://www.doom3world.org/phpbb2/styles/subsilver2/theme/stylesheet.css" type="text/css" />
    <script type="text/javascript">
<![CDATA[
// <![CDATA[

function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to.:', '5');
	var perpage = '20';
	var base_url = './viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4';

	if (page !== null && !isNaN(page) && page > 0)
	{
		document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * perpage);
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}


// ]]]] ><![CDATA[>
]] >
    </script>
  </head>
  <body class="ltr">
<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script><![CDATA[ if (window.archive_analytics) { window.archive_analytics.values['server_name']="wwwb-app10.us.archive.org";}; ]] ></script><script type="text/javascript" src="https://web.archive.org/static/js/disclaim-element.js"></script><script type="text/javascript" src="https://web.archive.org/static/js/graph-calc.js"></script><script type="text/javascript" src="https://web.archive.org/static/jflot/jquery.min.js"></script><script type="text/javascript"><![CDATA[
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1420070399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/www.doom3world.org\/phpbb2\/viewtopic.php?p=100213";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 475;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "9";
var displayMonth = "May";
var displayYear = "2007";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]]] ><![CDATA[>
]] ></script><style type="text/css"><![CDATA[body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}]] ></style><div id="wm-ipp" lang="en" class="__wb_banner_div" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px" xml:lang="en">


<div id="wm-ipp-inside" class="__wb_banner_div" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(https://web.archive.org/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr><td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="https://web.archive.org/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="https://web.archive.org/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0" /></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr><td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="https://web.archive.org/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://www.doom3world.org/phpbb2/viewtopic.php?p=100213" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20070509181516" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;width: inherit !important" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody><!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR --><tr style="width:110px;height:16px;font-size:10px!important;"><td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
                       Apr
                       
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 18:15:16 May 9, 2007">MAY</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="https://web.archive.org/web/20071110063838/http://www.doom3world.org/phpbb2/viewtopic.php?p=100213" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="10 Nov 2007"><strong>NOV</strong></a>
		                
               </td>
           </tr><!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR --><tr><td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
                       <img src="https://web.archive.org/static/images/toolbar/wm_tb_prv_off.png" alt="Previous capture" width="14" height="16" border="0" /></td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 18:15:16 May 9, 2007">9</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="https://web.archive.org/web/20071110063838/http://www.doom3world.org/phpbb2/viewtopic.php?p=100213" title="6:38:38 Nov 10, 2007" style="background-color:transparent;border:none;"><img src="https://web.archive.org/static/images/toolbar/wm_tb_nxt_on.png" alt="Next capture" width="14" height="16" border="0" /></a>
		                
			    </td>
           </tr><!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR --><tr style="width:110px;height:13px;font-size:9px!important;"><td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
                       2006
                       
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 18:15:16 May 9, 2007">2007</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
                       2008
                       
				</td>
           </tr></tbody></table></td>

       </tr><tr><td style="vertical-align:middle;padding:0!important;">
           <a href="https://web.archive.org/web/20070509181516*/http://www.doom3world.org/phpbb2/viewtopic.php?p=100213" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>2 captures</strong></a>
           <div class="__wb_banner_div" style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">9 May 07 - 10 Nov 07</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:475px;height:27px;" href="viewtopic.php?p=100213" id="wm-graph-anchor">
       <div class="__wb_banner_div" id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:475px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;" onmouseover="showTrackers('inline');" onmouseout="showTrackers('none');" onmousemove="trackMouseMove(event,this)" alt="sparklines" width="475" height="27" border="0" src="https://web.archive.org/web/jsp/graph.jsp?graphdata=475_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000000_2007:4:000010000010_2008:-1:000000000000_2009:-1:000000000000_2010:-1:000000000000_2011:-1:000000000000_2012:-1:000000000000_2013:-1:000000000000_2014:-1:000000000000" /><img id="wbMouseTrackYearImg" style="display:none; position:absolute; z-index:9010;" width="25" height="27" border="0" src="https://web.archive.org/static/images/toolbar/transp-yellow-pixel.png" /><img id="wbMouseTrackMonthImg" style="display:none; position:absolute; z-index:9011; " width="2" height="27" border="0" src="https://web.archive.org/static/images/toolbar/transp-red-pixel.png" /></div>
		</a>

       </td>
       </tr></tbody></table></td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(https://web.archive.org/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(https://web.archive.org/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table></div>
</div>
<script type="text/javascript"><![CDATA[
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
]] ></script><!-- END WAYBACK TOOLBAR INSERT --><a name="top" id="top"></a>

<div id="wrapheader">

	<div id="logodesc">
		<table width="100%" cellspacing="0"><tr><td><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/index.php?sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/site_logo.gif" width="300" height="71" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>Doom3world</h1><span class="gen">The world is yours! Doom 3 - Quake 4 - ET:QW - Prey - Rage</span>
      
      <br /><script type="text/javascript"><![CDATA[<!--
      google_ad_client = "pub-9445709839432880";
      google_ad_width = 468;
      google_ad_height = 60;
      google_ad_format = "468x60_as";
      google_ad_type = "text_image";
      //2007-11-04: D3WForums_banner_header
      google_ad_channel = "6206397355";
      google_color_border = "DCE1E5";
      google_color_bg = "DCE1E5";
      google_color_link = "006699";
      google_color_text = "000000";
      google_color_url = "006699";
      google_ui_features = "rc:0";
      //-->
      ]] ></script><script type="text/javascript" src="https://web.archive.org/web/20070509181516js_/http://pagead2.googlesyndication.com/pagead/show_ads.js"><![CDATA[
  ]] ></script></td>
		</tr></table></div>

	<div id="menubar">
		<table width="100%" cellspacing="0"><tr><td class="genmed">
				<a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/ucp.php?mode=login&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>   <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/ucp.php?mode=register&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
								</td>
			<td class="genmed" align="right">
				<a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/faq.php?sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				   <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/search.php?sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>			</td>
		</tr></table></div>

	<div id="datebar">
		<table width="100%" cellspacing="0"><tr><td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Fri Jan 04, 2008 1:48 pm<br /></td>
		</tr></table></div>

</div>

<div id="wrapcentre">

		<p class="searchbar">
		<span style="float: left;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/search.php?search_id=unanswered&amp;sid=913cfca31eee992e44876a2497f8abc4">View unanswered posts</a> | <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/search.php?search_id=active_topics&amp;sid=913cfca31eee992e44876a2497f8abc4">View active topics</a></span>
			</p>
	
	<br style="clear: both;" /><table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;"><tr><td class="row1">
			<p class="breadcrumbs"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/index.php?sid=913cfca31eee992e44876a2497f8abc4">Board index</a> 
   » <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewforum.php?f=73&amp;sid=913cfca31eee992e44876a2497f8abc4">Doom 3</a> » <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewforum.php?f=3&amp;sid=913cfca31eee992e44876a2497f8abc4">Doom3 Modeling and Animations</a>      
  

  
  </p>
			<p class="datetime">All times are UTC </p>
		</td>
	</tr></table><center>
  <script type="text/javascript"><![CDATA[<!--
      google_ad_client = "pub-9445709839432880";
      google_ad_width = 728;
      google_ad_height = 15;
      google_ad_format = "728x15_0ads_al_s";
      //2007-11-03: D3WForums_linkblock
      google_ad_channel = "1963952183";
      google_color_border = "FFFFFF";
      google_color_bg = "FFFFFF";
      google_color_link = "006699";
      google_color_text = "006699";
      google_color_url = "006699";
      //-->
      ]] ></script><script type="text/javascript" src="https://web.archive.org/web/20070509181516js_/http://pagead2.googlesyndication.com/pagead/show_ads.js"><![CDATA[
  ]] ></script></center>
	<br /><div id="pageheader">
	<h2><a class="titles" href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;start=80&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4">Final MD5 File Formats</a></h2>

	<p class="moderators">Moderators: <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=2&amp;sid=913cfca31eee992e44876a2497f8abc4" style="color: #AA0000;" class="username-coloured">BNA!</a>, <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=group&amp;g=654&amp;sid=913cfca31eee992e44876a2497f8abc4">il padrino</a></p>
</div>

<br clear="all" /><br /><div id="pagecontent">

	<table width="100%" cellspacing="1"><tr><td align="left" valign="middle" nowrap="nowrap">
		<a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/posting.php?mode=post&amp;f=3&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/posting.php?mode=reply&amp;f=3&amp;t=2884&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>		</td>
					<td class="nav" valign="middle" nowrap="nowrap"> Page <strong>5</strong> of <strong>6</strong><br /></td>
			<td class="gensmall" nowrap="nowrap"> [ 113 posts ] </td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="viewtopic.php?p=100213#" onclick="jumpto(); return false;" title="Click to jump to page…">Go to page</a> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4&amp;start=60">Previous</a>  <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4">1</a><span class="page-sep">, </span><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4&amp;start=20">2</a><span class="page-sep">, </span><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4&amp;start=40">3</a><span class="page-sep">, </span><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4&amp;start=60">4</a><span class="page-sep">, </span><strong>5</strong><span class="page-sep">, </span><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4&amp;start=100">6</a>  <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;st=0&amp;sk=t&amp;sd=a&amp;sid=913cfca31eee992e44876a2497f8abc4&amp;start=100">Next</a></b></td>
			</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr><td class="cat">
			<table width="100%" cellspacing="0"><tr><td class="nav" nowrap="nowrap"> 
								</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;view=previous&amp;sid=913cfca31eee992e44876a2497f8abc4">Previous topic</a> | <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?f=3&amp;t=2884&amp;view=next&amp;sid=913cfca31eee992e44876a2497f8abc4">Next topic</a> </td>
			</tr></table></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr><th>Author</th>
			<th>Message</th>
		</tr><tr class="row1"><td align="center" valign="middle">
				<a name="p66268" id="p66268"></a>
				<b class="postauthor">boomcannon</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=66268&amp;sid=913cfca31eee992e44876a2497f8abc4#p66268"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Dec 04, 2004 11:43 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Thu Dec 02, 2004 10:01 am<br /><b>Posts:</b> 2<br /><b>Location:</b> Mars				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>

					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=6430&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p67311" id="p67311"></a>
				<b class="postauthor">Sfpiano</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=67311&amp;sid=913cfca31eee992e44876a2497f8abc4#p67311"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Dec 12, 2004 1:40 am </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Dec 03, 2004 5:39 am<br /><b>Posts:</b> 8				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>

					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=6440&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p100020" id="p100020"></a>
				<b class="postauthor">Dhenry</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100020&amp;sid=913cfca31eee992e44876a2497f8abc4#p100020"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Jun 20, 2005 6:51 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Thu Feb 10, 2005 2:45 pm<br /><b>Posts:</b> 4				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>

					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=12507&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p100116" id="p100116"></a>
				<b class="postauthor">der_ton</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100116&amp;sid=913cfca31eee992e44876a2497f8abc4#p100116"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jun 21, 2005 3:00 pm </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">Plasma Spammer</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=831.jpg" width="64" height="64" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 27, 2003 10:24 pm<br /><b>Posts:</b> 2528<br /><b>Location:</b> Munich, Germany				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" /> Staff</a>
<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=831&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p100174" id="p100174"></a>
				<b class="postauthor">Dhenry</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100174&amp;sid=913cfca31eee992e44876a2497f8abc4#p100174"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jun 21, 2005 6:56 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Thu Feb 10, 2005 2:45 pm<br /><b>Posts:</b> 4				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20070509181516im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20070509181516im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>

					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=12507&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p100213" id="p100213"></a>
				<b class="postauthor">der_ton</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100213&amp;sid=913cfca31eee992e44876a2497f8abc4#p100213"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jun 21, 2005 9:32 pm </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">Plasma Spammer</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=831.jpg" width="64" height="64" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 27, 2003 10:24 pm<br /><b>Posts:</b> 2528<br /><b>Location:</b> Munich, Germany				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" /> Staff</a>
<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=831&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p100229" id="p100229"></a>
				<b class="postauthor" style="color: #AA0000">rich_is_bored</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100229&amp;sid=913cfca31eee992e44876a2497f8abc4#p100229"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jun 21, 2005 10:43 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">a gun &amp; a nice word</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=517.gif" width="54" height="54" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Sat Jan 11, 2003 8:30 pm<br /><b>Posts:</b> 7565<br /><b>Location:</b> Orlando, FL				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" />  Staff</a>
<br />Learn something today? Why not write an article about it on <a href="https://web.archive.org/web/20070509181516/http://www.modwiki.net/wiki/Main_Page" class="postlink">modwiki.net</a>?</span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=517&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p100254" id="p100254"></a>
				<b class="postauthor" style="color: #AA0000">rich_is_bored</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100254&amp;sid=913cfca31eee992e44876a2497f8abc4#p100254"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Jun 22, 2005 3:26 am </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">a gun &amp; a nice word</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=517.gif" width="54" height="54" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Sat Jan 11, 2003 8:30 pm<br /><b>Posts:</b> 7565<br /><b>Location:</b> Orlando, FL				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" />  Staff</a>
<br />Learn something today? Why not write an article about it on <a href="https://web.archive.org/web/20070509181516/http://www.modwiki.net/wiki/Main_Page" class="postlink">modwiki.net</a>?</span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=517&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p100431" id="p100431"></a>
				<b class="postauthor" style="color: #AA0000">rich_is_bored</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100431&amp;sid=913cfca31eee992e44876a2497f8abc4#p100431"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Jun 23, 2005 6:51 am </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">a gun &amp; a nice word</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=517.gif" width="54" height="54" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Sat Jan 11, 2003 8:30 pm<br /><b>Posts:</b> 7565<br /><b>Location:</b> Orlando, FL				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20070509181516/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" />  Staff</a>
<br />Learn something today? Why not write an article about it on <a href="https://web.archive.org/web/20070509181516/http://www.modwiki.net/wiki/Main_Page" class="postlink">modwiki.net</a>?</span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=517&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p100465" id="p100465"></a>
				<b class="postauthor">der_ton</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=100465&amp;sid=913cfca31eee992e44876a2497f8abc4#p100465"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Jun 23, 2005 10:53 am </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">Plasma Spammer</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=831.jpg" width="64" height="64" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 27, 2003 10:24 pm<br /><b>Posts:</b> 2528<br /><b>Location:</b> Munich, Germany				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" /> Staff</a>
<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=831&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p107381" id="p107381"></a>
				<b class="postauthor">reklipz</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=107381&amp;sid=913cfca31eee992e44876a2497f8abc4#p107381"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Aug 08, 2005 5:59 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">has joined the game</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Tue Aug 02, 2005 9:08 pm<br /><b>Posts:</b> 31				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>

					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=14035&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p107642" id="p107642"></a>
				<b class="postauthor">Dhenry</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=107642&amp;sid=913cfca31eee992e44876a2497f8abc4#p107642"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Aug 10, 2005 5:58 pm </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Thu Feb 10, 2005 2:45 pm<br /><b>Posts:</b> 4				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>

												<br /><br /><span class="gensmall">Last edited by <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=12507&amp;sid=913cfca31eee992e44876a2497f8abc4">Dhenry</a> on Thu Sep 29, 2005 12:33 pm, edited 1 time in total.</span>
						<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=12507&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p107643" id="p107643"></a>
				<b class="postauthor">Dhenry</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> </div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=107643&amp;sid=913cfca31eee992e44876a2497f8abc4#p107643"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Aug 10, 2005 6:12 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Thu Feb 10, 2005 2:45 pm<br /><b>Posts:</b> 4				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20070509181516im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>

												<br /><br /><span class="gensmall">Last edited by <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=12507&amp;sid=913cfca31eee992e44876a2497f8abc4">Dhenry</a> on Thu Mar 02, 2006 9:48 pm, edited 1 time in total.</span>
						<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=12507&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p122901" id="p122901"></a>
				<b class="postauthor">mcamilo</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> questions</div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=122901&amp;sid=913cfca31eee992e44876a2497f8abc4#p122901"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Nov 25, 2005 5:15 am </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 25, 2005 4:31 am<br /><b>Posts:</b> 9				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>

											<span class="postbody"><br />_________________<br />Márcio Camilo</span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row2"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=14870&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row1"><td align="center" valign="middle">
				<a name="p122963" id="p122963"></a>
				<b class="postauthor">der_ton</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> Re: questions</div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=122963&amp;sid=913cfca31eee992e44876a2497f8abc4#p122963"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Nov 25, 2005 5:38 pm </div></td>
				</tr></table></td>
		</tr><tr class="row1"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">Plasma Spammer</td>
				</tr><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/download/file.php?avatar=831.jpg" width="64" height="64" alt="User avatar" /></td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 27, 2003 10:24 pm<br /><b>Posts:</b> 2528<br /><b>Location:</b> Munich, Germany				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>

											<span class="postbody"><br />_________________<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/" class="postlink"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/site/img/d3w.gif" alt="Image" /> Staff</a>
<br /><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?t=5474" class="postlink">Modelviewer  |  3DSMax&lt;-&gt;MD5  |  Blender&lt;-&gt;MD5</a></span>
					<br clear="all" /><br /><table width="100%" cellspacing="0"><tr valign="middle"><td class="gensmall" align="right">
														</td>
						</tr></table></td>
				</tr></table></td>
		</tr><tr class="row1"><td class="profile"><strong><a href="viewtopic.php?p=100213#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;"> <a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/memberlist.php?mode=viewprofile&amp;u=831&amp;sid=913cfca31eee992e44876a2497f8abc4"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a>  </div> <div class="gensmall" style="float: right;"> </div></td>
		</tr><tr><td class="spacer" colspan="2" height="1"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr></table><table class="tablebg" width="100%" cellspacing="1"><tr class="row2"><td align="center" valign="middle">
				<a name="p123010" id="p123010"></a>
				<b class="postauthor">mcamilo</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0"><tr><td class="gensmall" width="100%"><div style="float: left;"> <b>Post subject:</b> Questions 2</div><div style="float: right;"><a href="https://web.archive.org/web/20070509181516/http://www.doom3world.org/phpbb2/viewtopic.php?p=123010&amp;sid=913cfca31eee992e44876a2497f8abc4#p123010"><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Nov 26, 2005 3:39 am </div></td>
				</tr></table></td>
		</tr><tr class="row2"><td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150"><tr><td><img src="https://web.archive.org/web/20070509181516im_/http://www.doom3world.org/phpbb2/styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr><tr><td class="postdetails">is connecting to Doom3world.org</td>
				</tr></table><span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 25, 2005 4:31 am<br /><b>Posts:</b> 9				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5"><tr><td>
					
						<div>




<!--
     FILE ARCHIVED ON 18:15:16 May 9, 2007 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 5:42:47 Sep 26, 2014.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
--></div></td></tr></table></td></tr></table></div></div></body>
</html>
]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063812im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063812im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063812im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063812/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063812/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063812/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063812/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063812im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063812im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063812im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063812im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063812im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063812im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063957im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063957im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063957im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063957/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063957/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063957/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063957/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063957im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063957im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063957im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063957im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063957im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063957im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063917im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063917im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063917im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063917/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063917/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063917/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063917/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063917im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063917im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063917im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063917im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063917im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063917im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064403im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064403im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064403im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064403/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064403/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064403/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064403/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064403im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064403im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064403im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064403im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064403im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064403im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063616im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063616im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063616im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063616/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063616/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063616/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063616/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063616im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063616im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063616im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063616im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063616im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063616im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064100im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064100im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064100im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064100/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064100/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064100/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064100/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064100im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064100im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064100im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064100im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064100im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064100im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064125im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064125im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064125/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064125/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064125/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064125/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064125im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064125im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064125im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064125im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063724im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063724im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063724im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063724/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063724/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063724/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063724/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063724im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063724im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063724im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063724im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063724im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063724im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064248im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064248im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064248im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064248/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064248/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064248/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064248/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064248im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064248im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064248im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064248im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064248im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064248im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063632im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063632im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063632im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063632/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063632/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063632/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063632/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063632im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063632im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063632im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063632im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063632im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063632im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064208im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064208im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064208im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064208/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064208/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064208/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064208/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064208im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064208im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064208im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064208im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064208im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064208im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064307im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064307im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064307im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064307/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064307/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064307/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064307/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064307im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064307im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064307im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064307im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064307im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064307im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064142im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064142im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064142im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064142/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064142/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064142/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064142/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064142im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064142im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064142im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064142im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064142im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064142im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064233im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064233im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064233im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064233/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064233/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064233/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064233/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064233im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064233im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064233im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064233im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064233im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064233im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120057/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120057/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120057im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120057im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120057/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120057im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120057im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120057im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120057/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120057im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115849/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115849/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110115849im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110115849im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110115849/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110115849im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110115849im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110115849im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115849/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110115849im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120155/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120155/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120155im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120155im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120155/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120155im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120155im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120155im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120155/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120155im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115909/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115909/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110115909im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110115909im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110115909/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110115909im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110115909im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110115909im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115909/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110115909im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120419/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120419/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120419im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120419/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120419/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120224/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120224/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120224im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120224im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120224/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120224im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120224im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120224im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120224/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120224im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120457/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120457/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120457im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120457im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120457/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120457im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120457im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120457im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120457/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120457im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120132/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120132/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120132im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120132im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120132/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120132im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120132im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120132im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120132/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120132im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115929/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115929/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110115929im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110115929im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110115929/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110115929im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110115929im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110115929im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110115929/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110115929im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120442/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120442/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120442im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120442im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120442/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120442im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120442im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120442im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120442/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120442im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120356/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120356/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120356im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120356im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120356/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120356im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120356im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120356im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120356/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120356im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120251/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120251/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120251im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120251im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120251/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120251im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120251im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120251im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120251/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120251im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p142681" date="Posted: Wed May 10, 2006 12:17 am "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">unfortunatly most of the download links to md5 viewers with source are dead now. 
<br /><br />anyone wants to re-upload them? or how about posting your md5 viewer source, even if it's not polished up? people want to see and learn :)
<br /><br />thanx!</div>]]></body></post><post id="p142992" date="Posted: Fri May 12, 2006 5:44 pm "><author>[Win]Elchtest</author><body><![CDATA[<div class="postbody">two open source viewers can be found here:
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120332/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>]]></body></post><post id="p143675" date="Posted: Sat May 20, 2006 6:45 pm "><author>pannan</author><body><![CDATA[<div class="postbody"><div class="quotetitle">[Win]Elchtest wrote:</div><div class="quotecontent">two open source viewers can be found here:<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120332/http://tfc.duke.free.fr/">http://tfc.duke.free.fr/</a><!-- m --></div>
<br /><br />Good Job!
<br />Thanks to your threads.</div>]]></body></post><post id="p144998" date="Posted: Mon Jun 05, 2006 1:18 pm "><author>Tr3B</author><body><![CDATA[<div class="postbody">Hi, this is my first post on this Board. <img src="https://web.archive.org/web/20071110120332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I implemented .md5mesh/.md5anim support into my Q3A engine version called XreaL. The source is licensed under GPL. You can get it via Subversion. Just head over the project site and look for SourceCode.
<br /><br /><img src="https://web.archive.org/web/20071110120332im_/http://xreal.sourceforge.net/screenshots/shot0037.jpg" alt="Image" /></div>]]></body></post><post id="p145000" date="Posted: Mon Jun 05, 2006 2:09 pm "><author>ViPr</author><body><![CDATA[<div class="postbody">your specular looks kinda off.</div>]]></body></post><post id="p145637" date="Posted: Sun Jun 11, 2006 11:57 am "><author>Ging</author><body><![CDATA[<div class="postbody">I'm doing an opengl md5 viewer for a bit of uni work and I'm suffering from some oddities when it comes to displaying animations (surprise, surprise).
<br /><br />this <a href="https://web.archive.org/web/20071110120332/http://www.chrisjanes.com/files/pinky-animation.jpg" class="postlink">image</a> shows the issue, the left hand image is the mesh using the md5mesh joint information, the middle is the base frame of the idle animation, the right is frame 0. (the green lines are drawing the bones out for me)
<br /><br />I'm applying relative transformations to the joint hierachy for each frame - I've double checked that against some of the code in this thread, so I can but assume I'm missing something else - maybe a transformation against the modelview matrix?</div>]]></body></post><post id="p177914" date="Posted: Fri May 11, 2007 5:21 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">It took me three days to study md5mesh and md5anim.
<br />Though there are also lots of problems that remain to be solved, I'm glad to see the hellknight alive in my program now... <img src="https://web.archive.org/web/20071110120332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>]]></body></post><post id="p178152" date="Posted: Mon May 14, 2007 7:33 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">ephtracy wrote:</div><div class="quotecontent">I calculate the planes of triangles and normals, tangents of vertices every frame in order to get correct shadow and bump specular effect.However, I remenber the normals and tangents can be calculated by weights and jointMats just like the vertices.How can I get it  <img src="https://web.archive.org/web/20071110120332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_question.gif" alt=":?:" title="Question" /></div>
<br />Here is some discussion on that: <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110120332/http://www.doom3world.org/phpbb2/viewtopic.php?p=22179#22179">http://www.doom3world.org/phpbb2/viewto ... 2179#22179</a><!-- m --></div>]]></body></post><post id="p178295" date="Posted: Wed May 16, 2007 4:48 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Thanks for your reply. It helps me a lot.<img src="https://web.archive.org/web/20071110120332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br />And another question, how could I blend two animations,
<br />for example, from walking to attacking when the monster discovers the player. It makes me a little confused.</div>]]></body></post><post id="p178382" date="Posted: Thu May 17, 2007 2:21 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">There are several methods and there's no "right" or "wrong" way, but just visually good and not so good ways.
<br />A very easy but visually not so good way would be to interpolate the model-space bone positions and rotations after the two animation poses have been calculated for the whole skeleton.
<br />Better would be to interpolate the animated parentspace positions and rotations. There might be other better ways but I don't have any experience with this.</div>]]></body></post><post id="p178445" date="Posted: Fri May 18, 2007 1:29 pm "><author>ehmdjii</author><body><![CDATA[<div class="postbody">hello,
<br />i was once again wondering about the original purpose of the flags in the md5anim file format.
<br /><br />"root"	-1 63 0	//  ( Tx Ty Tz Qx Qy Qz )
<br /><br />for example the "63"-flag would mean that all 6 components should be taken from this files frame data, right?
<br /><br />but what is the actual purpose of that?
<br /><br /><br />and is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation? if so, how? thanks!</div>]]></body></post><post id="p178469" date="Posted: Fri May 18, 2007 6:30 pm "><author>ephtracy</author><body><![CDATA[<div class="postbody">Hi, guy, here are some of my ideas :
<br /><br />1. The component flag is set to compress the data of frame anims.
<br />Just think about an arm of a robot which can only be rotated around one axis and cannot move anyway. In local space, only one component of orientation is animated. .
<br /><br />Or the animation is just for part of the body, for example, a pose of hand, an expression of face, and so on. 
<br /><br />the others are static and useless as well, so it is no need to descript them in the file.
<br /><br />2. I remember I have seen it in one of doom3 files that the animation just control the body of the player, while the head is controled by the sight of player in the game. 
<br /><br />Remenber, The frame animation is descripted in local space. You can assign different anims to differect parts of the skeleton and merge them together with the hierarchy, or even blend two anims by interpolating to get a strange pose. Some of the joint anims can be loaded from file, while some can be generated in real time to interact with enviroment.</div>]]></body></post><post id="p178471" date="Posted: Fri May 18, 2007 6:51 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">edit: ephtracy said it already, but here is what I typed earlier anyway.
<br /><br />I think the flags (and the fact that values that remain static are not saved in the frame) are just to save space.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">is it possible to somehow let the model play two animations (md5anims) at once where certain bones are affected by one animation and other bones by the second animation?</div>
<br />In Doom3 it is possible, it is called animation channels, they are just names for groups of bones, and are defined in a model def, and I think they are referenced by the animation control code in the ai scripts.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019174700im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019174700im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019174700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019174700/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019174700/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181105im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181105im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181105im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181105/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181105/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180647im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180647im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180647im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180647/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180647/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180505im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180505im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180505im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180505/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180505/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181026im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181026im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181026im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181026/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181026/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180829im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180829im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180829im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180829/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180829/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181222im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181222im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181222im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181222/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181222/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181043im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181043im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181043im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181043/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181043/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180715im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180715im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180715im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180715/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180715/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180436im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180436im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180436im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180436/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180436/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180614im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180614im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180614im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180614/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180614/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181319im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181319im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181319im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181319/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181319/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180802im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180802im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180802im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180802/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180802/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181138im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181138im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181138im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181138/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181138/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181125im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181125im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181125im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181125/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181125/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019181003im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019181003im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019181003im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019181003/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019181003/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180559im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180559im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180559im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180559/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180559/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180633im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180633im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180633im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180633/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180633/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180522im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180522im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180522/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180522/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...&#13;<br />the new formats of the md5mesh and md5anim files&#13;<br /><br />i have take a first look on it and will post here what i have found out, it is not complete&#13;<br /><br />so, start with some excerpts of two example files, i choose the imp:&#13;<br /><br />imp.md5mesh&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>&#13;<br /><br />first the name of the joint&#13;<br /><br />than the parentjoint index&#13;<br /><br />next the flag that tells whitch components are animated in the frames:&#13;<br /><br />six possible components - translation x y z and orientation x y z&#13;<br /><br />one bit for each component:&#13;<br /><br />bit 0 - 1  =&gt; translation x&#13;<br />bit 1 - 2  =&gt; translation y&#13;<br />bit 2 - 4  =&gt; translation z&#13;<br />bit 3 - 8  =&gt; orientation x&#13;<br />bit 4 - 16 =&gt; orientation y&#13;<br />bit 5 - 32 =&gt; orientation z&#13;<br /><br />ie:&#13;<br />56 =&gt; 8+16+32 -&gt; alle three orientation values&#13;<br />6 =&gt; 2+4 -&gt; translation y and z&#13;<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,&#13;<br />the count of animated components are indicated by the preceding flag&#13;<br /><br /><span style="font-weight: bold">bounds:</span>&#13;<br /><br />numFrames entries&#13;<br />min x y z and max x y z&#13;<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)&#13;<br /><br /><span style="font-weight: bold">baseframe:</span>&#13;<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)&#13;<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints&#13;<br /><br /><span style="font-weight: bold">frame:</span>&#13;<br /><br />numAnimatedComponents entries&#13;<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily&#13;<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.&#13;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>&#13;<br />The w component of the quaternions have to be negated, yep:&#13;<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!&#13;<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.&#13;<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>&#13;<br /><br />But I'm not sure if the result is the correct. Look this image:&#13;<br /><br /><img src="https://web.archive.org/web/20071019180925im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.&#13;<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.&#13;<br /><br />BTW, I'm also interested on how the other coders handle this.&#13;<br /><br />Happy coding! <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)&#13;<br /><br /><img src="https://web.archive.org/web/20071019180925im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR&#13;<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>&#13;<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos&#13;<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,&#13;<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),&#13;<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)&#13;<br /><br />i dont try the new fileformat at present,&#13;<br />but now the hierarchy info is also in the md5anim files,&#13;<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>&#13;<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.&#13;<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?&#13;<br /><br />example:&#13;<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )&#13;<br />Qx and Qy are animated components:&#13;<br />frame 14:  -0.8022928834 0.5969305038&#13;<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton&#13;<br /><br />i didn't try the new md5anim format currently,&#13;<br />but in a other own project, i had troubles that sounds like yours,&#13;<br />here is what i did:&#13;<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:&#13;<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )&#13;<br />-Mesh Data ( verts &amp; tris &amp; weights )&#13;<br /><br />Some questions:&#13;<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?&#13;<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? &#13;<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?&#13;<br /><br />4. Im not sure what weights are.. can i get a primer real quick?&#13;<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?&#13;<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? &#13;<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>&#13;<br />1st param -&gt; triangle index&#13;<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)&#13;<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.&#13;<br /><br />Just a few more questions though, if you guys dont mind:&#13;<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? &#13;<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?&#13;<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?&#13;<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>&#13;<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).&#13;<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20071019180925im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:&#13;<br /><br /><a href="https://web.archive.org/web/20071019180925/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>&#13;<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="https://web.archive.org/web/20071019180925/http://www.doom3world.org/phpbb2/viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  &#13;<br /><br />Greets.</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110062954/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062954/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110062954im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062954/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062954/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063557/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063557/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063557im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063557/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063557/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063119/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063119/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063119im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063119/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063119/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063232/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063232/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063232im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063232/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063232/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063508/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063508/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063508im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063508/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063508/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063315/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063315/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063315im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063315/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063315/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063217/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063217/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063217im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063217/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063217/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063011/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063011/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063011im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063011/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063011/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063044/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063044/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063044im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063044/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063044/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063419/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063419/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063419im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063419/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063419/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063349/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063349/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063349im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063349/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063349/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063434/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063434/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063434im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063434/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063434/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063332/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063332/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063332im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063332/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063332/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063249/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063249/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063249im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063249/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063249/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063451/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063451/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063451im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063451/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063451/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110062931/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062931/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110062931im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062931/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062931/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110062819/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062819/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110062819im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062819/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110062819/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063103/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063103/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063103im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063103/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063103/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063522/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063522/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063522im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063522/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063522/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p52968" date="Posted: Fri Sep 24, 2004 2:39 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">what do you mean with "build a matrix of the current animtime localpos", do you mean a transformation matrix? So i should combine the rotation and the transformation matrix with a simple matrix multiplication, right? <br />And when drawing the vertices, they have to be multilied by this worldmat from this bone?<br /></div><br /><br />yes, you can build a transformationmat from the pos and a rotationmat from the quat, and combine them with a mat_multiplay, and use this final mat to transform the verts<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">BTW: Is it faster to let a vertex sheder do the matrix multiplication or <br />or will it be faster to this in 3DNow or SSE Code?<br /></div>
<br /><br />additional to der_ton's post,
<br />you can get problems with the limits of some versions of the vs's (ie. with vs &lt; 2.0 you have not much constants to store the bonetransform's), and must work around this (ie. split the mesh, use directly the quat's in the vs to save space in the contants and transform, ....)
<br /><br />i think the best is, to do the work with the cpu,
<br />and also first get it running (and than think on optimations like sse) <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p53006" date="Posted: Fri Sep 24, 2004 7:33 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />thanks for that, but the more i do, the worser it looks  <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" /><br />This is now the code that calculates the bones rotation and transformation
<br />matrix for every frame:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">    232 int iCalcBones(struct s_models *model) {<br />    233   if (model == NULL) {<br />    234     return -1;<br />    235   }<br />    236   unsigned int i, j;<br />    237   matrix4x4_t tmp_mat, trans_mat;<br />    238   float interpol;<br />    239   struct s_animations *anim = model-&gt;anim;<br />    240   struct s_anim_frames *currframe, *nextframe;<br />    241   currframe = &amp;anim-&gt;anim_frames[anim-&gt;curr_frame];<br />    242   nextframe = &amp;anim-&gt;anim_frames[anim-&gt;next_frame];<br />    243   if (currframe == NULL) {<br />    244     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no currframe\n");<br />    245     return 0;<br />    246   }<br />    247   if (nextframe == NULL) {<br />    248     vLogMe("aaaaaaaaaaaaaaaaaaaaaa no nextframe\n");<br />    249     return 0;<br />    250   }<br />    251   interpol = anim-&gt;interpol;<br />    252   i = 0;<br />    253   vMatrix4x4Identity(&amp;trans_mat);<br />    254   QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    255   vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;model-&gt;bones[i].worldmat);<br />    256   trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    257   trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    258   trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    259   vMatrix4x4Multiply(&amp;trans_mat,&amp;model-&gt;bones[i].worldmat,&amp;model-&gt;bones[i].worldmat);<br />    260 <br />    261   for (i=1; i&lt;anim-&gt;numJoints; i++) {<br />    262     vMatrix4x4Identity(&amp;trans_mat);<br />    263     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />    264     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;tmp_mat);<br />    265     trans_mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />    266     trans_mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />    267     trans_mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />    268     vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat);<br />    269     vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;tmp_mat,&amp;model-&gt;bones[i].worldmat);<br />    270     //vLogMe("i: %d\tboneid: %d\tparent: %d\t is: %d\n",i,model-&gt;bones[i].id,model-&gt;bones[i].parent_id,model-&gt;bones[i].parent-&gt;id);<br />    271   }<br />    272   return 0;<br />    273 }</div>
<br />If you have Linux, i can give you the full source code, at the end
<br />it will be released under the terms of the GPL, when it´s working (i hope
<br />that´s this decade <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )
<br /><br />My Matrices are saved in a float[16] that´s row ordered (as in OpenGL):
<br />m[0] m[4] m[8] m[12]
<br />m[1] m[5] m[9] m[13]
<br />m[2] m[6] m[10] m[14]
<br />m[3] m[7] m[11] m[15]
<br /><br />At first a i had some segmentation faults, but i got them fixed very quick,
<br /><br />The rendered goldfish looks like every thing else at the moment  <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53013" date="Posted: Fri Sep 24, 2004 8:18 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">BTW: Has anyone written a MD5Viewer in C (not C++) and may give me the sourcecode?
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53015" date="Posted: Fri Sep 24, 2004 8:26 pm "><author>bozo</author><body><![CDATA[<div class="postbody">@der_flo
<br /><br />i doesn't know how your matrix func's work, but
<br /><br /><br />* maybe in the mat_mul func ie. vMatrix4x4Multiply(&amp;trans_mat,&amp;tmp_mat,&amp;tmp_mat); you overwrite the data of the tmp_mat and use not the orignal values but the new calced one's to calc the next new values, so the calc goes wrong
<br />ie.
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">in1 = trans_mat<br />in2 = out = tmp_mat<br />out[0][0] = in1[0][0] * in2[0][0] + in1[0][1] * in2[1][0] + in1[0][2] * in2[2][0];<br />out[0][1] = in1[0][0] * in2[0][1] + in1[0][1] * in2[1][1] + in1[0][2] * in2[2][1];<br />...<br />out[1][0] = in1[1][0] * in2[0][0] + in1[1][1] * in2[1][0] +   in1[1][2] * in2[2][0];<br />out[1][1] = in1[1][0] * in2[0][1] + in1[1][1] * in2[1][1] +   in1[1][2] * in2[2][1];<br />...<br /></div><br />i hope it is understandable what i mean<br /><br /><br />* maybe the order of the matrices for the mat_mul func is wrong, you can try to flip them<br />ie.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Matrix4x3_Multiply(rotmat, transmat, out);<br />Matrix4x3_Multiply(out, parentbone-&gt;worldmat, bone-&gt;worldmat);<br /></div>
<br /><br /><br />unfortunately i dont have linux, but maybe the source can be compiled/ported to win?</div>]]></body></post><post id="p53016" date="Posted: Fri Sep 24, 2004 8:43 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />i have allready fixed that problem, i make a lokal copy of tha dest matrix,
<br />and after the calculation is ready i copy the temp matrix to the destination.
<br /><br />i have tested this, but i think with matrix multiplication it doesn´t
<br />matter which comes first, by quaternions it matters.
<br /><br />I copyed the source to my webserver, you can download it at:
<br /><a href="https://web.archive.org/web/20071110063157/http://www.dotbox.org/code/anim.zip" class="postlink">http://www.dotbox.org/code/anim.zip</a> something about 430 KB
<br /><br />It should be easy to port to windows, it is using the sdl, gl and glu lib,
<br />i think there are no linux specific implementations at the moment.
<br />A linux Makefile is also in the package, also the binary and the object files (which makes it so big).
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53026" date="Posted: Fri Sep 24, 2004 9:49 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Matrix multiplications are not commutative, so A * B is not necessarily B * A, if that's what you mean.
<br /><br />KPixel's viewer is available in sourcecode, but it's C++. I don't think that's a big deal though, you won't want to copy&amp;paste it anyway, but just take a look and understand how it works?</div>]]></body></post><post id="p53033" date="Posted: Fri Sep 24, 2004 10:22 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@der_toni searched for the source code, but it was nowhere available, but then i tryed to start this binary with wine and it extracted the source code, so: thank you for this hint, i will study this code.
<br />But first i will watch Beavis and Butthead (now on MTV-Germany)  <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53158" date="Posted: Sat Sep 25, 2004 3:39 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />correct me if i am wrong, but could it be, that the quaternions in the
<br />baseframe are (after a successfull calculation) the same as the on
<br />given in the md5mesh file?
<br /><br />I ask this becouse i just want to make debuging easier for me,
<br />and if this is the case, than i will write a small app, that does nothing
<br />more than calculating this quaternions and if i get the right values,
<br />i can reimplement that in my game eninge.
<br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53162" date="Posted: Sat Sep 25, 2004 4:20 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">No, the baseframe is not the same pose as the bindpose from the md5mesh. It's the pose of the first frame of the animation.</div>]]></body></post><post id="p53163" date="Posted: Sat Sep 25, 2004 4:21 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i have take a first look on your code, after i must change it to be able to compile it in vc
<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files
<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files
<br /><br />- in models_load.c:
<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);
<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);
<br /><br />- use the following func, the other implementation does not work with the d3 quat's
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /><br /><br />- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div>
<br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c
<br /><br /><br />i tested it with the imp model and with this the bindpose works right
<br />but the anims are not ok currently
<br />i will take another look on this</div>]]></body></post><post id="p53170" date="Posted: Sat Sep 25, 2004 4:42 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">@bozo
<br /><br />First of all thank for your work
<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i have take a first look on your code, after i must change it to be able to compile it in vc<br /><br />- you have defined variables in the middle of the code, vc doesn't handle this, only on the blockstart in .c files<br /><br />- your reading code doesn't handle commandline with other than "" in the md5mesh und md5anim files<br /></div><br /><br />I will clean up the loader after this is running, the model that i try to render<br />is a simple goldfish, you can find it in the blender 2 md5 export script from <br />der_ton and in this model there is no content in this two "", but thank you <br />for that tip.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in models_load.c:<br />anim-&gt;anim_frames[i].ori = (vec3_t *)malloc(sizeof(vec3_t)*anim-&gt;numJoints);<br />must be anim-&gt;anim_frames[i].ori = (vec4_t *)malloc(sizeof(vec4_t)*anim-&gt;numJoints);<br /></div><br /><br />I have fixed that, also the some lines below that the fscanf instruction<br />has been fixed, to write the values to the right places.<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- use the following func, the other implementation does not work with the d3 quat's<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void vQuaternionToMatrix(vec4_t *quat, matrix4x4_t *mat) {<br />   float xx, xy, xz, xw, yy, yz, yw, zz, zw;<br />   float x2, y2, z2;<br />   x2 = quat-&gt;x + quat-&gt;x;<br />   y2 = quat-&gt;y + quat-&gt;y;<br />   z2 = quat-&gt;z + quat-&gt;z;<br /><br />   xx = quat-&gt;x * x2;   xy = quat-&gt;x * y2;   xz = quat-&gt;x * z2;<br />   yy = quat-&gt;y * y2;   yz = quat-&gt;y * z2;   zz = quat-&gt;z * z2;<br />   xw = quat-&gt;w * x2;   yw = quat-&gt;w * y2;   zw = quat-&gt;w * z2;<br /><br />   mat-&gt;m[0] = 1.0f - (yy + zz);<br />   mat-&gt;m[1] = xy + zw;<br />   mat-&gt;m[2] = xz - yw;<br /><br />   mat-&gt;m[4] = xy - zw;<br />   mat-&gt;m[5] = 1.0f - (xx + zz);<br />   mat-&gt;m[6] = yz + xw;<br /><br />   mat-&gt;m[8] = xz + yw;<br />   mat-&gt;m[9] = yz - xw;<br />   mat-&gt;m[10] = 1.0f - (xx + yy);<br /><br />   mat-&gt;m[3]  = mat-&gt;m[7] = mat-&gt;m[11] = mat-&gt;m[12] = mat-&gt;m[13] = mat-&gt;m[14] = 0;<br />   mat-&gt;m[15] = 1;<br /><br />   return;<br />}<br /></div><br /><br />and use this func also in models_load.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vQuaternionToMatrix(&amp;quat, &amp;tmp-&gt;bones[i].mat);<br />tmp-&gt;bones[i].mat.m[12]  = tmp-&gt;bones[i].pos.x;<br />tmp-&gt;bones[i].mat.m[13]  = tmp-&gt;bones[i].pos.y;<br />tmp-&gt;bones[i].mat.m[14]  = tmp-&gt;bones[i].pos.z;<br /></div><br /></div><br /><br />done<br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">- in iCalcBones(struct s_models *model) handle parentbones<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">...<br />for (i=0; i&lt;anim-&gt;numJoints; i++) {<br />     QuaternionSlerp(&amp;currframe-&gt;ori[i],&amp;nextframe-&gt;ori[i],interpol,&amp;model-&gt;bones[i].quat);<br />     vQuaternionToMatrix(&amp;model-&gt;bones[i].quat,&amp;mat);<br /><br />     mat.m[12] = currframe-&gt;pos[i].x + interpol * (nextframe-&gt;pos[i].x - currframe-&gt;pos[i].x);<br />     mat.m[13] = currframe-&gt;pos[i].y + interpol * (nextframe-&gt;pos[i].y - currframe-&gt;pos[i].y);<br />     mat.m[14] = currframe-&gt;pos[i].z + interpol * (nextframe-&gt;pos[i].z - currframe-&gt;pos[i].z);<br />     if (model-&gt;bones[i].parent != NULL) {<br />      //vMatrix4x4Multiply(&amp;mat, &amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;model-&gt;bones[i].worldmat);<br />      vMatrix4x4Multiply(&amp;model-&gt;bones[i].parent-&gt;worldmat,&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />     else {<br />        vMatrix4x4Copy(&amp;mat,&amp;model-&gt;bones[i].worldmat);<br />     }<br />  }<br />...<br /></div><br /><br />- change the baseframe pos and ori to pointers (numJoints) and change the animloadercode for this in models_load.c<br /></div><br /><br />Done <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br /><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i tested it with the imp model and with this the bindpose works right<br />but the anims are not ok currently<br />i will take another look on this</div>
<br /><br />You mean the baseframe or the bones from the md5mesh?
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53171" date="Posted: Sat Sep 25, 2004 4:44 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />forget my last question about the bindpos, der_ton answered that allready.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53173" date="Posted: Sat Sep 25, 2004 5:10 pm "><author>bozo</author><body><![CDATA[<div class="postbody">- i mean when i copy the md5mesh bones mat's over to the worldmat's
<br /><br />- in models_load.c:
<br />fscanf(fp,"numAnimatedComponents %d\n",&amp;anim-&gt;numAnimatedComponents);
<br />the \n was missing
<br /><br />than the next two "fgets(foobar2,200,fp);" are too much, only the third is needed
<br /><br />one of the "fgets(foobar2,200,fp);" before "fscanf(fp,"baseframe {");" is too much
<br /><br />- i had overlooked your commented "vCalcInterpolation(mod,dummy);", so the anim-&gt;interpol goes wrong, now uncommented
<br /><br />- now the anim works <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> (tested with the imp model) (the fish anim is really strange, no good for testing)</div>]]></body></post><post id="p53177" date="Posted: Sat Sep 25, 2004 5:37 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks man, but unfortunately it´s not working
<br />here, can you send me the source code and that imp
<br />model please?
<br /><br />Wow, i can not belief that you get it to working, you rock man <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Regards
<br /><br />Flo</div>]]></body></post><post id="p53184" date="Posted: Sat Sep 25, 2004 6:14 pm "><author>der_flo</author><body><![CDATA[<div class="postbody">Hello,
<br /><br />with the help from bozo i got it running, but could try to load
<br />this fish model from der_ton´s blender export script with a viewer
<br />(all viewers i have seen are for windows, and i dont have windows here)
<br />becouse it seems like there is a bug in that md5anim file.
<br /><br />The md5mesh file is ok, the model looks like expected, but even
<br />with the new viewer code (with which the imp model works) that
<br />fish looks kind of strange.
<br /><br />Kind regards
<br /><br />Flo</div>]]></body></post><post id="p53196" date="Posted: Sat Sep 25, 2004 7:02 pm "><author>bozo</author><body><![CDATA[<div class="postbody">i load that fish.md5mesh and fish.md5anim with der_ton's 3dsmax importer in max and in der_ton's model viewer,
<br />and the anim are strange, so it's the model not the code,
<br />it's not an good sample to test with to build a viewer</div>]]></body></post><post id="p53306" date="Posted: Sun Sep 26, 2004 10:24 am "><author>der_ton</author><body><![CDATA[<div class="postbody">You have to use a newer CVS snapshot version of blender with that script, the standard 2.34 release has a bug that is a showstopper for the script to work properly.
<br />I wrote about that in the exporter thread, and also a link to the blender forum thread where there's some explanation on that.
<br /><br />So I'm pretty sure that's why the exported animation you are getting is borked up. It works with the Blender build that I'm using.
<br /><br /><div class="quotetitle">exporter script's readme.txt wrote:</div><div class="quotecontent">You need to have the patched version of Blender (standard 2.3.4 will NOT work <br />correctly because of a bug in the Python API). Get that version here:<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063157/http://www.letwory.net/cvsbuilds/bf_blender_windows_20040810.zip">http://www.letwory.net/cvsbuilds/bf_ble ... 040810.zip</a><!-- m --><br /></div></div>]]></body></post><post id="p53315" date="Posted: Sun Sep 26, 2004 11:24 am "><author>der_flo</author><body><![CDATA[<div class="postbody">Thanks, i will try to compile blender from cvs and try it again.
<br /><br />Kind Regards
<br /><br />Flo</div>]]></body></post><post id="p63603" date="Posted: Wed Nov 17, 2004 10:13 pm "><author>julienr</author><body><![CDATA[<div class="postbody">I've written a short tutorial about loading md5meshes. The only problem is that it is in french. (i'll try to translate it to english, but my skills aren't very good). But i've written a demo application and since c++ is international, it could perhaps be helpfull <img src="https://web.archive.org/web/20071110063157im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br />tutorial : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063157/http://www.fhtagn.net/index.php?section=md5_tuto1.html">http://www.fhtagn.net/index.php?section=md5_tuto1.html</a><!-- m -->
<br />demo : <!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063157/http://www.fhtagn.net/archives/md5_tut1.tar.bz2">http://www.fhtagn.net/archives/md5_tut1.tar.bz2</a><!-- m --> (works on Linux, use SDL &amp; SDL_image &amp; Opengl, so should also works on Windows, OSX)
<br /><br />There's currently no model in the demo, since i haven't found any freely redistribuable one...</div>]]></body></post><post id="p65745" date="Posted: Thu Dec 02, 2004 10:23 am "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey, I was just wondering if I could get some help.  I have a fairly completed MD5 model/anim viewer, but my anim stuff is going all crazy.  Sounds like this was everyone's source of a headache for a while.  Ok, the problem is while converting the baseframe joints from relative to absolute coords I get slight errors in the resulting calculations.  I know this because I am using julienr's code to check against my prog's calculations.  The way I am converting to absolute coords is similar to what nohbdy did back on page 2 of this thread.  Julienr is doing a pre-order hierarchy tree traversal that equates to the same thing.  However, his works and mine gets major distortion in the animated mesh.  I did a diff on the numbers that both our programs crunch for that part and thats where I find that after the first 2 joint calculations that my prog is off very slightly.  Here's a piece of the diff:
<br /><br />3c4
<br />&lt; joint.pos = (15.9678 -0.0144658 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br />---
<br />&gt; joint.pos = (15.9678 -0.0144647 11.3845) + (1.09556 -0.0404358 -0.00858671) * (0.5 0.5 0.5 0.5)
<br /><br />Look at the y-term of the vector in each (my prog is the top).
<br /><br />And, after this point the error propagates larger and larger.  The skinning the bindpos, however, is flawless.  So, Im confused.  The ordering of the joints before running through the algorithm doesnt seem to matter (cause the parent joints are always before their children in the file).
<br /><br />Well, Ive investigated this problem for a few days now...very frustrating.  If anyone has anything to tell me, thank you * 1000.  heh</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110064347im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110064347im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110064347im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064347/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064347/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064347/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110064347/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110064347im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110064347im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110064347im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110064347im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110064347im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110064347im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p66268" date="Posted: Sat Dec 04, 2004 11:43 pm "><author>boomcannon</author><body><![CDATA[<div class="postbody">Hey...forget it...heh...I figured it out.  It runs like a champ now, and it had nothing to do with the way I was building the absolute skeletons from the relative base skeleton.  It was quite enfuriating though because I knew my mathematics were correct and my algorithms were sound.
<br /><br />A word to the next programmer who makes an MD5 loader:  Youre probably gonna make it in the sequence of "handle .md5mesh file" first and then "handle .md5anim" file.  And, when you do this, you might be tempted to compute the "real" value of the orientation quaternion in your BindMesh() function--because it is the first spot where it will be needed.  But, DONT do that as it leads to a very difficult bug to find when your .md5mesh loader works perfectly and then your .md5anim loader (which also computes the "real" of the orientation quaternion) works in a rather peculiar way.  The reason as hind-sight would show me is because...hey...youre computing the "real" component in your function that forms the absolute skeleton to be binded to...and...youre destroying the orientation quaternion by computing it again in the BindMesh() function which actually "skins" the skeleton.
<br /><br />Well, thats my contribution to the thread:  A fix to my own problem...and warning of that pitfall.  Until, of course, I release the source to my viewer (which, as it turns out, despite the slippery bug that just got eradicated, isnt a half-bad piece of software engineering)
<br /><br />Keep Coding...laterz</div>]]></body></post><post id="p67311" date="Posted: Sun Dec 12, 2004 1:40 am "><author>Sfpiano</author><body><![CDATA[<div class="postbody">Suprise, suprise, I too am having difficulties with the animation. The frames don't even load properly, except for the baseframe; I just get this distorted mesh for the rest of them.
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">for all joints<br />newPos = baseframe.pos;<br />newQuat = baseframe.quat;<br /><br />go through the bitflag, update if necessary<br />build w component of quat<br /><br />Normalize quat<br /><br />if( no parent ) {<br />   joint[i].vPos = newPos;<br />   joint[i].QuatRot = newQuat;<br />   Build joint matrix from quat<br />}<br />else { // Parent<br />   Build joint matrix from quat<br />   joint.mat *= parent.mat<br />        joint.pos = newPos transformed by builtMatrix<br />        joint.pos += parent.pos;<br />}</div></div>]]></body></post><post id="p100020" date="Posted: Mon Jun 20, 2005 6:51 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Hello, I'm building a MD5 loader too, but I got a problem with normals.
<br /><br />How do you pre-compute vertex normals with vertex weights? (or how do you generate "normal weights" as vertex weights?)</div>]]></body></post><post id="p100116" date="Posted: Tue Jun 21, 2005 3:00 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">First you have to get the bind-pose model-space normals by calculating them from the model geometry in bind-pose. Then you calculate the weight's normal (which is in bone-space) by invert-transforming the normal by the bone-space matrix. So afterwards when animating, you'll transform the weight normal with the animated bone-space matrix and add them all up and you'll get back your animated vertex normal.</div>]]></body></post><post id="p100174" date="Posted: Tue Jun 21, 2005 6:56 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Thanks !!!
<br /><br />I was sure the algorithm wasn't so complicated, but these multiple vertex weights confused me and I was completely lost... I tried numerous of eccentric and erroneous methods to get them <img src="https://web.archive.org/web/20071110063648im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":-)" title="Smile" /><br /><br />Here's my own function I use for pre-computing the normals (if it can help others):
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// --------------------------------------------------------------------------<br />// Md5Mesh::computeWeightNormals<br />//<br />// der_ton said:<br />//<br />// * First you have to get the bind-pose model-space normals by calculating<br />//   them from the model geometry in bind-pose.<br />//<br />// * Then you calculate the weight's normal (which is in bone-space) by<br />//   invert-transforming the normal by the bone-space matrix.<br />//<br />// * So afterwards when animating, you'll transform the weight normal with<br />//   the animated bone-space matrix and add them all up and you'll get<br />//   back your animated vertex normal.<br />// --------------------------------------------------------------------------<br /><br />void Md5Mesh::computeWeightNormals( Md5Skeleton &amp;skel )<br />{<br />  vector&lt;Vector3f&gt; bindposeVerts( _numVerts );<br />  vector&lt;Vector3f&gt; bindposeNorms( _numVerts );<br /><br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   // Zero out final vertex position and final vertex normal<br />   bindposeVerts[i] = kZeroVectorf;<br />   bindposeNorms[i] = kZeroVectorf;<br /><br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     const Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     // Calculate transformed vertex for this weight<br />     Vector3f wv = pWeight-&gt;pos;<br />     pJoint-&gt;orient.rotate( wv );<br /><br />     bindposeVerts[i] += (pJoint-&gt;pos + wv) * pWeight-&gt;bias;<br />   }<br />  }<br /><br />  // Compute triangle normals<br />  for( unsigned int i = 0; i &lt; _numTris; ++i ) {<br />   const Md5Triangle_t *pTri = _tris[i];<br /><br />   Vector3f triNorm( -ComputeNormal( bindposeVerts[ pTri-&gt;index[0] ],<br />      bindposeVerts[ pTri-&gt;index[1] ], bindposeVerts[ pTri-&gt;index[2] ] ) );<br /><br />   for( int j = 0; j &lt; 3; ++j ) {<br />     bindposeNorms[ pTri-&gt;index[j] ] += triNorm;<br />   }<br />  }<br /><br />  // "Average" the surface normals, by normalizing them<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   bindposeNorms[i].normalize();<br />  }<br /><br />  //<br />  // At this stage we have all vertex normals computed<br />  // for the model geometry in bind-pos<br />  //<br /><br />  // Zero out all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm = kZeroVectorf;<br />  }<br /><br />  // Compute weight normals by invert-transforming the normal<br />  // by the bone-space matrix<br />  for( unsigned int i = 0; i &lt; _numVerts; ++i ) {<br />   for( int j = 0; j &lt; _verts[i]-&gt;countWeight; ++j ) {<br />     Md5Weight_t *pWeight = _weights[ _verts[i]-&gt;startWeight + j ];<br />     const Md5Joint_t *pJoint = skel.getJoint( pWeight-&gt;joint );<br /><br />     Vector3f wn = bindposeNorms[i];<br /><br />     // Compute inverse quaternion rotation<br />     Quaternionf invRot = Inverse( pJoint-&gt;orient );<br />     invRot.rotate( wn );<br /><br />     pWeight-&gt;norm += wn;<br />   }<br />  }<br /><br />  // Normalize all weight normals<br />  for( unsigned int i = 0; i &lt; _numWeights; ++i ) {<br />   _weights[i]-&gt;norm.normalize();<br />  }<br />}<br /></div>
<br /><br />I will post a link to download my MD5 viewer source code when it will be more or less finished.
<br /><br /><img src="https://web.archive.org/web/20071110063648im_/http://tfc.duke.free.fr/screens/md5_zfat_wireframe.png" alt="Image" /><br /><br /><img src="https://web.archive.org/web/20071110063648im_/http://tfc.duke.free.fr/screens/md5_zfat_filled_with_normals.png" alt="Image" /></div>]]></body></post><post id="p100213" date="Posted: Tue Jun 21, 2005 9:32 pm "><author>der_ton</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Dhenry wrote:</div><div class="quotecontent">I will post a link to download my MD5 viewer source code when it will be more or less finished. </div>
<br />Very cool, thanks!</div>]]></body></post><post id="p100229" date="Posted: Tue Jun 21, 2005 10:43 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">How likely would it be for someone to collect the information in this thread and write up some file specifications articles for the wiki?
<br /><br />I suppose I could write up an article for MD5Camera.</div>]]></body></post><post id="p100254" date="Posted: Wed Jun 22, 2005 3:26 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody"><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063648/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />Done.</div>]]></body></post><post id="p100431" date="Posted: Thu Jun 23, 2005 6:51 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Okay, now I've drafted up articles for all three and I have no clue if they are accurate.
<br /><br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063648/http://wiki.doom3reference.com/wiki/MD5MESH_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063648/http://wiki.doom3reference.com/wiki/MD5ANIM_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><!-- m --><a class="postlink" href="https://web.archive.org/web/20071110063648/http://wiki.doom3reference.com/wiki/MD5CAMERA_%28file_format%29">http://wiki.doom3reference.com/wiki/MD5 ... _format%29</a><!-- m -->
<br /><br />I need you guys' help please.
<br /><br />There's a cookie in it for you. Mmmmmm. <img src="https://web.archive.org/web/20071110063648im_/http://www.doom3world.org/phpbb2/images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>]]></body></post><post id="p100465" date="Posted: Thu Jun 23, 2005 10:53 am "><author>der_ton</author><body><![CDATA[<div class="postbody">I only made some minor edits to the md5mesh article, and completed a few things in the md5anim article. Good job, rich. Keep your cookies.  <img src="https://web.archive.org/web/20071110063648im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p107381" date="Posted: Mon Aug 08, 2005 5:59 pm "><author>reklipz</author><body><![CDATA[<div class="postbody">Hey guys.
<br /><br />I'm currently in the middle of writing an anim loader for my viewer
<br /><br />Heres my questions:
<br /><br />I am trying to render the baseframe of the animation, just so that i know i get my calcs right
<br /><br />I am a bit confused as to how to calculate the position and the rotation of the joint in the bind pose, this is how I am currently trying to do it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if thisJoint has a parent<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = thisJoint.quatvalues + thisjointsparent.quatvalues;</div>
<br /><br />something seems to be Very wrong
<br /><br />if someone could tell me the algorithm to calculate the position and quat of the baseframes joints, it would be GREATLY appreciated</div>]]></body></post><post id="p107642" date="Posted: Wed Aug 10, 2005 5:58 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">For the bind-pose skeleton, from the .md5mesh files, you don't need to compute any position or rotation for the joints. The skeleton's joints are already transformed.
<br /><br />For the baseframe skeleton, from the .md5anim files, you have to rebuild it by transforming each joint:
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">if thisJoint has a parent {<br />   build the matrix from this joints parents quat values;<br />   thisJoint.pos = thisJoint.pos * built matrix + thisJointsParent.pos;<br />   thisJoint.quatvalues = <span style="color: red">thisjointsparent.quatvalues * thisJoint.quatvalues;</span><br />}</div>
<br />Be careful at the order of the concatenation for quaternions and matrices. Here the * operator for quaternions means “concatenation”, and it is backward the standard quaternion multiplication (Qa x Qb is the concatenation of Qb and Qa). You must concat parent joint's orientation with joint's orientation.</div>]]></body></post><post id="p107643" date="Posted: Wed Aug 10, 2005 6:12 pm "><author>Dhenry</author><body><![CDATA[<div class="postbody">Ok my own MD5 viewer seems to be quite advanced:
<br /><img src="https://web.archive.org/web/20071110063648im_/http://tfc.duke.free.fr/screens/md5loader.png" alt="Image" /><br /><br />I would like to release the code publicly, but I need at least a model and an animation + texture (with bump and specular) in order to show how to load them (it is not so easy :/). Currently, I use the player.md5mesh and the zfat model and its animations from the Doom3 demo, but I'm not sure I can distribute my demo with them so I will not give a direct link to it for the moment...
<br /><br />Anyway, you can find the code (binaries and samples) on my website by browsing the ftp ... it's in old/models/md5loader-08.tar.bz2 (~8,3 MB)
<br />It is not completely finish, I have to build the OBB from bind-pose skeleton, improve the bump mapping with the height map and correct some little bugs under windows (drag&amp;drop, fullscreen).
<br /><br />You can replace the default.loader file by zfat.loader to try with the fatty zombie (which is animated.. you can change current animation with '&lt;-' and '-&gt;'.. I forgot it in the readme :s)
<br /><br />for bump mapping, it uses GLSL, so if you haven't a card that support OpenGL 2.0 (or OpenGL 1.5 with full GLSL 1.0 support), bump mapping will be disabled.</div>]]></body></post><post id="p122901" date="Posted: Fri Nov 25, 2005 5:15 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello guys,
<br /><br />1. Sorry by my poor english
<br /><br />2. Very thank you all for that thread. It helps me to begin what will be (as I hope) my project for my mastering thesis
<br /><br />3. I have won on make a viewer thanks of information posted on this thread. 
<br /><br />But I have many questions, maybe you could help me:
<br /><br />a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?
<br /><br />b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? 
<br /><br />c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?
<br /><br />d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?
<br /><br />e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?
<br /><br />One more time I would like to say sorry by my poor english and my fool questions. Also I would like to thanks your attention. 
<br /><br />If any of you could answer my questions or point some site or article I could read I would be very happy.</div>]]></body></post><post id="p122963" date="Posted: Fri Nov 25, 2005 5:38 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Welcome to the forum!
<br /><br /><div class="quotetitle">mcamilo wrote:</div><div class="quotecontent">a. I am interested in how the animations are created. The normal path would be create a model and animations in a modeller software (as MAX) and so convert it to md5? Is it correct? There is a modeller specially created for doing md5 models?</div><br />Yes they were created in modellers (Maya) and converted to md5. Making a modeller just for md5 wouldn't make sense.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">b. I would like to know how some issues about IA of the characters are made in DOOM3. For instance how create a finite state machine of states that are controlled by events? How connect each state with a animation? </div><br />That's done with scripting. I don't know details about that but there's plenty of info on the forum, and if you are a programmer you will probably see what's going on by looking at the game files.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">c. How have been done the transitions between animations? I mean suppose two animations that will be played sequencially. If the first animation don´t have a final position (or should I say pose) that is the same of the first position of the second animation? How could I connect this two positions? Could I interpolate this two positions?</div><br />Yes I think that's what they do, interpolation.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">d. How is treated problems like collision? For instance, if a animation result in a collision before it´s finished. What is done? The animation is stopped, or it´s is shifted so as the model in each pose never enter a wall?</div><br />I don't know exactly but I've never seen a model's animation being stopped because of collision. My guess is that the engine doesn't care, but maybe it shifts the origin position so that the collision is avoided.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">e. About the bounds. They serve as a AABB (Axis Aligned Bounding Box)? They are oriented for the baseframe? How could they be rotate or translate so as to always encluse the model in each position?</div>
<br />The bounding box is specified for each frame in a md5anim.</div>]]></body></post><post id="p123010" date="Posted: Sat Nov 26, 2005 3:39 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Thank you Der_Ton, 
<br /><br />I feel I am begining of get it. 
<br /><br />But here I go again:
<br /><br />a. Can you say something more about scripting? 
<br /><br />b. Maybe I have not made myself very clear. Suppose two animations where the final pose of the first is not the same of the second. When I play this two animations sequencially there´s a freak movement between this two poses. The idea was to made this transition smoothly. But the problem is with quaternions. I guess that the quaternions of this two poses cannot be interpolated (it would be wrong interpolated them?) because the quaternions of the first is oriented for the first animation and the quaternions of the second is oriented for the seconde animation. If I am correct (I don´t know if I am) there should be quaternions and tranlations to create this transition between this two poses. But If it´s was not created by designer, could it be created on the fly?
<br /><br />c. I agree that it should be the best aproach. 
<br /><br />d. Yes, yes very good.  
<br /><br />I that´s not the right place to ask that but maybe You can help me with that. Could any one do a description or point some place about HalfLife 2 (or even Half Life1), Unreal, Halo, etc; models just like Bozo have done with MD5?
<br /><br />One more time thank you (specially to Der_Ton) and sorry by my 'irck' english.</div>]]></body></post><post id="p123053" date="Posted: Sat Nov 26, 2005 10:32 am "><author>der_ton</author><body><![CDATA[<div class="postbody">a: No, like I said I don't know the details, I haven't spent time with that part of the engine. But if you look at the monster script files (in pak000.pk4/script/ai_monster_*.script) you'll quickly see what it's about. 
<br /><br />b: Yes, the interpolation can be created on the fly, interpolation doesn't mean interpolation between the last frame of the 1st anim and the 1st frame of the 2nd anim, but it means interpolating over a time interval to shift from one anim to the other.
<br />For example a transition from walk to run can be done by having half a second of transition where you calculate the animated poses from anims each frame, and then interpolate between the two poses with a shifting interpolation value from 0% at 0.0secs (pose is the walk pose) to 100% at 0.5 secs (pose is the run pose). I *think* that D3 does that but I can't prove it with code. I don't know if this part is in the engine or in the SDK.</div>]]></body></post><post id="p123252" date="Posted: Mon Nov 28, 2005 5:11 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hello, 
<br /><br />Thanks one more time Der_Ton. 
<br /><br />About the scripts I will look up the information where you pointed. 
<br /><br />Sorry I think I am still lost about the transitions between two animations. If I understood what You´ve said I should make a interpolation of frames that begins with a more weight to the 1st animation and as time pass this weight will pend to the 2nd animation. Is it correct?
<br /><br />But I am still confused about how doing that relation between the two poses (from the 1st and the 2nd) to each frame of the transition. 
<br /><br />Because I can´t see how two poses from diferent animations could be interpolated (linear and spherically) since they have a diferente "format" (I mean a diferent set of orientations and translations) that can not (at least as I see) matched to build interpolant factors.    
<br /><br />What should it really means =&gt; 20% (pose from 1st) + 80% (pose from 2nd), for instance?
<br /><br />How am I supposed to make it? Would it be that after each pose, from the 1st and the 2nd, was completely calculated (with joints contribution, and interpolation between poses from the same animation and all), I should interpolate linearly each point of that two poses? Is that what you propose? It really makes sense but I will have to try to give it the force of an experice. 
<br /><br />(Sorry I know my english are killing you)
<br /><br />Thank for the attention.</div>]]></body></post><post id="p123913" date="Posted: Fri Dec 02, 2005 1:24 pm "><author>Groove</author><body><![CDATA[<div class="postbody">I am trying to render MD5 with shadow volume but I have some problem. A friend make me a MD5 cube to my test but its model wasn't closed. 
<br /><br />He uses the Der_Ton's MD5 exporter, Is it a problem with an exporter option or from the model he done with 3dsmax?
<br /><br />The fellowing picture shadow that there is more one marker for each vertex... so it's a problem to find the model edges need by shadow volume.
<br /><img src="https://web.archive.org/web/20071110063648im_/http://img461.imageshack.us/img461/2814/shadowvolumecube27wx.jpg" alt="Image" /><br /><br />Anyway, I have build me own md5 files using notepad:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline ""<br /><br />numJoints 1<br />numMeshes 1<br /><br />joints {<br />   "Bone01"   -1 ( 0.0000000000 0.0000000000 0.0000000000 ) ( 0.0000000000 0.0000000000 1.0000000000 )      //<br />}<br /><br />mesh {<br />   shader "undefined"<br /><br />   numverts 8<br />   vert 0 ( 0.0000000000 0.0000000000 ) 0 1<br />   vert 1 ( 0.0000000000 0.0000000000 ) 1 1<br />   vert 2 ( 0.0000000000 1.0000000000 ) 2 1<br />   vert 3 ( 0.0000000000 1.0000000000 ) 3 1<br />   vert 4 ( 1.0000000000 0.0000000000 ) 4 1<br />   vert 5 ( 1.0000000000 0.0000000000 ) 5 1<br />   vert 6 ( 1.0000000000 1.0000000000 ) 6 1<br />   vert 7 ( 1.0000000000 1.0000000000 ) 7 1<br /><br />   numtris 12<br />   tri 0 0 4 6<br />   tri 1 0 6 2<br />   tri 2 4 5 7<br />   tri 3 4 7 6<br />   tri 4 2 6 7<br />   tri 5 2 7 3<br />   tri 6 1 0 2<br />   tri 7 1 2 3<br />   tri 8 5 1 3<br />   tri 9 5 3 7<br />   tri 10 1 5 4<br />   tri 11 1 4 0<br /><br />   numweights 8<br />   weight 0 0 1.0000000000 ( 0.0000000000 0.0000000000 0.0000000000 )<br />   weight 1 0 1.0000000000 ( 0.0000000000 0.0000000000 1.0000000000 )<br />   weight 2 0 1.0000000000 ( 0.0000000000 1.0000000000 0.0000000000 )<br />   weight 3 0 1.0000000000 ( 0.0000000000 1.0000000000 1.0000000000 )<br />   weight 4 0 1.0000000000 ( 1.0000000000 0.0000000000 0.0000000000 )<br />   weight 5 0 1.0000000000 ( 1.0000000000 0.0000000000 1.0000000000 )<br />   weight 6 0 1.0000000000 ( 1.0000000000 1.0000000000 0.0000000000 )<br />   weight 7 0 1.0000000000 ( 1.0000000000 1.0000000000 1.0000000000 )<br />}<br /></div><br /><br />And it work, I have generate the shadow volume from the MD5 file: <br /><img src="https://web.archive.org/web/20071110063648im_/http://img467.imageshack.us/img467/1449/shadowvolumecube18rl.jpg" alt="Image" /><br /><br />But even if my cube works, the Doom3 models don't... Maybe, this means that mine is wrong or that Doom3 models aren't closed (This second case  is what my program tell). But if the second case is true, how Doom3 does to find edges to render shadow volume?<br /><br />When I render a MD5 model I see that there is just one marker be vertex so this should means that there is only one "true vertex per vertex" or there is a true vertex for each triangle that uses the vertex and for each of these vertrices markers are the same so I can see how many true vertex there are by vertex.<br /><br /><img src="https://web.archive.org/web/20071110063648im_/http://img451.imageshack.us/img451/4463/shadowvolumetrite5ng.jpg" alt="Image" /><br /><br />To create my edges I use an technique by Eric Lengyel describ in "Mathematics for 3D Game Programming and Computer Graphics"<br /><br />My algorithm is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void md5Mesh::_buildEdges()<br />{<br />    if(m_EdgeArray != null)<br />        delete[] m_EdgeArray;<br />    m_EdgeArray = new md5Edge[m_TrianglesNumber * 3];<br /><br />    m_EdgesNumber = 0;<br /><br />    md5Edge* pEdge = m_EdgeArray;<br /><br />    // Find edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &lt; i2)<br />        {<br />            md5Edge Edge;<br />            pEdge-&gt;VertexIndex[0] = i1;<br />            pEdge-&gt;VertexIndex[1] = i2;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i2 &lt; i3)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i2;<br />            pEdge-&gt;VertexIndex[1] = i3;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br /><br />        if(i3 &lt; i1)<br />        {<br />            pEdge-&gt;VertexIndex[0] = i3;<br />            pEdge-&gt;VertexIndex[1] = i1;<br />            pEdge-&gt;TriangleIndex[0] = i;<br />            pEdge-&gt;TriangleIndex[1] = -1;<br />            pEdge++;<br />            m_EdgesNumber++;<br />        }<br />    }<br /><br />    // Match triangles to edges<br />    for(uint i = 0; i &lt; m_TrianglesNumber * 3; i += 3)<br />    {<br />        int i1 = m_IndiceArray[i + 0];<br />        int i2 = m_IndiceArray[i + 1];<br />        int i3 = m_IndiceArray[i + 2];<br /><br />        if(i1 &gt; i2)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i2) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i1) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i2 &gt; i3)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i3) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i2) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br /><br />        if(i3 &gt; i1)<br />        {<br /><br />            pEdge = m_EdgeArray;<br />            for(uint j = 0; j &lt; m_EdgesNumber; ++j)<br />            {<br />                if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] == -1))<br />                {<br />                    int Tri0 = pEdge-&gt;TriangleIndex[0];<br />                    pEdge-&gt;TriangleIndex[1] = i;<br />                    break;<br />                }<br />                else if((pEdge-&gt;VertexIndex[0] == i1) &amp;&amp;<br />                   (pEdge-&gt;VertexIndex[1] == i3) &amp;&amp;<br />                   (pEdge-&gt;TriangleIndex[1] != -1))<br />                {<br />                    fprintf(stderr, "Triple edge ...\n");<br />                }<br /><br />                pEdge++;<br />            }<br />        }<br />    }<br /><br />   int openEdge = 0;<br />   for(uint i = 0; i &lt; m_EdgesNumber; i++)<br />   {<br />      if(m_EdgeArray[i].TriangleIndex[1] == -1)<br />         openEdge++;<br />   }<br /><br />    fprintf(stderr, "openEdge : %d\n", openEdge);<br />}<br /></div>
<br /><br />And this Doom3 MD5 allmost of all edges are count in openEdge...
<br /><br />So my question: How to create edges to MD5 files?</div>]]></body></post><post id="p134415" date="Posted: Fri Feb 24, 2006 7:36 am "><author>mcamilo</author><body><![CDATA[<div class="postbody">Hi,
<br /><br />first I have to say sorry about my poor english.
<br /><br />second I have to say sorry about my newbies questions.  
<br /><br />I am studying the md5 model to incorporate it in a framework of games. I am a mastering student and Its my mastering project. 
<br /><br />I have succeed in load mesh and anim files and play the animations through this framework
<br /><br />My doubts are about how doom3 handle the transition between two animations?
<br /><br />How they handle the viewing and repositioning of one character. For instance if a character is in opposite of me and it feels me how could he turn to me if there is not an animation of turning movement?
<br /><br />How they handle the transition between two animations. For instance if a character is walking and so suddenly he dies (maybe he was shot). How could I play smoothly the transition of the two movements?
<br /><br />I know maybe you can not answer that questions. But could you point some place to search? How could do to see it in doom3´s code?
<br /><br />It has something with the "rag dolls" working? In time what are rag dolls? It´s a kind of configuration file to handle the .mesh and .anim files? Or what?
<br /><br />What kind of benefit I could earn if worked with rag dolls instead of .mesh and .anim files?</div>]]></body></post><post id="p28420" date="Posted: Wed Aug 04, 2004 2:37 pm "><author>bozo</author><body><![CDATA[<div class="postbody">let's talk about ...
<br />the new formats of the md5mesh and md5anim files
<br /><br />i have take a first look on it and will post here what i have found out, it is not complete
<br /><br />so, start with some excerpts of two example files, i choose the imp:
<br /><br />imp.md5mesh
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "mesh models/monsters/imp/animation/cycles/imp.mb -dest models/md5/monsters/imp/imp.md5mesh -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numJoints 71<br />numMeshes 1<br /><br />joints {<br />   "origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )      // <br />   "Body"   0 ( -0.0000002384 0 56.5783920288 ) ( -0.5 -0.5 -0.5 )      // origin<br />   "Hips"   1 ( 3.3494229317 -0.0225959271 62.0168151855 ) ( -0.5 -0.5 -0.5 )      // Body<br />   ...<br />}<br /><br />mesh {<br />   // meshes: polySurface1<br />   shader "models/monsters/imp/imp"<br /><br />   numverts 891<br />   vert 0 ( 0.8658549786 0.3910109997 ) 1377 2<br />   ...<br /><br />   numtris 1346<br />   tri 0 2 1 0<br />   ...<br /><br />   numweights 1401<br />   weight 0 47 1 ( 1.5918749571 -0.9465401769 4.3310847282 )<br />   ...<br />}<br /></div><br /><br />idle1.md5anim<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">MD5Version 10<br />commandline "anim models/monsters/imp/animation/cycles/idle1.ma -dest models/md5/monsters/imp/idle1.md5anim -game Doom -prefix IMP1_ -keep Lknee Rknee Lelbow Relbow camera Body -keep Rmissile Lmissile -parent Rmissile Rhand -parent Lmissile Lhand -parent Rwing Chest -parent Lwing Chest -parent Hips Body -parent Waist Body -parent camera Head -prefix IMP2_ -prefix IMP_ -align ALL"<br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br />hierarchy {<br />   "origin"   -1 0 0   //<br />   "Body"   0 6 0   // origin ( Ty Tz )<br />   "Hips"   1 3 2   // Body ( Tx Ty )<br />   "Lupleg"   2 56 4   // Hips ( Qx Qy Qz )<br />   ...<br />}<br /><br />bounds {<br />   ( -12.7120218277 -30.5424346924 -0.7133038044 ) ( 18.<br />4121990204 41.8222160339 81.8068695068 )<br />   ...<br />}<br /><br />baseframe {<br />   ( 0 0 0 ) ( -0.5 -0.5 -0.5 )<br />   ( 2.4760267735 51.5447387695 -3.0239832401 ) ( 0 0 -0.0269656405 )<br />   ( 1.0195504427 5.3025918007 3.3494231701 ) ( 0 0 0 )<br />   ...<br />}<br /><br />frame 0 {<br />    51.5447387695 -3.0239832401<br />    1.0195504427 5.3025918007<br />    0.7355086803 -0.3889687657 0.4772257507<br />    0.0189839788 0.0578746125 -0.5245873928<br />    -0.8296036124 0.3866359591 0.0100788241<br />    0.488070637 -0.3712677062 0.7295016646<br />    -0.0142540894 -0.0333928876 -0.5200206041<br />    0.8724460602 -0.4404397309 0.1936372519<br />    1.0421460867 2.7552113533<br />    -0.1609682292 0.0150111886 0.067597121<br />    6.2155857086 5.6233057976 0.0092875436 -0.037551783 -0.0034615761<br />    -5.4427704811 0.0235444643<br />    6.0652527809<br />    0.0415914208 0.1587915123 -0.0024342418<br />    0.1301603615 0.0321234874 -0.2374467552<br />    0.0672957376 -0.1049735919 0.1197357625<br />    0.0461013205<br />    -6.2936215401 -0.2602182925 0.0192391276 -0.4136874974<br />    0.0191769451 -0.1025890633 0.0379714668<br />}<br />...<br /></div><br /><br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5mesh:</span></span><br /><br /><span style="font-weight: bold">Joint:</span><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"origin"   -1 ( 0 0 0 ) ( -0.5 -0.5 -0.5 )</div><br /><br />first the name of the joint<br /><br />second the index of the parentjoint, -1 == no parent<br /><br />the next three numers are the position of the joint x y z<br /><br />the last three numbers are part of the orientation-quaternion<br />the md5 stores only the x y z components<br />there are unit quaternions, so there length are 1.0<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1.0 = x^2 + y^2 + z^2 + w^2</div><br />so to calc the w component do<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float term = 1.0f - (x*x) - (y*y) - (z*z);<br />float qw;<br />if (term &lt; 0.0f)<br />   qw = 0.0f;<br />else<br />   qw = - (float) sqrt(term);<br /></div><br /><br />the position and orientation are also absolute values, no offest to the parent joint<br /><br /><br /><span style="font-weight: bold">Mesh:</span><br /><br />beside some ('s and )'s, it's equal to the old format<br /><br />quick refresh:<br />verts store the uv texcoords and the startindex and count of the weights<br />weights store the jointindex and the weight and x y z pos<br /><br /><br /><br /><span style="font-style: italic"><span style="font-weight: bold">md5anim:</span></span><br /><br />numFrames 80<br />numJoints 71<br />frameRate 24<br />numAnimatedComponents 52<br /><br /><span style="font-weight: bold">hierarchy:</span><br /><br />numJoints entries<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">"Lrib"   21 59 27   // Chest ( Tx Ty Qx Qy Qz )</div>
<br /><br />first the name of the joint
<br /><br />than the parentjoint index
<br /><br />next the flag that tells whitch components are animated in the frames:
<br /><br />six possible components - translation x y z and orientation x y z
<br /><br />one bit for each component:
<br /><br />bit 0 - 1  =&gt; translation x
<br />bit 1 - 2  =&gt; translation y
<br />bit 2 - 4  =&gt; translation z
<br />bit 3 - 8  =&gt; orientation x
<br />bit 4 - 16 =&gt; orientation y
<br />bit 5 - 32 =&gt; orientation z
<br /><br />ie:
<br />56 =&gt; 8+16+32 -&gt; alle three orientation values
<br />6 =&gt; 2+4 -&gt; translation y and z
<br /><br />the last number in the hierarchy entry line are the startindex of the animated components in each frame,
<br />the count of animated components are indicated by the preceding flag
<br /><br /><span style="font-weight: bold">bounds:</span>
<br /><br />numFrames entries
<br />min x y z and max x y z
<br />the boundingbox coordinates are relative to the root bone's position ( at the first frame of the animation ?)
<br /><br /><span style="font-weight: bold">baseframe:</span>
<br /><br />position x y z and orientation x y z (part of quaternion, see md5mesh joint description)
<br /><br />i think this are the pos and orientation of the joints as offsets (relative to each parent joint), unlike the absolute values of the md5mesh joints
<br /><br /><span style="font-weight: bold">frame:</span>
<br /><br />numAnimatedComponents entries
<br /><br />my assumption is the the anim.components are also relative values and are used in combination with the baseframe data, but i have not tried it currently, so some tests are necessarily
<br /><br /><br />when you know some more infos or have some corrections please post it <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28474" date="Posted: Wed Aug 04, 2004 4:22 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">Thanks for taking the time to write this up! I was working on the viewer and thought I'd post the info after I'm done with updating the viewer. There'll probably be an update tomorrow.
<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">i am not sure about the righthand or lefthand issue, so maybe w must be negate</div>
<br />The w component of the quaternions have to be negated, yep:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">w = - sqrt( 1.0f - ( (x*x) + (y*y) + (z*z) ) )</div></div>]]></body></post><post id="p28625" date="Posted: Wed Aug 04, 2004 11:27 pm "><author>sic1</author><body><![CDATA[<div class="postbody">Excellent info. I guess now is as better time than any for me to start learning  quaternions <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p28655" date="Posted: Thu Aug 05, 2004 12:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Oh wait, anybody understand quaternions?. Just use them! <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /><br /><br />Hmm I wish I could have Doom3 to try some MD5 coding!
<br /><br />Greets.</div>]]></body></post><post id="p29823" date="Posted: Sat Aug 07, 2004 3:07 am "><author>sic1</author><body><![CDATA[<div class="postbody">Hmm, I've managed to read in the joint data, however my problem seems to lie with drawing them (and general understanding). Do the X Y Z coords have to be transformed via the orientation quaternion? I'm curious as to everyone's progress <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29880" date="Posted: Sat Aug 07, 2004 4:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">¿Do you mean how to draw the skeleton just like the console command r_showSkel does?.
<br /><br />If so, I only use the positions from the md5mesh file to create the hierarchy. Here you see the code I use for drawing the skeleton in MAX:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fn buildSkeleton =<br />(<br />   -- For each MD5 bone<br />   for auxBone in bones do<br />   (<br />      local bonePos = auxBone.bindPos<br />      local parentBonePos = [0, 0, 0]<br /><br />      -- If the current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Set the current MD5 bone's parent position<br />         parentBonePos = bones[auxBone.parent].bindPos<br />      )<br />      <br />      -- Create the new MAX bone<br />      local newBone = BoneSys.createBone parentBonePos bonePos [0, 0, 1]<br />      newBone.width = 1<br />      newBone.height = 1<br />      newBone.name = copy auxBone.name<br />      <br />      -- If current MD5 bone has a parent...<br />      if auxBone.parent &gt; 0 do<br />      (<br />         -- Assign current MAX bone's parent<br />         newBone.parent = MAXBones[auxBone.parent]<br />      )<br /><br />      -- Add new MAX bone to array of MAX bones<br />      append MAXBones newBone<br />   )<br /><br />   -- Zoom extends to all objects<br />   max zoomext sel all<br />)</div>
<br /><br />But I'm not sure if the result is the correct. Look this image:
<br /><br /><img src="https://web.archive.org/web/20091206232118im_/http://www.arrakis.es/~jonathan01/d3w/fatty_skel.jpg" alt="Image" /><br /><br />That is the MD5 importer I was working on long time ago (it's not finished, though). I was hoping that the "chest" bone would be where the "shoulders" bone is but it seems that's correct. Somebody can confirm that?. Anyway the relationships between bones seems to be correct.
<br /><br />Ah, one question. It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.
<br /><br />BTW, I'm also interested on how the other coders handle this.
<br /><br />Happy coding! <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p29935" date="Posted: Sat Aug 07, 2004 5:51 am "><author>sic1</author><body><![CDATA[<div class="postbody">Ahh, Thanks BeRSeRKeR! The skeleton looks great! I even checked out the bones in game for ya (since I can't go too long without seeing doom)
<br /><br /><img src="https://web.archive.org/web/20091206232118im_/http://home.comcast.net/~sic1/images/misc/fatty_skelgame.jpg" alt="Image" /><br /><br />I was trying to draw the joints out as boxes (like Max's Dummy objects) but I was doing something wrong. It seems there's a bug somewhere in my joint reading code. (You seem to be a good luck charm. ) This is specifically why I am rewriting it, but alas, I haven't learned <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p29953" date="Posted: Sat Aug 07, 2004 6:28 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Hey, thanks for posting that image. Just what I was looking for!. <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p30016" date="Posted: Sat Aug 07, 2004 11:39 am "><author>bozo</author><body><![CDATA[<div class="postbody">@BeRSeRKeR
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> It's possible to draw the skeleton using only the info from the md5anim file or the md5mesh info is necessary?.</div>
<br /><br />with the old fileformats you need the md5mesh file for the parent/child hierarchy infos
<br /><br />but for the other data like position and orientation only the md5anim file,each joint has a pos and orient relative to it's parentjoint,
<br />so you calc the pos and orient for the wished frame for the joint, build a matrix of this values and multiply this matrix with the parent matrix (when available),
<br />with this finalmatrix you can draw the skeleton (use the translationpart of the matrix as the origin of each joint and create the hierarchy)
<br /><br />i dont try the new fileformat at present,
<br />but now the hierarchy info is also in the md5anim files,
<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>]]></body></post><post id="p30063" date="Posted: Sat Aug 07, 2004 2:04 pm "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">bozo wrote:</div><div class="quotecontent">i dont try the new fileformat at present,<br />but now the hierarchy info is also in the md5anim files,<br />so it could be that the data, the baseframe + the animated components in the frames, in the md5anim file are sufficiently to calc the pos and orient of the joints for a wished frame</div>
<br />By the end of the next week I could buy Doom3 so maybe then I will give a try to the new format.
<br /><br />Thanks!.</div>]]></body></post><post id="p30185" date="Posted: Sat Aug 07, 2004 5:27 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">I'm getting a headache from the md5anim format. Some quaternion values seem to toggle their sign, even though the bone doesn't really move. But in my viewer, that sign toggling causes major rotations... anyone has an idea what's going on there?
<br /><br />example:
<br />baseframe: Qx, Qy, Qz: ( -0.802292943 0.5969303846 0.0000000054 )
<br />Qx and Qy are animated components:
<br />frame 14:  -0.8022928834 0.5969305038
<br />frame 15: 0.802292943 -0.5969305634</div>]]></body></post><post id="p30576" date="Posted: Sun Aug 08, 2004 11:13 am "><author>bozo</author><body><![CDATA[<div class="postbody">@der_ton
<br /><br />i didn't try the new md5anim format currently,
<br />but in a other own project, i had troubles that sounds like yours,
<br />here is what i did:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">float cosom = q1[0] * q2[0] + q1[1] * q2[1] + q1[2] * q2[2] + q1[3] * q2[3];<br />if (cosom &lt; 0.0f)<br />{<br />   q2[0] = -q2[0];<br />   q2[1] = -q2[1];<br />   q2[2] = -q2[2];<br />   q2[3] = -q2[3];<br />}<br /></div></div>]]></body></post><post id="p31067" date="Posted: Mon Aug 09, 2004 4:20 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">So.. to export a mesh properly i would need the following data:
<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )
<br />-Mesh Data ( verts &amp; tris &amp; weights )
<br /><br />Some questions:
<br /><br />1. Not sure about the orientation quaternions, do i calculate thosed based off of data i already have, or pull them out of the mesh data?
<br /><br />2. Vertex indexes, is there a specific order in which the verts need to be extracted? 
<br /><br />3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?
<br /><br />4. Im not sure what weights are.. can i get a primer real quick?
<br /><br />5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?
<br /><br />6. Oh, and i just noticed this.. what is the fourth number in the triangles list? 
<br /><br />Im working with the MayaAPI specifically, and hoping to write an importer/exporter. All help is greatly appreciated, so thanks : )</div>]]></body></post><post id="p31078" date="Posted: Mon Aug 09, 2004 4:48 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">So.. to export a mesh properly i would need the following data:<br /><br />-Joints ( name of joint &amp; joint location &amp; index &amp; index of parent joint &amp; orientation quaternion )<br />-Mesh Data ( verts &amp; tris &amp; weights )</div><br />If you only want the geometry data, yes.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">3. Are the numbers following the vertex coordinates the UV coords? If not, what are they and where do the UV's go?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vert 0 ( 0.8658549786 0.3910109997 ) 1377 2</div><br />1st param -&gt; vertex index<br />2nd and 3rd params -&gt; u and v (texture coordinates)<br />4th param -&gt; start of the vertex weights into the array of weights<br />5th -&gt; number of weights starting at 4th param (in this case would be weights 1377 and 1378)<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">4. Im not sure what weights are.. can i get a primer real quick?</div><br />The weights indicate the percentage one vertex is affected by a set of bones, ie. how many influence a bone has over a given vertex. The sum of the vertex weights should be 1.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">5. Once i have all this data, i just need to write it to a file with the same format as all the md5mesh files:  joints { ... } mesh { ... }, ect..?</div><br />Yeah, otherwise Doom3 won't be able to load your models.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">6. Oh, and i just noticed this.. what is the fourth number in the triangles list?</div><br />Example:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tri 0 2 1 0</div>
<br />1st param -&gt; triangle index
<br />2nd, 3rd and 4th params -&gt; vertex indices (a, b, c)
<br /><br />Greetings.</div>]]></body></post><post id="p31091" date="Posted: Mon Aug 09, 2004 5:09 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Cool, thanks for your reply BeRSeRKeR, this is starting to come together a bit for me.
<br /><br />Just a few more questions though, if you guys dont mind:
<br /><br />I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data? 
<br /><br />And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?
<br /><br />And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?
<br /><br />Thanks again for all the help, this forum is great!</div>]]></body></post><post id="p31139" date="Posted: Mon Aug 09, 2004 6:29 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody"><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">I understand the concept of weights now, but im still not sure how to calculate them. Or should i be able to pull them out of the model/mesh data?</div><br />Yes. For example, in MAX you have a set of functions (built in the API) to retrieve weights from the model data. Ok, other modelling packages should support these functions too.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And how do you calculate the offset of a weight or set of weights into the array of weights  for a given vertex, or should i be able to find this data in the model/mesh?</div><br />IIRC, same above.<br /><br /><div class="quotetitle">syphlitix wrote:</div><div class="quotecontent">And still, the queaternion bit, do they need to be calculated based on data i have collected, or should the model/mesh data contain this information alread?</div>
<br />All the bone trasformations at a given frame are accessed using the modelling package API (the same as above).
<br /><br />As you can see, whatever mesh property you want to know (vertex coordinates, texture coordinates, vertex indices, weights, animation keys, materials, etc), could be accessed through modelling package API.</div>]]></body></post><post id="p31141" date="Posted: Mon Aug 09, 2004 6:32 am "><author>Hell Byte</author><body><![CDATA[<div class="postbody">Awesome, that makes things much easier for me <img src="https://web.archive.org/web/20091206232118im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />Thanks!</div>]]></body></post><post id="p39222" date="Posted: Fri Aug 20, 2004 11:41 pm "><author>der_ton</author><body><![CDATA[<div class="postbody">It seems that the boundingbox coordinates in the md5anim are relative to the root bone's position <span style="font-weight: bold">at the first frame of the animation</span>.</div>]]></body></post><post id="p40294" date="Posted: Mon Aug 23, 2004 12:52 am "><author>Darineth Starwolf</author><body><![CDATA[<div class="postbody">With the assistance of many people on this forum's knowledge that has been posted, I have written an MD5 loader class that uses OpenGL to draw.  It was originally designed to load the V6 format, and worked great.  I've since added support for the new V10 format using the specs that are, I think, at the top of this thread, but I've encountered some unusual issues.  Basically, for a couple models I've tried to load (namely Cacodemon and Cyberdemon), I encounter very strange errors in the mesh.  Since a picture speaks a thousand words, here's the cyberdemon and his strange mesh issues:
<br /><br /><a href="https://web.archive.org/web/20091206232118/http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg" class="postlink">http://dragonhawk.dyndns.org/avalon/pics/md5-32.jpg</a>
<br /><br />You'll notice the left leg has been squashed, the right foot is messed up, and it's hard to tell from that picture, but the rocket launcher on the right arm is out of place, and looks completely wrong if you rotate the model a bit.  I was wondering if anyone else who's been playing with the new format has noticed anything like this?  I can't say I honestly understand quaternions, but using some information I've found, I was able to transform the bones' quaternion orientation data into the old bind matrix style used in the V6 format.  Anyway, thought I'd try to get a fresh perspective on this, as I've been banging my head on the wall trying to figure this out, given how inconsistant it is (I have no issues loading the Imp's mesh, but the Cacodemon's right half is skewed).</div>]]></body></post><post id="p40303" date="Posted: Mon Aug 23, 2004 1:34 am "><author>BeRSeRKeR</author><body><![CDATA[<div class="postbody">Take a look at <a href="viewtopic.php?t=2884#30185" class="postlink"><span style="font-weight: bold">this</span></a>. I think the answer of bozo could be the solution to your problem.  
<br /><br />Greets.</div>]]></body></post></posts></thread></xml>
