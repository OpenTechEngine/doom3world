<?xml version="1.0" encoding="UTF-8"?>
<xml><thread id="7750"><title>Tutorial: Real Fog without glitches and anomolies.</title><posts><post id="p66660" date="Posted: Tue Dec 07, 2004 11:58 am "><author>BloodRayne</author><body><![CDATA[<div class="postbody">It can be a pain in the ass to set up real looking fog for a level of Doom 3. Sure, we have the fog lights but they never seem to look good enough and have lots of glitches. While working on a swamp-like level for the Hexen conversion I've devised a good way for setting up fog which acts the way you expect it would act. This tutorials is not for beginners, it's an advanced method. Unfortunately I don't have much time to answer any questions that may popup but maybe other posters can chip in for me here. This is for singleplayer only!
<br /><br />The way fog works:
<br />Real fog has a visibility which is defined in an amount of meters(or miles) away from the pov. This means that if you stand on point A and you have 50 meters visibility then walk to point B you would still have 50 meters visibility. The foglights in the Doom3 engine don't have this property. They are stationary and that's where the problems begin. 
<br /><br /><span style="font-weight: bold">Doom3</span>
<br />In the Doom 3 engine you have two types of fogs, the first is a foglight and the second on is a blendlight. For this method we will be using the blendlight type because this one is easier to setup and control.
<br /><br /><span style="font-weight: bold">Skies</span>
<br />One problem with fog is that skies are allways rendered straight over everything. This means that the sky will not look 'fogged'. This means that you will have to make a new skyshader (for outdoors) that will have the same color as the fog blends to. You'll see what I mean later.
<br /><br /><span style="font-weight: bold">On to the method</span>
<br />The material:
<br />For this we first make a light which has the following shader, make *sure* that this shader has an alpha channel. I won't explain alpha channels here but there are tutorials on this board about that.
<br /><a href="https://web.archive.org/web/20080206155308/http://img71.exs.cx/my.php?loc=img71&amp;image=e7rfogtex.png" class="postlink"><img src="https://web.archive.org/web/20080206155308im_/http://img71.exs.cx/img71/4664/e7rfogtex.th.png" alt="Image" /></a>
<br /><br />Place this texture as a .tga file into your textures directory, we will make a reference to this texture from the material file below. I've named the texture fog_tex.tga. Imagine now that the players pov is where the black dot is. Inside the black dot the player can see as far as the black dot reaches. The white is what gets fogged out, you can give the fog different colors by editing this texture and giving the white part a different color. This way you can make fog in any color. I've chosen for a yellowish white in this instance. Now make a new material file called 'myfogs.mtr' inside the materials directory and copy and paste in this code:
<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fogs/real_fog<br />{<br />   noShadows<br />   blendLight<br />   {<br />      blend add<br />      map      textures/fog_tex.tga<br />      zeroclamp   // make sure it doesn't bleed over the edges<br />   }<br />}<br /></div><br /><br />You can edit the material to add animations or other shader tricks, you can even add overlapping layers but this will complicate things. You can also use this method to make rain or snow but I won't go into that now.<br /><br />Here's how to add a layer, in this instance I added a black&amp;white clouds texture. The fog now looks like it's slowly creaping upwards.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fogs/swamp_glare<br />{<br />   noShadows<br />   blendLight<br />   //lightFalloffImage   textures/fog_tex.tga<br />   <br />   {<br />      blend add<br />      map      textures/fog_tex1.tga<br />      zeroclamp   // make sure it doesn't bleed over the edges<br />      //colored      // take rgba from entity shaderparms<br />   }<br />   {<br />      blend filter<br />      map       textures/clouds.tga<br />      scroll       time * 0.02, 0<br />   }<br />}<br /></div><br /><br />The script:<br />You will have to add a script to your map to make this method work, see rich's tutorial on mapscripts to see how to set up a script. Inside this script we spawn a light and bind this light to the player.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// sets up the fog for this level<br /><br />void setup_objects()<br />{<br />      entity foglight;<br />   $foglight = sys.spawn( "light" ); <br />      $foglight.setShader( "fogs/swamp_glare" ); <br />     $foglight.setRadius( 15850 );<br />     <br />   $foglight.bindPosition( $player1 );<br />   $foglight.setOrigin( '0 0 0' ); <br />}<br /><br />// function that executes when script is loaded<br /><br />void main ()<br />{<br />   setup_objects ();<br />   sys.print( "Fog created!\n" );<br />}<br /></div>
<br /><br />Now, this is a pretty straightforward script. But there is one line that you will have to take note of:
<br />$foglight.setRadius( 15850 );
<br /><br />The radius for the light will *HAVE* to encompass the entire level at any point of the level (or the farthest that the player can see at any time in the level). So if the player is at the very edge of the level it will still have to encompass the entire map. If it does not encompass the entire map then glitches will arise and anomlies in the fog will pop up. In this instance I have a very high number: 15850 this is because my map is an outdoor map and it's pretty huge. You can adjust this number to make the fog go farther or closerby as long as it keeps encompassing the map.
<br />And that's all there is to it. The fog will behave very much like fog behaves in games such as Unreal that utilize fog.
<br /><br />Some screenshots:
<br /><br />Light fog:
<br /><a href="https://web.archive.org/web/20080206155308/http://img70.exs.cx/my.php?loc=img70&amp;image=y4oshot00064.jpg" class="postlink"><img src="https://web.archive.org/web/20080206155308im_/http://img70.exs.cx/img70/4250/y4oshot00064.th.jpg" alt="Image" /></a>
<br /><br />Heavy fog:
<br /><a href="https://web.archive.org/web/20080206155308/http://img71.exs.cx/my.php?loc=img71&amp;image=t2xshot00069.jpg" class="postlink"><img src="https://web.archive.org/web/20080206155308im_/http://img71.exs.cx/img71/466/t2xshot00069.th.jpg" alt="Image" /></a>
<br /><br /><a href="https://web.archive.org/web/20080206155308/http://img71.exs.cx/my.php?loc=img71&amp;image=n7pshot00068.jpg" class="postlink"><img src="https://web.archive.org/web/20080206155308im_/http://img71.exs.cx/img71/7622/n7pshot00068.th.jpg" alt="Image" /></a>
<br /><br /><a href="https://web.archive.org/web/20080206155308/http://img71.exs.cx/my.php?loc=img71&amp;image=a0pshot00067.jpg" class="postlink"><img src="https://web.archive.org/web/20080206155308im_/http://img71.exs.cx/img71/5552/a0pshot00067.th.jpg" alt="Image" /></a>
<br /><br />EDIT:
<br />Changes bind() to bindPosition() command in the script.</div>]]></body></post><post id="p66663" date="Posted: Tue Dec 07, 2004 12:31 pm "><author>BloodRayne</author><body><![CDATA[<div class="postbody">I thought I started this in the level_editing section but that damned hack sent me back and forth to that other forum so it ended up here.  <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_mad.gif" alt=":x" title="Mad" /><img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_evil.gif" alt=":evil:" title="Evil or Very Mad" /><img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_mad.gif" alt=":x" title="Mad" /><br /><br />Can anybody move this to the appropriate forum?
<br /><br />Thanks.
<br /><br /><span style="font-weight: bold">[EDIT]done didley do diddly sorted &gt;kat&lt;</span></div>]]></body></post><post id="p66672" date="Posted: Tue Dec 07, 2004 2:09 pm "><author>kat</author><body><![CDATA[<div class="postbody">You are seriously working your ass of for this project..!!
<br /><br />Is that lamp casting light/shadows like that cubemap demo der_ton did a while back, you know where the corner supports are, are they casting shadows?</div>]]></body></post><post id="p66674" date="Posted: Tue Dec 07, 2004 2:13 pm "><author>BloodRayne</author><body><![CDATA[<div class="postbody">Yup, those cast shadows. But I am trying to make lights cast as little shadows as possible without losing effect.</div>]]></body></post><post id="p66709" date="Posted: Tue Dec 07, 2004 8:37 pm "><author>m!chi:be</author><body><![CDATA[<div class="postbody">very cool stuff.
<br />i had my hands on the same stuff some time ago for our mod with a different aproach to the problem and failed. 
<br />will insert the new fog tomorrow into the maps.</div>]]></body></post><post id="p66720" date="Posted: Wed Dec 08, 2004 12:53 am "><author>Darkspiral</author><body><![CDATA[<div class="postbody">Hrm...  I can't seem to get this to work.  I have it so that the fog_tex appears in the lights section in edit, but its completely black and when I run the game everything is pitch black and I can't even see my own hand in front of my face.  I think the problem is that when I go to save the texture as a .tga, it wont let me check the box that says, "alpha channels".  I did make the layer into an alpha channel, so I have no idea why the hell it won't let me save it as one...  Anyone know a workaround to this?  I use PS 7.0 btw.</div>]]></body></post><post id="p66721" date="Posted: Wed Dec 08, 2004 1:14 am "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Goto adobe.com and download the updated TGA export plugin. The one that comes with PS 7.0 cannot export targas with alpha channels.</div>]]></body></post><post id="p66725" date="Posted: Wed Dec 08, 2004 2:41 am "><author>Darkspiral</author><body><![CDATA[<div class="postbody">Thanks for the info Rich...  I downloaded the plugin and I remade the textures and got rid of the old ones, but I'm still getting pitch black...  I can't figure this out.  Am I supposed to make a diffusemap as well as the alpha?  There's a texture spot for the light in the lights section, but it doesn't show me a picture of what the fog should look like, so I'm assuming I should make another texture with _ed at the end of it..  I don't know...   <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_confused.gif" alt=":?" title="Confused" />   I hate to be annoying but this is bugging me.</div>]]></body></post><post id="p66782" date="Posted: Wed Dec 08, 2004 3:56 pm "><author>rich_is_bored</author><body><![CDATA[<div class="postbody">Are you saving the targa as 32 bit?
<br /><br />Each channel should be 8 bits. A targa without an alpha channel would be 24 bit (r,g,b). A targa with an alpha channel would be 32 bit (r,g,b,a).</div>]]></body></post><post id="p66861" date="Posted: Wed Dec 08, 2004 9:36 pm "><author>Darkspiral</author><body><![CDATA[<div class="postbody">Yeah I'm saving it as 32 bit, I made sure to do that.  I saved both the scrolling clouds texture and the initial fog both as 32 bit.</div>]]></body></post><post id="p66866" date="Posted: Wed Dec 08, 2004 9:55 pm "><author>BloodRayne</author><body><![CDATA[<div class="postbody">You should break up the problem. First get the fog to work (don't use the added cloud material) and then when that works use the cloud material.
<br /><br />I won't be having much time but maybe you can put the stuff you have online in a zip so we can download it and see what the problem is.</div>]]></body></post><post id="p146738" date="Posted: Wed Jun 21, 2006 11:12 am "><author>irishlostboy1980</author><body><![CDATA[<div class="postbody">i have the fog working, just like you have said here, i have the scrolling cloud effect working fine. i even have matching skybox, which looks just fine. 
<br />one problem though. i get verticle stripes on any walls etc. i think its the cloud texture. it seems to project the "cloudy" look vertically, but not horizontally. so what you get is the edge of the scrolling texture meeting the walls, leaving a streaked effect. 
<br /><br />is there any way to fix this problem? or is it a side effect that must be lived with when it comes to applieng textures to lights?</div>]]></body></post><post id="p146747" date="Posted: Wed Jun 21, 2006 1:37 pm "><author>BloodRayne</author><body><![CDATA[<div class="postbody"><div class="quotetitle">irishlostboy1980 wrote:</div><div class="quotecontent">i have the fog working, just like you have said here, i have the scrolling cloud effect working fine. i even have matching skybox, which looks just fine. <br />one problem though. i get verticle stripes on any walls etc. i think its the cloud texture. it seems to project the "cloudy" look vertically, but not horizontally. so what you get is the edge of the scrolling texture meeting the walls, leaving a streaked effect. <br /><br />is there any way to fix this problem? or is it a side effect that must be lived with when it comes to applieng textures to lights?</div>
<br />Woahh.. necro alert! (joke) <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_razz.gif" alt=":P" title="Razz" /><br /><br />Why don't you try rotating the texture 90 degrees? You can even do that simply in the shader definition.</div>]]></body></post><post id="p146976" date="Posted: Fri Jun 23, 2006 12:30 pm "><author>irishlostboy1980</author><body><![CDATA[<div class="postbody">necro alert??? <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" /><br /><br />call me slow, but i dont get it? oh well. 
<br />i will give rotating the texture a go. is there no way to project the texture out in multiple directions? 
<br />thanks for the help <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p146984" date="Posted: Fri Jun 23, 2006 1:32 pm "><author>voldemort</author><body><![CDATA[<div class="postbody">if your having problems with the rotation  if I recal its in decimal not 360 value so .5 would equal 90 degreee turn***edit**oops poor math it equalas 180 degrees***
<br /><br />Going off memory since IM at work may be wrong but that does seem to click in my head etiher that or that clicking sound is something broken up there again</div>]]></body></post><post id="p147075" date="Posted: Sat Jun 24, 2006 6:36 am "><author>BloodRayne</author><body><![CDATA[<div class="postbody"><div class="quotetitle">irishlostboy1980 wrote:</div><div class="quotecontent">necro alert??? <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" /><br /><br />call me slow, but i dont get it? oh well. </div>
<br />It's a forum term, ressurecting or replying to an old thread is often referred to as 'necroing', from the word 'necrophelia'.  <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /></div>]]></body></post><post id="p147238" date="Posted: Sun Jun 25, 2006 2:03 pm "><author>irishlostboy1980</author><body><![CDATA[<div class="postbody">[quote="BloodRayne"][quote="irishlostboy1980"]necro alert??? <img src="https://web.archive.org/web/20080206155308im_/http://www.doom3world.org/phpbb2/images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" /><br /><br />ah. i get it now. guess you can tell i dont get to spend much time online.</div>]]></body></post></posts></thread></xml>
