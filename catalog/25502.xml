<?xml version="1.0" encoding="UTF-8"?>
<xml><thread id="25502"><title>Quick fix to speed up D3 Renderer</title><posts><post id="p242315" date="Posted: Wed Sep 05, 2012 8:18 am "><author>reckless</author><body><![CDATA[<div class="postbody">ok loads now and at first it looked ok but then i got "Surface Interactions not allocated" and things started to look really weird.</div>]]></body></post><post id="p242317" date="Posted: Wed Sep 05, 2012 9:25 am "><author>reckless</author><body><![CDATA[<div class="postbody">Getting there but still a few bumps to iron out it seems.<br /><br />With the missing function implemented it loads without problems but light seems to have trouble updating causing some odd effects.<br /><br />If you turn off your flashlight the world goes completely dark.<br />Light only affects things in front of the player everything else is dark with big blocky shadows.<br /><br />besides that it seems to react a good deal faster so its definatly worth getting it fixed <img src="https://web.archive.org/web/20130319220438im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p238933" date="Posted: Thu May 10, 2012 10:56 am "><author>jmarshall23</author><body><![CDATA[<div class="postbody">Hey,<br /><br />I'm putting this in this forum cause not too many people check the doom 3 code section and that forum doesn't populate on the main page. While working on idTech 4 CDK my 12k weapon model mesh and 22k level was slowing shit down considerably. Well while tracing down a memory leak I found out that the Doom 3 renderer allocates and frees memory each frame for each number of meshes you have in your scene. After applying this fix I get a constant 10-15fps increase, in stock d3 you'll probably get more.<br /><br />Open Interaction.cpp and find <br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">//<br />// create slots for each of the model's surfaces<br />//<br />numSurfaces = model-&gt;NumSurfaces();<br /></div><br /><br />There is a r_staticalloc or something similar right below that line replace it with:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">//<br />// create slots for each of the model's surfaces<br />//<br />numSurfaces = model-&gt;NumSurfaces();<br />surfaces = (surfaceInteraction_t *)model-&gt;GetSurfaceInteractions(); <br />memset(&amp;surfaces[0], 0, sizeof(surfaceInteraction_t) * model-&gt;NumSurfaces());<br /></div><br /><br />Find the freesurfaces function in the interaction.cpp and comment out R_StaticFree( this-&gt;surfaces );<br /><br />In model.h in the "class idRenderModel" add <br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// Gets the surface interactions <br />virtual const surfaceInteraction_t *GetSurfaceInteractions( void ) const = 0;<br /></div><br /><br />In model_local.h in the idRenderModelStatic class add <br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">virtual const surfaceInteraction_t *GetSurfaceInteractions( void ) const;<br />idList&lt;surfaceInteraction_t&gt; interaction;<br /></div><br /><br />In model.cpp find the function<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void idRenderModelStatic::AddSurface( modelSurface_t surface )<br /></div><br /><br />At the end of the function add:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// jmarshall<br />interaction.Alloc();<br />// jmarshall end<br /></div><br /><br />In Model_md5.cpp find the function idRenderModelMD5::InstantiateDynamicModel and find<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">// Remove Overlays before adding new surfaces<br />idRenderModelOverlay::RemoveOverlaySurfacesFromModel( staticModel );<br /></div><br /><br />Under that line add:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">staticModel-&gt;interaction.Alloc();<br /></div><br /><br />Go back to model.cpp and in purgemodel function add<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">interaction.Clear();<br /></div><br /><br />Done.</div>]]></body></post><post id="p238938" date="Posted: Thu May 10, 2012 2:24 pm "><author>Sikkpin</author><body><![CDATA[<div class="postbody">Looks like "GetSurfaceInteractions()" needs to be defined.</div>]]></body></post><post id="p238941" date="Posted: Thu May 10, 2012 3:07 pm "><author>Serpentine</author><body><![CDATA[<div class="postbody">Pretty sure you'll get the same increase and drop some overhead if you just fix the InteractionTable (even just using a large fixed size like 4096*4096*sizeof(idInteraction)), or shifting it later in the load process to get a better number of lights/entities... or by making the resize function not destroy the table.<br /><br />Might also want to enable r_useIndexBuffers, since that seems to help a little more.</div>]]></body></post><post id="p239031" date="Posted: Mon May 14, 2012 8:39 pm "><author>VGames</author><body><![CDATA[<div class="postbody">Would this help to render Sikkmod features such as Soft Shadows without bogging the game down?</div>]]></body></post><post id="p239541" date="Posted: Mon Jun 04, 2012 6:00 pm "><author>VGames</author><body><![CDATA[<div class="postbody">Is it worth doing this trick and what does it help do exactly?</div>]]></body></post><post id="p239553" date="Posted: Tue Jun 05, 2012 5:30 am "><author>nbohr1more</author><body><![CDATA[<div class="postbody">This trick reduces CPU overhead and RAM waste (not video RAM). Yes, since Sikkmod's current soft-shadow method requires redrawing the scene it should speed that up a bit on CPU limited systems. On GPU limited systems it may not have much effect.</div>]]></body></post><post id="p239555" date="Posted: Tue Jun 05, 2012 6:46 am "><author>Gir</author><body><![CDATA[<div class="postbody">I downloaded the GPL to add this Fix.<br /><br /> i downloaded Visual Studios 11, Direct X SDK, but i get this compile error.  ?<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">1&gt;  ChoiceWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  DeviceContext.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  EditWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  FieldWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  GameBearShootWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  GameBustOutWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  GameSSDWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  GuiScript.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  ListGUI.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  ListWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  MarkerWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  RegExp.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  RenderWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  SimpleWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  SliderWindow.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  UserInterface.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  Window.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  Generating Code...<br />1&gt;  Compiling...<br />1&gt;  Winvar.cpp<br />1&gt;c:\users\miles\desktop\doom iii\ttimo-doom3.gpl-8047099\neo\idlib\../tools/comafx/StdAfx.h(38): fatal error C1083: Cannot open include file: 'afxwin.h': No such file or directory<br />1&gt;  Generating Code...<br />1&gt;<br />1&gt;Build FAILED.<br />1&gt;<br />1&gt;Time Elapsed 00:00:09.05<br />========== Build: 0 succeeded, 1 failed, 0 up-to-date, 0 skipped ==========<br /></div></div>]]></body></post><post id="p239557" date="Posted: Tue Jun 05, 2012 6:55 am "><author>jmarshall23</author><body><![CDATA[<div class="postbody">I haven't tried tried compiling with VS 2011, those errors means the compiler isn't loading in the MFC headers(i.e. the tools).<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Is it worth doing this trick and what does it help do exactly?<br /></div><br /><br />This is a CPU only time savior, and actually after applying this fix you will see a minor ram usage increase. Were this fix really comes in handy is if you are using assets that have a med/high vertex count. Even the old stock d3 assets will also render fast(er) after applying this fix, allocating/freeing that much memory is very CPU intensive and also creates fragmentation in aval memory.</div>]]></body></post><post id="p239558" date="Posted: Tue Jun 05, 2012 7:39 am "><author>Gir</author><body><![CDATA[<div class="postbody">I can't compile, someone release a binary with fix</div>]]></body></post><post id="p239559" date="Posted: Tue Jun 05, 2012 7:39 am "><author>Gzegzolka</author><body><![CDATA[<div class="postbody">Shouldn't this topic be in Doom3 source code forum folder? Those stuff can be done in cpp files while D3 vanilla got different stuff in pk4.</div>]]></body></post><post id="p239560" date="Posted: Tue Jun 05, 2012 7:41 am "><author>jmarshall23</author><body><![CDATA[<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Shouldn't this topic be in Doom3 source code forum folder? Those stuff can be done in cpp files while D3 vanilla got different stuff in pk4.<br /></div><br /><br />I think your referring to either the script stuff or the game dll which would both be incorrect. It should be probably but I posted it here for more exposure becuase not really many people  check that forum and the google crawler doesn't crawl that forum.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I can't compile, someone release a binary with fix<br /></div><br /><br />Download VS2010 trial apply the fix and recompile.</div>]]></body></post><post id="p239562" date="Posted: Tue Jun 05, 2012 9:14 am "><author>Gir</author><body><![CDATA[<div class="postbody">I downloaded VS2010 Pro, and i get this error<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent"><br />1&gt;sound\snd_system.cpp(167): error C2664: 'ALenum (ALubyte *)' : cannot convert parameter 1 from 'const char [16]' to 'ALubyte *'<br />1&gt;          Types pointed to are unrelated; conversion requires reinterpret_cast, C-style cast or function-style cast<br />1&gt;sound\snd_system.cpp(167): error C2664: 'ALenum (ALubyte *)' : cannot convert parameter 1 from 'const char [16]' to 'ALubyte *'<br />1&gt;          Types pointed to are unrelated; conversion requires reinterpret_cast, C-style cast or function-style cast<br />1&gt;<br />1&gt;Build FAILED.<br />1&gt;<br />1&gt;Time Elapsed 00:00:03.56<br />========== Build: 0 succeeded, 1 failed, 0 up-to-date, 0 skipped ==========<br /><br /></div></div>]]></body></post><post id="p239563" date="Posted: Tue Jun 05, 2012 9:16 am "><author>Gir</author><body><![CDATA[<div class="postbody">I fixed by doing this<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">//#if ID_OPENAL<br />//   common-&gt;Printf( "%8d kB total OpenAL audio memory used\n", ( alGetInteger( alGetEnumValue( "AL_EAX_RAM_SIZE" ) ) - alGetInteger( alGetEnumValue( "AL_EAX_RAM_FREE" ) ) ) &gt;&gt; 10 );<br />//#endif<br /></div><br /><br />I got an EXE <img src="https://web.archive.org/web/20130319215824im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p239564" date="Posted: Tue Jun 05, 2012 10:04 am "><author>Gir</author><body><![CDATA[<div class="postbody">Just a quick off topic question<br /><br />I noticed there's "Model_md3.h" in Doom 3, can Md3 models be loaded into Doom 3 since the code is there, i tried using "test_model" in console to load an MD3 but nothing shows up.<br /><br />::edit::<br /><br />I added this, md3 works @ CmdSystem <img src="https://web.archive.org/web/20130319215824im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" />  [ ".md3"]<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">ID_INLINE void idCmdSystem::ArgCompletion_ModelName( const idCmdArgs &amp;args, void(*callback)( const char *s ) ) {<br />   cmdSystem-&gt;ArgCompletion_FolderExtension( args, callback, "models/", false, ".lwo", ".ase", ".md5mesh",".md3", ".ma", NULL );<br />}<br /></div></div>]]></body></post><post id="p239567" date="Posted: Tue Jun 05, 2012 1:24 pm "><author>Tron</author><body><![CDATA[<div class="postbody">How about a nice timedemo comparison? <img src="https://web.archive.org/web/20130319215824im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p239568" date="Posted: Tue Jun 05, 2012 1:41 pm "><author>Gzegzolka</author><body><![CDATA[<div class="postbody"><div class="quotetitle">jmarshall23 wrote:</div><div class="quotecontent"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Shouldn't this topic be in Doom3 source code forum folder? Those stuff can be done in cpp files while D3 vanilla got different stuff in pk4.<br /></div><br /><br />I think your referring to either the script stuff or the game dll which would both be incorrect. It should be probably but I posted it here for more exposure becuase not really many people  check that forum and the google crawler doesn't crawl that forum.<br /></div><br /><br />OK, and is there way to actually put that in D3 vanilla?</div>]]></body></post><post id="p239571" date="Posted: Tue Jun 05, 2012 3:01 pm "><author>jmarshall23</author><body><![CDATA[<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">OK, and is there way to actually put that in D3 vanilla?<br /></div><br /><br />This works in d3 vanilla you just need to recompile the d3 exe from the gpl code base.</div>]]></body></post><post id="p239575" date="Posted: Tue Jun 05, 2012 3:55 pm "><author>Serpentine</author><body><![CDATA[<div class="postbody">You get a nice little bump in performance from the VS 11 / VS 2012 RC compiler, only 2-3 fps, and no XP bins... but hey.<br /><br />The VS 2012 RC is also a whole lot more usable than the 11 beta too.</div>]]></body></post><post id="p239578" date="Posted: Tue Jun 05, 2012 5:08 pm "><author>simulation</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Serpentine wrote:</div><div class="quotecontent">You get a nice little bump in performance from the VS 11 / VS 2012 RC compiler, only 2-3 fps, and no XP bins... but hey.<br /><br />The VS 2012 RC is also a whole lot more usable than the 11 beta too.</div><br />VS2012 will support XP as a target as a post-RTM patch. I'll be keeping away from VS2012 due to the .NET 4.5 release being an in-place upgrade. Wouldn't be so bad but 4.5 will not be on XP or Server 2K3, so that rules it out for many enterprise developers like me.</div>]]></body></post><post id="p240506" date="Posted: Thu Jul 05, 2012 7:57 pm "><author>motorsep</author><body><![CDATA[<div class="postbody"><div class="quotetitle">Gir wrote:</div><div class="quotecontent">Just a quick off topic question<br /><br />I noticed there's "Model_md3.h" in Doom 3, can Md3 models be loaded into Doom 3 since the code is there, i tried using "test_model" in console to load an MD3 but nothing shows up.<br /><br />::edit::<br /><br />I added this, md3 works @ CmdSystem <img src="https://web.archive.org/web/20130319215824im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" />  [ ".md3"]<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">ID_INLINE void idCmdSystem::ArgCompletion_ModelName( const idCmdArgs &amp;args, void(*callback)( const char *s ) ) {<br />   cmdSystem-&gt;ArgCompletion_FolderExtension( args, callback, "models/", false, ".lwo", ".ase", ".md5mesh",".md3", ".ma", NULL );<br />}<br /></div></div><br /><br />Will animated md3 model work with this patch ?</div>]]></body></post><post id="p240508" date="Posted: Fri Jul 06, 2012 11:03 am "><author>Tom Yum 72</author><body><![CDATA[<div class="postbody">@ jmarshall23 and everybody else : <br /><br />would you or someone else here be so kind and post a ready to go patch here, because i have absolutely no clue how to to this.<br />Big thanks !</div>]]></body></post><post id="p241291" date="Posted: Sat Aug 04, 2012 11:20 pm "><author>motorsep</author><body><![CDATA[<div class="postbody">Ok, trying to get it working and keep on getting error:<br /><br />/home/user/neo/renderer/Model.h:318:16: error: ‘surfaceInteraction_t’ does not name a type<br /><br />That's the line where it errors out <div class="codetitle"><b>Code:</b></div><div class="codecontent">virtual const surfaceInteraction_t *GetSurfaceInteractions( void ) const = 0;</div> in class idRenderModel <br /><br />Any ideas? Thanks.</div>]]></body></post><post id="p241444" date="Posted: Wed Aug 08, 2012 11:56 pm "><author>VGames</author><body><![CDATA[<div class="postbody">Did anybody ever get this working?</div>]]></body></post><post id="p241445" date="Posted: Thu Aug 09, 2012 12:27 am "><author>motorsep</author><body><![CDATA[<div class="postbody">nope</div>]]></body></post><post id="p241451" date="Posted: Thu Aug 09, 2012 2:57 am "><author>reckless</author><body><![CDATA[<div class="postbody">Sadly no it seems to be missing parts.<br />I tried recreating the missing bits but im no C++ guru so i ended up with something that compiled but it crashed when executed.</div>]]></body></post><post id="p241473" date="Posted: Thu Aug 09, 2012 6:53 pm "><author>VGames</author><body><![CDATA[<div class="postbody">That sucks. Oh well thanks for trying. I didn't even do that. <img src="https://web.archive.org/web/20130319221339im_/http://www.doom3world.org/phpbb2/images/smilies/icon_razz.gif" alt=":P" title="Razz" /></div>]]></body></post><post id="p241500" date="Posted: Fri Aug 10, 2012 1:05 pm "><author>AnthonyJa</author><body><![CDATA[<div class="postbody">I've not actually got as far as running d3 with this change (don't even have d3 on this PC), much less profiled it to see if it actually has any noticable effect. However.... I do have something that I believe should have everything needed to compile it.<br /><br />Reckless - your use of "return 0" in GetSurfaceInteractions was a little, uh, reckless, and is the reason for your crash. What I believe you were looking for was "return interaction.Ptr()".<br /><br />The patch is relative to my local set of code but hopefully can be applied to other codebases without too much trouble.</div>]]></body></post><post id="p241514" date="Posted: Fri Aug 10, 2012 8:34 pm "><author>VGames</author><body><![CDATA[<div class="postbody">Anybody use this yet?</div>]]></body></post><post id="p241515" date="Posted: Fri Aug 10, 2012 8:38 pm "><author>motorsep</author><body><![CDATA[<div class="postbody">I am about to attempt it <img src="https://web.archive.org/web/20130319221339im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p241516" date="Posted: Fri Aug 10, 2012 9:42 pm "><author>VGames</author><body><![CDATA[<div class="postbody">Try using Sikkmod's soft shadow feature.</div>]]></body></post><post id="p241517" date="Posted: Fri Aug 10, 2012 9:49 pm "><author>motorsep</author><body><![CDATA[<div class="postbody">I am not after soft shadows, so I won't be trying it <img src="https://web.archive.org/web/20130319221339im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p241518" date="Posted: Fri Aug 10, 2012 10:03 pm "><author>motorsep</author><body><![CDATA[<div class="postbody"><div class="quotetitle">AnthonyJa wrote:</div><div class="quotecontent">I've not actually got as far as running d3 with this change (don't even have d3 on this PC), much less profiled it to see if it actually has any noticable effect. However.... I do have something that I believe should have everything needed to compile it.<br /><br />Reckless - your use of "return 0" in GetSurfaceInteractions was a little, uh, reckless, and is the reason for your crash. What I believe you were looking for was "return interaction.Ptr()".<br /><br />The patch is relative to my local set of code but hopefully can be applied to other codebases without too much trouble.</div><br /><br />Had to comment out shadowGen = SG_STATIC; in the Interaction.cpp to get it to compile. Besides that the engine compiles.<br /><br />Well, the patch crashes Doom 3 (dhewm3 engine) when I start new game, and if I load testmaps/test_vehicle2 I see this: <!-- m --><a class="postlink" href="https://web.archive.org/web/20130319221339/http://i.imgur.com/YZ8vm.jpg">http://i.imgur.com/YZ8vm.jpg</a><!-- m --><br /><br />Maybe it has something to do with shadowGen = SG_STATIC; but the patch wouldn't compile with that line.</div>]]></body></post><post id="p241520" date="Posted: Fri Aug 10, 2012 11:20 pm "><author>AnthonyJa</author><body><![CDATA[<div class="postbody">Odd, the patch shouldn't contain any change to a line like that...<br /><br />Compare the patch to the first post and you should find that the only real differences are:<br />- GetSurfaceInteractions is implemented (as returning the newly added interactions variable)<br />- added an AllocInteraction method instead of requiring that interaction is a public variable<br />- changed the type definition of the surfaceInteraction_t struct and pre-declared it so that it could be used on the public interface<br /><br />One thing worth checking (I cannot right now as cannot open my .zip from iPhone / iPad!) is that I remembered to disable the line Justin mentioned to comment out. Think I did but not certain as that was the bit that made me add an ifdef around it all and I may have forgotten to go back and do that one.<br /><br />Try applying it to an engine that has less renderer changes, this change could conflict with other changes already in that fork.<br /><br />Or just debug into the crash - surely if you are making a commercial game you have<br />A developer who knows how to use a debugger?</div>]]></body></post><post id="p241521" date="Posted: Fri Aug 10, 2012 11:28 pm "><author>motorsep</author><body><![CDATA[<div class="postbody">dhewm3 doesn't have any render changes. It still runs ARB2 path. The only thing we changed was adding depth buffer access, which should not interfere in any way with this patch.<br /><br />Although I am not a programmer, I know how to use gdb debugger <img src="https://web.archive.org/web/20130319221339im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /> Will l look into it in a bit.<br /><br />Note that I didn't see any fps increase on the test_vehicle2 map.</div>]]></body></post><post id="p241522" date="Posted: Fri Aug 10, 2012 11:42 pm "><author>AnthonyJa</author><body><![CDATA[<div class="postbody">The first thing to do is definitely to compare the changes against my list above and the original post. The line you are saying needs to be commented out should be completely unaffected. <br /><br />Probably automatically applying the patch has gone wrong because your codebase is different to mine, probably because of changes in interaction.cpp made on the dhewm3 fork (by renderer I was referring to the module within the code, which both this patch and dhewm3 have changed)<br /><br />Can't say I have tried test_vehicle2 but I guess it is just a big box and so probably would t benefit from this change anyway. Try high poly count maps and models</div>]]></body></post><post id="p241524" date="Posted: Sat Aug 11, 2012 12:55 am "><author>motorsep</author><body><![CDATA[<div class="postbody">Ok, I re-enabled shadowGen = SG_STATIC; and commented out R_StaticFree( this-&gt;surfaces ); per jmarshall23 (which doesn't affect anything btw). And here we go:<br /><br />/home/motorsep/games/steelstorm2_engine/neo/renderer/Interaction.cpp: In member function ‘void idInteraction::FreeSurfaces()’:<br />/home/motorsep/games/steelstorm2_engine/neo/renderer/Interaction.cpp:551:2: error: ‘shadowGen’ was not declared in this scope<br />make[2]: *** [CMakeFiles/SteelStorm2.dir/renderer/Interaction.cpp.o] Error 1<br />make[2]: *** Waiting for unfinished jobs....<br />make[1]: *** [CMakeFiles/SteelStorm2.dir/all] Error 2<br />make: *** [all] Error 2</div>]]></body></post><post id="p241527" date="Posted: Sat Aug 11, 2012 6:01 am "><author>reckless</author><body><![CDATA[<div class="postbody">Thanks gonna try it <img src="https://web.archive.org/web/20130319221339im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> only reason i had a return 0; in there was because i was not sure what to return still learning C++ <img src="https://web.archive.org/web/20130319221339im_/http://www.doom3world.org/phpbb2/images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>]]></body></post><post id="p241529" date="Posted: Sat Aug 11, 2012 7:31 am "><author>reckless</author><body><![CDATA[<div class="postbody">Ok applied and better but still crashing even on unmodified doom3.<br />Crashes in memset(&amp;surfaces[0], 0, sizeof(surfaceInteraction_t) * model-&gt;NumSurfaces()); with a NULL pointer to surfaces.<br />I can get it far enough to load a map but as soon as it finishes loading it will bail out with the above.</div>]]></body></post><post id="p241530" date="Posted: Sat Aug 11, 2012 7:51 am "><author>motorsep</author><body><![CDATA[<div class="postbody">I bet I am having the same issue as reckless, but I can't compile with shadowGen = SG_STATIC; <br /><br />Care you elaborate why is it happening to me?</div>]]></body></post><post id="p241540" date="Posted: Sat Aug 11, 2012 1:41 pm "><author>reckless</author><body><![CDATA[<div class="postbody">Might need to check by hand if the patch applied cleanly.<br />Check for missing ; at the end of function variables like this-&gt;somefunction; <br />Can also be caused by misplaced defines like #define something without an #endif</div>]]></body></post><post id="p241542" date="Posted: Sat Aug 11, 2012 2:15 pm "><author>AnthonyJa</author><body><![CDATA[<div class="postbody"><div class="quotetitle">reckless wrote:</div><div class="quotecontent">Ok applied and better but still crashing even on unmodified doom3.<br />Crashes in memset(&amp;surfaces[0], 0, sizeof(surfaceInteraction_t) * model-&gt;NumSurfaces()); with a NULL pointer to surfaces.<br />I can get it far enough to load a map but as soon as it finishes loading it will bail out with the above.</div><br /><br />Hm shouldn't be null as it is being returned as interaction.ptr. Perhaps check with the debugger whether that list is empty, and what the value of NumSurfaces is (should presumably be equal go thr list length).<br /><br />Also make sure you did the "comment out this line" as it sounds like I missed that out. That probably wouldn't cause it to be null but would cause it to be using a stale pointer which could av</div>]]></body></post><post id="p241544" date="Posted: Sat Aug 11, 2012 5:44 pm "><author>motorsep</author><body><![CDATA[<div class="postbody">I checked and rechecked <img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /> I also applied patch manually, line by line.</div>]]></body></post><post id="p241545" date="Posted: Sat Aug 11, 2012 6:19 pm "><author>reckless</author><body><![CDATA[<div class="postbody">Aye did comment the mentioned line out but to no avail :/ <br /><br />i get an awfull heap of pointers with the value ??? from the debugger.<br />But it cannot point me to the direct cause why. <br />I had the same problem many times when working on Quake1 and the debugger is correct it is a bad pointer somewhere but the msvc debugger had some trouble telling me where so i had to sift through the entire codebase to find the cullprit. Turned out to be an old bug in the quake1 code which manifested itself with some of my modifications :S.</div>]]></body></post><post id="p241727" date="Posted: Tue Aug 14, 2012 3:02 pm "><author>reckless</author><body><![CDATA[<div class="postbody">Lots of debugging later ... its an allocation error. <br />Looks like interaction.Alloc(); is sometimes throwing a NULL pointer my best guess is that theres still something missing.<br />I can get it to work by using the old staticalloc but that kinda breaks the purpose :S.<br /><br />So needs more bugtesting im afraid.</div>]]></body></post><post id="p241730" date="Posted: Tue Aug 14, 2012 3:52 pm "><author>VGames</author><body><![CDATA[<div class="postbody">Keep us updated. Can we expect an increase in FPS while using Sikkmod features like Soft Shadows?</div>]]></body></post><post id="p241746" date="Posted: Tue Aug 14, 2012 8:07 pm "><author>reckless</author><body><![CDATA[<div class="postbody">Not sure tbh. Ive not delved to deeply into how sikks soft shadows work but everything that amounts to a speedup will help in the long run <img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p242003" date="Posted: Thu Aug 23, 2012 1:36 am "><author>AnthonyJa</author><body><![CDATA[<div class="postbody"><div class="quotetitle">reckless wrote:</div><div class="quotecontent">Ok applied and better but still crashing even on unmodified doom3.<br />Crashes in memset(&amp;surfaces[0], 0, sizeof(surfaceInteraction_t) * model-&gt;NumSurfaces()); with a NULL pointer to surfaces.<br />I can get it far enough to load a map but as soon as it finishes loading it will bail out with the above.</div><br /><br />Looks like Justin had probably already removed some other places that add surfaces that aren't using AddSurface (that line has an implicit assumption that surfaces.Count &lt;= interaction.Count). You need additional blocks of code like this (when using my version of the patch, otherwise use "staticModel-&gt;interaction.Alloc()"):<br /><br />#ifdef USE_JUSTINS_SURFACES_OPT<br />			staticModel-&gt;AllocInteraction();<br />#endif<br /><br />They need to go into anywhere that is doing surfaces.Alloc() - which appears to be idRenderModelPrt::InstantiateDynamicModel and idRenderModelOverlay::AddOverlaySurfacesToModel(). <br /><br />Having done this, it doesn't crash for me (on one test map, so not lots of testing), however I'm not seeing a big speedup for me. Probably not bottlenecking there on this PC as it has other issues...</div>]]></body></post><post id="p242007" date="Posted: Thu Aug 23, 2012 3:03 am "><author>reckless</author><body><![CDATA[<div class="postbody">Hmm sounds plausible &lt;Mythbuster voice&gt; <img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_razz.gif" alt=":P" title="Razz" /><br /><br />Ill take some test runs <img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p242008" date="Posted: Thu Aug 23, 2012 4:19 am "><author>reckless</author><body><![CDATA[<div class="postbody">Hmm ouch :S while the first version crashed on map load this one crashes instantly.<br /><br />Mh at inside3d had some thoughts about speeding the engine up seriously but its a big undertakement that will require most of the vertex cache to be rewritten.</div>]]></body></post><post id="p242010" date="Posted: Thu Aug 23, 2012 7:31 am "><author>AnthonyJa</author><body><![CDATA[<div class="postbody">It really shouldn't be any worse than the last one, since it is exactly the same except for some more cases are handled where the interaction list is too small. Inspect the size of it and compare it to the number of surfaces, and also check the type of model.<br /><br />Temporarily make surfaces private to see if you have any other examples where something does surfaces.Alloc which doesn't now Alloc an interaction (that is how I found those two new ones)</div>]]></body></post><post id="p242011" date="Posted: Thu Aug 23, 2012 8:42 am "><author>reckless</author><body><![CDATA[<div class="postbody">Aye checked the occurances and found only the two you listed but something is still amiss :/ <br />Im putting it on the backburner for now while i work on integrating xreals renderer in doom3.</div>]]></body></post><post id="p242066" date="Posted: Mon Aug 27, 2012 12:54 am "><author>motorsep</author><body><![CDATA[<div class="postbody">Finally tested MD3 models in Doom 3. Models can be loaded, but can not be used with idAnimated. A code needs to be written to trigger and play animated MD3 files using idAnimated.</div>]]></body></post><post id="p242293" date="Posted: Tue Sep 04, 2012 11:20 am "><author>reckless</author><body><![CDATA[<div class="postbody">Noticed jmarshall was back so maybe he can fill in on what may be wrong ?.<br /><br />Btw i posted some optimized VBO code in the code section it has been tested on both ATI and Nvidia and provides a nice speedup.<br /><br />The version i posted are for engines that have the old backend functions removed but should be easy to revert the missing functions for virtualmem (Yuck).<br /><br />Its also been ported for dhewm3 <img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post><post id="p242303" date="Posted: Wed Sep 05, 2012 6:46 am "><author>jmarshall23</author><body><![CDATA[<div class="postbody">Can you guys quickly rehash what problems you guys are having?</div>]]></body></post><post id="p242306" date="Posted: Wed Sep 05, 2012 7:31 am "><author>reckless</author><body><![CDATA[<div class="postbody">We had a few cases of missing function pointers (most got found out so now it compiles) but it crashes with a null pointer error so we been stuck ever since <img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" />.</div>]]></body></post><post id="p242308" date="Posted: Wed Sep 05, 2012 7:36 am "><author>jmarshall23</author><body><![CDATA[<div class="postbody">Where are you guys getting the null pointer issue?</div>]]></body></post><post id="p242309" date="Posted: Wed Sep 05, 2012 7:40 am "><author>reckless</author><body><![CDATA[<div class="postbody">this part -&gt;<br /><br />//<br />// create slots for each of the model's surfaces<br />//<br />numSurfaces = model-&gt;NumSurfaces();<br />surfaces = (surfaceInteraction_t *)model-&gt;GetSurfaceInteractions(); // explodes here with null pointer error <br />memset(&amp;surfaces[0], 0, sizeof(surfaceInteraction_t) * model-&gt;NumSurfaces());<br /><br />the weird thing is that it should work with the patches posted but somethings amiss.</div>]]></body></post><post id="p242311" date="Posted: Wed Sep 05, 2012 7:46 am "><author>jmarshall23</author><body><![CDATA[<div class="postbody">Opps I forgot to define GetSurfaceInteractions, sorry about that:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">/*<br />================<br />idRenderModelStatic::GetSurfaceInteractions<br />================<br />*/<br />const surfaceInteraction_t *idRenderModelStatic::GetSurfaceInteractions( void )  const {<br />   // I'm spitting out a warning here cause this shouldn't happen(but it is).<br />   if(interaction.Num() &lt;= 0) {<br />      common-&gt;Warning("Surface Interactions not allocated - creating %d\n", NumSurfaces() );<br />      for(int i = 0; i &lt; NumSurfaces(); i++)<br />      {<br />         ((idRenderModelStatic *)this)-&gt;interaction.Alloc();<br />      }<br />   }<br />   return &amp;interaction[0];<br />}<br /></div><br /><br />Try that and see if it works.</div>]]></body></post><post id="p242313" date="Posted: Wed Sep 05, 2012 7:48 am "><author>reckless</author><body><![CDATA[<div class="postbody">These are the two missing functions AnthonJa found.<br /><br /> /*<br />================<br />idRenderModelStatic::GetSurfaceInteractions<br />================<br />*/<br />const surfaceInteraction_s *idRenderModelStatic::GetSurfaceInteractions( void ) const<br />{<br />	return interaction.Ptr();<br />}<br /><br />/*<br />================<br />idRenderModelStatic::AllocInteraction<br />================<br />*/<br />void idRenderModelStatic::AllocInteraction( void )<br />{<br />	interaction.Alloc();<br />}<br /><br />GetSurfaceInteractions returns the ptr to the interaction table but for some odd reason it also passes empty data as a null pointer and msvc is all but happy about it doing that :S</div>]]></body></post><post id="p242314" date="Posted: Wed Sep 05, 2012 7:49 am "><author>reckless</author><body><![CDATA[<div class="postbody"><img src="https://web.archive.org/web/20130319220700im_/http://www.doom3world.org/phpbb2/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  yay ok lets try again hope it works this time.</div>]]></body></post><post id="p242315" date="Posted: Wed Sep 05, 2012 8:18 am "><author>reckless</author><body><![CDATA[<div class="postbody">ok loads now and at first it looked ok but then i got "Surface Interactions not allocated" and things started to look really weird.</div>]]></body></post><post id="p242317" date="Posted: Wed Sep 05, 2012 9:25 am "><author>reckless</author><body><![CDATA[<div class="postbody">Getting there but still a few bumps to iron out it seems.<br /><br />With the missing function implemented it loads without problems but light seems to have trouble updating causing some odd effects.<br /><br />If you turn off your flashlight the world goes completely dark.<br />Light only affects things in front of the player everything else is dark with big blocky shadows.<br /><br />besides that it seems to react a good deal faster so its definatly worth getting it fixed <img src="https://web.archive.org/web/20130319220250im_/http://www.doom3world.org/phpbb2/images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>]]></body></post></posts></thread></xml>
